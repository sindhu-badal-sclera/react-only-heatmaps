var WebRTCPeerConnectionConstants={},ZCWebRTCPeerConnectionUtil={};class RTCConnectionMonitor{constructor(e,t,i,a){this._id=e,this._connection=t,this._candidates=i,this._connectionErrorCB=a,this._selectedCandidateInfo=void 0,this._isUDPBlocked=!1,this._timeout=void 0}updateCandidates(e){this._candidates.concat(e)}_setCandidatePairInfo(e){this._selectedCandidateInfo=e}_isConnectedViaTCP(){if(this._selectedCandidateInfo)return"relay"===this._selectedCandidateInfo.local_candidate_type&&this._selectedCandidateInfo.local_candidate_port<=WebRTCPeerConnectionConstants.relayUDPPort}isUDPBlocked(){return this._isUDPBlocked}start(){this._timeout=setTimeout(()=>{var e=this._connection.iceConnectionState===WebRTCPeerConnectionConstants.iceConnectionStates.CLOSED,t=this._connection.iceConnectionState===WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED;if(this._candidates&&this._connection&&!e){for(var i=!1,a=!1,n=0;n<this._candidates.length;n++){var o=this._candidates[n];if("relay"===o.type&&(i=!0,a=o.port>WebRTCPeerConnectionConstants.relayUDPPort))return}if(i&&!a){var s=function(){t&&this._selectedCandidateInfo&&"relay"!==this._selectedCandidateInfo.local_candidate_type||(this._isUDPBlocked=!0,this._connectionErrorCB(this._id,{code:WebRTCPeerConnectionConstants.connectionErrors.UDP_BLOCKING,isConnectedViaTCP:t&&this._isConnectedViaTCP()}))}.bind(this);t?WebRTCPeerConnectionStats.getSelectedCandidatePair(this._id,"ConnectionMonitor",this._connection,(e,t,i)=>{this._setCandidatePairInfo(i),s()}):s()}}},6e3)}stop(){clearTimeout(this._timeout)}}WebRTCPeerConnectionConstants={iceConnectionStates:{CONNECTED:"connected",COMPLETED:"completed",DISCONNECTED:"disconnected",FAILED:"failed",CLOSED:"closed"},connectionTypes:{AUDIO_VIDEO:"audiovideo",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",DATA_CHANNEL:"datachannel"},connectionModes:{UNIFIED:"unified",PLANB:"planB"},connectionErrors:{UDP_BLOCKING:"701"},relayUDPPort:2e4,isUnifiedPlan:function(e){return this.connectionModes.UNIFIED===e},isPlanB:function(e){return this.connectionModes.PLANB===e},isAudioConnection:function(e){return this.connectionTypes.AUDIO===e},isVideoConnection:function(e){return this.connectionTypes.VIDEO===e},isScreenConnection:function(e){return this.connectionTypes.SCREEN===e},isDataChannelConnection:function(e){return this.connectionTypes.DATA_CHANNEL===e},isConnectionActive:function(e){if(void 0===e)return!1;var t=e.iceConnectionState;return t===this.iceConnectionStates.CONNECTED||t===this.iceConnectionStates.COMPLETED},isConnectionClosed:function(e){return void 0!==e&&e.iceConnectionState===this.iceConnectionStates.CLOSED},processTypes:{INIT:"init",REINIT:"reinit",RESTART:"restart",RENEGOTIATE:"renegotiate"},isInit:function(e){return this.processTypes.INIT===e},isRestart:function(e){return this.processTypes.RESTART===e},isReInit:function(e){return this.processTypes.REINIT===e},isRenegotiate:function(e){return this.processTypes.RENEGOTIATE===e}};ZCWebRTCPeerConnectionUtil={replaceStereoValuesInSdp:function(e){e.sdp=e.sdp.replaceAll("useinbandfec=1","useinbandfec=1;stereo=1;sprop-stereo=1;maxaveragebitrate=128000")},getRTPSenderOrReceiverForTrack:function(e=[],t){if(t)for(var i=0;i<e.length;i++){var a=e[i];if(a.track&&a.track.id===t.id)return a}},getConfiguration:function(e){var t={iceServers:e};return WebRTCUserMedia.isIcePrebindingSupported()&&"undefined"!=typeof Conference&&Conference.isIcePrebindingEnabled()&&(t.iceCandidatePoolSize=6),t}};var WebRTCPeerConnection=function(e,t,i,a,n,o,s,r,c,d,l,h){this._id=e,this._hostId=t,this._mediaStreamContainer=n,this._handler=a,this._turnServer=o,this._userName=s,this._credential=r,this._audioRtpSenders=[],this._videoRtpSenders=[],this._screenRtpSenders=[],this._remoteSDP=l,this._localSDP=void 0,this._localIceCandidates=[],this._iceCandidatesGatheringTimer=void 0,this._remoteIceCandidates=h||[],this._isUpStream=d,this._stream=void 0,this._streamType=c,this._connectionType=i,this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,this._reconnectTimer=void 0,this._reconnectInterval=void 0,this._canUpdateLocalIceCandidates=!1,this._initialize(this._processType)};WebRTCPeerConnection.prototype={_addTracksInConnection:function(){void 0!==this._stream&&(WebRTCUserMedia.isScreenStreamType(this._streamType)?this._addScreenTracksInConnection():this._addAVTracksInConnection())},_addAVTracksInConnection:function(){this._addAudioTracksInConnection(),this._addVideoTracksInConnection()},_addAudioTracksInConnection:function(){this._stream.getTracks().forEach(function(e){"audio"===e.kind&&this._audioRtpSenders.push(this._connection.addTrack(e,this._stream))}.bind(this))},_addVideoTracksInConnection:function(){this._stream.getTracks().forEach(function(e){"video"===e.kind&&this._videoRtpSenders.push(this._connection.addTrack(e,this._stream))}.bind(this))},_addScreenTracksInConnection:function(){this._stream.getTracks().forEach(function(e){this._screenRtpSenders.push(this._connection.addTrack(e,this._stream))}.bind(this))},_removeAVTracksInConnection:function(){this._removeAudioTracksInConnection(),this._removeVideoTracksInConnection()},_removeAudioTracksInConnection:function(){this._audioRtpSenders.forEach(function(e){this._connection.removeTrack(e)}.bind(this)),this._audioRtpSenders=[]},_removeVideoTracksInConnection:function(){this._videoRtpSenders.forEach(function(e){this._connection.removeTrack(e)}.bind(this)),this._videoRtpSenders=[]},_initialize:function(e){this._processType=e,WebRTCPeerConnectionConstants.isReInit(e)&&(this._closeConnection(),clearInterval(this._reconnectInterval),this._reconnectInterval=void 0),this._connection||(this._connection=new RTCPeerConnection(this._getConfiguration())),this._bindEventHandlers(e),this._isUpStream?(!WebRTCPeerConnectionConstants.isReInit(e)&&this._stream||(this._stream=WebRTCUserMedia.getStream(this._streamType),this._addTracksInConnection()),this._createOffer(e)):this._createAnswer()},_bindEventHandlers:function(e){var t=!1,i=this._connection,a=function(i){var a=i.candidate;if(a)if(t){if(this._localIceCandidates.push(a.candidate),!this._canUpdateLocalIceCandidates)return;if(!this._iceCandidatesGatheringTimer){var n=function(){this._handler.updateIceCandidates(this._id,this._connectionType,this._hostId,this._localIceCandidates,e,this._isUpStream),this._localIceCandidates=[],this._iceCandidatesGatheringTimer=void 0}.bind(this);this._iceCandidatesGatheringTimer=setTimeout(n,1e3)}}else this._isUpStream?WebRTCPeerConnectionConstants.isRenegotiate(e)||this._handler.sendOffer(this._id,this._connectionType,this._localSDP.sdp,a.candidate,e,this._streamType):this._handler.sendAnswer(this._id,this._connectionType,this._localSDP.sdp,a.candidate,e,this._hostId),t=!0}.bind(this),n=function(t){var a=i.iceConnectionState;if(WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED===a||WebRTCPeerConnectionConstants.iceConnectionStates.COMPLETED===a)this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,this._handler.handleConnected(this._id,this._connectionType,this._connection,this._hostId,this._streamType,this._isUpStream,e);else if(WebRTCPeerConnectionConstants.iceConnectionStates.FAILED===a){this._reconnect();var n=this;clearInterval(this._reconnectInterval),this._reconnectInterval=setInterval((function(){n._reconnect()}),15e3)}}.bind(this),o=function(e){void 0===this._stream&&(this._stream=e.streams[0],this._stream._setType(this._streamType),this._mediaStreamContainer&&(this._mediaStreamContainer.setStream(this._stream),this._mediaStreamContainer.playStream(function(){this._handler.handlePlay(this._connectionType,this._hostId,this._stream,this._streamType,this._mediaStreamContainer)}.bind(this),function(e){"function"==typeof this._handler.handlePlayError&&this._handler.handlePlayError(e)}.bind(this))),"function"==typeof this._handler.handleTrack&&this._handler.handleTrack(this._id,e.track,e.transceiver,e.streams[0],this._hostId))}.bind(this);i.onicecandidate=a,i.oniceconnectionstatechange=n,i.ontrack=o;var s=function(t){var a=i.connectionState;WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED===a?(this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,this._handler.handleConnected(this._id,this._connectionType,this._connection,this._hostId,this._streamType,this._isUpStream,e)):WebRTCPeerConnectionConstants.iceConnectionStates.FAILED===a&&(this._reconnect(),clearInterval(this._reconnectInterval),this._reconnectInterval=setInterval(function(){this._reconnect()}.bind(this),15e3))}.bind(this);i.onconnectionstatechange=s},addTrack:function(e,t){this._isUpStream&&(this._stream=e,this._streamType=e._getType(),WebRTCUserMedia.isAudioStreamType(t)?0===this._audioRtpSenders.length&&this._addAudioTracksInConnection():WebRTCUserMedia.isVideoStreamType(t)?0===this._videoRtpSenders.length&&this._addVideoTracksInConnection():WebRTCUserMedia.isScreenStreamType(t)&&0===this._screenRtpSenders.length&&this._addScreenTracksInConnection(),this._renegotiate())},_renegotiate:function(){this._isUpStream&&(this._isReconnecting=!1,clearInterval(this._reconnectInterval),clearTimeout(this._reconnectTimer),this._initialize(WebRTCPeerConnectionConstants.processTypes.RENEGOTIATE))},_reconnect:function(){if(!this._isReconnecting){this._isReconnecting=!0;var e=WebRTCPeerConnectionConstants.processTypes.RESTART;"function"==typeof this._handler.getUpStreamReconnectProcessType&&(e=this._handler.getUpStreamReconnectProcessType()),this._processType=e,clearTimeout(this._reconnectTimer);var t=this;this._reconnectTimer=setTimeout((function(){t._isReconnecting=!1}),1e4),this._isUpStream&&this._initialize(e),this._handler.reconnectStream(this._id,this._connectionType,this._hostId,this._streamType,this._isUpStream)}},reinit:function(){this._initialize(WebRTCPeerConnectionConstants.processTypes.REINIT)},replaceTracks:function(e,t){this._isUpStream&&(this._stream=e,this._streamType=e._getType(),WebRTCUserMedia.isAudioVideoStreamType(t)?this._removeAVTracksInConnection():WebRTCUserMedia.isAudioStreamType(t)?(this._removeAudioTracksInConnection(),this._addAudioTracksInConnection()):(this._removeVideoTracksInConnection(),this._addVideoTracksInConnection()),this.reinit())},_createOffer:function(e){var t={};WebRTCPeerConnectionConstants.isRestart(e)&&(t.iceRestart=!0,this._localIceCandidates=[]);var i=this._connection,a=this;i.createOffer(t).then((function(t){a._replaceOfferValues(t),a._localSDP=t,i.setLocalDescription(t),WebRTCPeerConnectionConstants.isRenegotiate(e)&&a._handler.handleRenegotiate(a._id,a._connectionType,t.sdp,a._streamType)}))},_replaceOfferValues:function(e){WebRTCPeerConnectionConstants.isScreenConnection(this._connectionType)&&this._stream._hasAudioTrack()&&ZCWebRTCPeerConnectionUtil.replaceStereoValuesInSdp(e)},_createAnswer:function(){var e={},t=this._connection,i=this;t.setRemoteDescription(this._getRTCSessionDescriptionObj("offer",this._remoteSDP)).then((function(){t.createAnswer(e).then((function(e){i._localSDP=e,t.setLocalDescription(e)}))}))},setRemoteDescription:function(e,t,i){i&&i.length&&(this._remoteIceCandidates=i);var a=this;this._connection.setRemoteDescription(this._getRTCSessionDescriptionObj(e,t)).then((function(){a.addRemoteIceCandidates()}))},addRemoteIceCandidates:function(){var e=this._connection;this._remoteIceCandidates.forEach((function(t){e.addIceCandidate(new RTCIceCandidate(t))})),this._remoteIceCandidates=[]},updateLocalIceCandidates:function(){this._canUpdateLocalIceCandidates=!0,this._handler.updateIceCandidates(this._id,this._connectionType,this._hostId,this._localIceCandidates,this._processType,this._isUpStream),this._localIceCandidates=[]},_getRTCSessionDescriptionObj:function(e,t){return new RTCSessionDescription({type:e,sdp:t})},_closeConnection:function(){clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,clearTimeout(this._iceCandidatesGatheringTimer),this._iceCandidatesGatheringTimer=void 0,this._connection&&(this._connection.close(),this._connection=void 0),this._isReconnecting=!1,this._canUpdateLocalIceCandidates=!1,this._audioRtpSenders=[],this._videoRtpSenders=[],this._screenRtpSenders=[],this._remoteSDP=void 0,this._localSDP=void 0,this._localIceCandidates=[],this._remoteIceCandidates=[]},close:function(e){clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,this._closeConnection(),!e&&this._stream&&this._isUpStream&&WebRTCUserMedia.closeStream(this._stream._getType())},_getConfiguration:function(){var e=this._turnServer,t=this._userName,i=this._credential,a=[];return e.forEach((function(e){a.push({urls:e,username:t,credential:i})})),ZCWebRTCPeerConnectionUtil.getConfiguration(a)},setBitRate:function(e){this._videoRtpSenders.forEach((function(t){var i=t.getParameters();i.encodings||(i.encodings=[{}]),i.encodings[0].maxBitrate=1e3*e,t.setParameters(i)}))}};var WebRTCPeerConnectionStats={},CallStrengthAnalyser={},CallStrengthStatsConstants={},GroupCallStrengthAnalyser={};WebRTCPeerConnectionStats=function(){var e={},t=void 0,i="standard",a={connectedTransportKeyIncludes:"RTCTransport_",candidateKeyIncludes:"RTCIceCandidate",hostCandidateTypeValue:"host",candidatePairType:"candidate-pair",candidatePairSelectedState:"succeeded",localCandidateType:"local-candidate",remoteCandidateType:"remote-candidate",transportStatType:"transport",ssrcKeyName:"ssrc",ssrcListKeyName:"ssrclist",subTypeKeyName:"subTypeKey"},n={"outbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCOutboundRTPAudioStream_",video:"RTCOutboundRTPVideoStream_"}},"inbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCInboundRTPAudioStream_",video:"RTCInboundRTPVideoStream_"}},"remote-inbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCRemoteInboundRtpAudioStream_",video:"RTCRemoteInboundRtpVideoStream_"}}},o={RTCLiveIceCandidatePair:{bytesSent:"bytessent",bytesReceived:"bytesreceived",availableOutgoingBitrate:"availablebitrate",availableIncomingBitrate:"recvbitrate",totalRoundTripTime:"totalrtt",currentRoundTripTime:"rtt"},RTCOutboundRTPVideoStream_:{pliCount:"videoplisrecv",nackCount:"videonacksrecv",bytesSent:"videobytessent",framesEncoded:"framesencoded",packetsSent:"videopacketssent",framesSent:"videoframessent",totalEncodeTime:"totalencodetime",totalPacketSendDelay:"totalpacketsenddelay"},RTCRemoteInboundRtpVideoStream_:{jitter:"sendvideojitter",packetsLost:"sendvideopacketlost"},RTCInboundRTPAudioStream_:{jitter:"recvaudiojitter",packetsLost:"recvaudiopacketlost",packetsReceived:"audiopacketsreceived"},RTCInboundRTPVideoStream_:{pliCount:"videoplissent",nackCount:"videonackssent",packetsLost:"recvvideopacketlost",bytesReceived:"bytesreceived",packetsReceived:"packetsreceived",framesDecoded:"framesdecoded",totalDecodeTime:"totaldecodetime",totalInterFrameDelay:"totalinterframedelay",framesReceived:"framesreceived",framesDropped:"framesdropped"},RTCOutboundRTPAudioStream_:{packetsSent:"audiopacketssent",bytesSent:"audiobytessent"},RTCRemoteInboundRtpAudioStream_:{jitter:"sendaudiojitter",packetsLost:"sendaudiopacketlost"}},s=["RTCOutboundRTPVideoStream_","RTCRemoteInboundRtpAudioStream_","RTCRemoteInboundRtpVideoStream_","RTCInboundRTPAudioStream_","RTCInboundRTPVideoStream_","RTCOutboundRTPAudioStream_"],r=function(e,t,i,a,n){this._moduleId=t,this._id=e,this._connection=i,this._connectionMetaData=a,this._timeVsStats={},this._networkInfo={},this._candidatePairInfo={},this._networkInfoCallBack=n.networkInfoCallBack,this._updateStatsCallBack=n.updateStatsCallBack,this._statsCallBack=n.statsCallBack,this._candidatePairInfoCallBack=n.candidatePairInfoCallBack,this._hasSentNetworkInfo=!1,this._hasSentCandidatePairInfo=!1,this._statsObjectMaxSize=30,void 0!==a&&void 0!==a.statsObjectMaxSize&&(this._statsObjectMaxSize=a.statsObjectMaxSize),this._statsGatheringIntervalTime=1e3,void 0!==a&&void 0!==a.statsGatheringIntervalTime&&(this._statsGatheringIntervalTime=a.statsGatheringIntervalTime)};function c(){return"undefined"!=typeof $ZCUtil&&"undefined"!=typeof RTCStatsReport}function d(e){return(function(e){return void 0!==e&&e.type===a.localCandidateType}(e)||function(e){return void 0!==e&&e.type===a.remoteCandidateType}(e))&&e.candidateType===a.hostCandidateTypeValue}function l(e){return function(e){return void 0!==e&&e.type===a.candidatePairType&&(void 0===e.nominated||e.nominated)}(e)&&e.state===a.candidatePairSelectedState}function h(e){return void 0!==e&&e.type===a.transportStatType}function u(e){var t=void 0,i=e.values(),a=void 0;do{var n=(a=i.next()).value;if(l(n)){t=n.id;break}if(h(n)){t=n.selectedCandidatePairId;break}}while(!a.done);return t}function v(e,t,i){var r={},c=function(e,t){for(var i in o)if(-1!==e.indexOf(i)||e.toUpperCase()===i.toUpperCase())return i;for(var s in n)if(t.type===s){var r=n[s],c=r[a.subTypeKeyName];return void 0!==c?r[c][t[c]]:r}}(e,t);if(c){var d=i&&function(e){return-1!==s.indexOf(e)}(c),l=o[c];for(var h in l)if(d){var u=t[a.ssrcKeyName];void 0===r[u]&&(r[a.ssrcKeyName]=u,r[u]={}),r[u][l[h]]=t[h]}else r[l[h]]=t[h]}return r}function m(e,t,i){var a=t.get(i.localCandidateId),n=t.get(i.remoteCandidateId),o=a.networkType,s=a.ip||a.address,r=void 0,c=(n.ip||n.address,void 0);void 0!==(c=d(a)?a:function(e,t){var i;return e.forEach((function(e,a){d(e)&&e.networkType===t&&(i=e)})),i}(t,o))&&(r=c.ip||c.address),e.setNetworkInfo(o,r,s,a,n),e.sendNetworkInfo()}function p(e,t,i){var a=t.get(i.localCandidateId),n=t.get(i.remoteCandidateId);e.setCandidatePairInfo(a,n),e.sendCandidatePairInfo()}function S(e){var t=e.getConnection();WebRTCPeerConnectionConstants.isConnectionClosed(t)?C(e.getId(),e.getModuleId()):WebRTCPeerConnectionConstants.isConnectionActive(t)&&t.getStats().then((function(t){var i=u(t);if(void 0!==i){var n=t.get(i);e.hasSentNetworkInfo()||m(e,t,n),e.hasSentCandidatePairInfo()||p(e,t,n);var o=e.isSSRCBased(),s=new Set,r=v("RTCLiveIceCandidatePair",n,o);t.forEach((function(e,t){var i=v(t,e,o);o&&i[a.ssrcKeyName]&&(s.add(i[a.ssrcKeyName]),delete i[a.ssrcKeyName]),ZCJQuery.extend(!0,r,i)})),o&&(r[a.ssrcListKeyName]=[...s]);var c="undefined"!=typeof $ZCUtil?$ZCUtil.getSyncedCurrentTime():Date.now();e.updateAndSendStats(c,r,t)}}))}function C(i,a){var n=e[a];if(void 0!==n){var o=n[i];o&&o._sendStats(),delete n[i],0===Object.keys(n).length&&delete e[a]}0===Object.keys(e).length&&(clearInterval(t),t=void 0)}return r.prototype={setNetworkInfo:function(e,t,i,a,n){var o=a.ip||a.address;void 0!==a.port&&(o=o+":"+a.port);var s=n.ip||n.address;void 0!==n.port&&(s=s+":"+n.port),this._networkInfo={network_type:e,private_ip:t,public_ip:i,local_ip:o,remote_ip:s,local_candidate_type:a.candidateType}},setCandidatePairInfo:function(e,t){this._candidatePairInfo={remote_ip:t.ip||t.address,local_ip:e.ip||e.address,remote_candidate_type:t.candidateType,local_candidate_type:e.candidateType,remote_candidate_port:t.port,local_candidate_port:e.port}},getId:function(){return this._id},getModuleId:function(){return this._moduleId},getConnection:function(){return this._connection},isSSRCBased:function(){return void 0!==this._connectionMetaData&&this._connectionMetaData.isSSRCBased},hasSentNetworkInfo:function(){return this._hasSentNetworkInfo},getStatsGatheringIntervalTime:function(){return this._statsGatheringIntervalTime},sendNetworkInfo:function(){"function"==typeof this._networkInfoCallBack&&this._networkInfoCallBack(this._id,this._moduleId,this._networkInfo,i,this._connectionMetaData),this._hasSentNetworkInfo=!0},hasSentCandidatePairInfo:function(){return this._hasSentCandidatePairInfo},sendCandidatePairInfo:function(){"function"==typeof this._candidatePairInfoCallBack&&this._candidatePairInfoCallBack(this._id,this._moduleId,this._candidatePairInfo),this._hasSentCandidatePairInfo=!0},updateAndSendStats:function(e,t,i){this._timeVsStats[e]=t,"function"==typeof this._statsCallBack&&this._statsCallBack(e,t,i,this._connectionMetaData),Object.keys(this._timeVsStats).length===this._statsObjectMaxSize&&this._sendStats()},_sendStats:function(){"function"==typeof this._updateStatsCallBack&&this._updateStatsCallBack(this._id,this._moduleId,this._timeVsStats,i,this._connectionMetaData),this._timeVsStats={}}},{isStatsSupported:c,initiateGathering:function(i,a,n,o,s){if(void 0!==i&&void 0!==a&&void 0!==n&&(void 0!==s.statsCallBack||void 0!==s.networkInfoCallBack&&void 0!==s.updateStatsCallBack)){if(!c())return n.getStats().then(function(e){var t=u(e);p(new r(i,a,n,o,s),e,e.get(t))}.bind(this)),void function(e,t,i){"function"==typeof i.errorCallback&&i.errorCallback(e,t)}(i,a,s);var d=e[a]||{};d[i]=new r(i,a,n,o,s),e[a]=d,void 0===t&&(t=setInterval((function(){!function(){for(var t in e){var i=e[t];for(var a in i){var n=i[a];try{S(n)}catch(e){}}}}()}),d[i].getStatsGatheringIntervalTime()))}},stopGathering:C,getConnectionIds:function(t){let i=e[t];return void 0!==i?Object.keys(i):[]},getSelectedCandidatePair:function(e,t,i,a){e&&t&&i&&"function"==typeof a&&i.getStats().then(function(n){var o=u(n);p(new r(e,t,i,void 0,{candidatePairInfoCallBack:a}),n,n.get(o))}.bind(this))}}}(),CallStrengthStatsConstants={maxThresholdScore:10,callStrengthCalcInterval:1e4,statsGatheringInterval:1e3,audioDownStreamScore:{paramsCount:2,lostParamsCount:1},audioUpStreamScore:{paramsCount:2,lostParamsCount:0},videoDownStreamScore:{paramsCount:3,lostParamsCount:1},videoUpStreamScore:{paramsCount:3,lostParamsCount:0},rtt:{maxThreshold:.8,minThreshold:.3},jitter:{audioMinThreshold:.03,videoMinThreshold:.2},packetSent:{maxThreshold:40,minThreshold:30},bytesSent:{maxThreshold:2500,minThreshold:1500},frames:{maxDecodeValue:7,delayThreshold:.15},video:{maxEncodingDelay:.15,maxPacketSentDelay:.05},candidatePair:"candidate-pair",mediaTrackReceiver:"RTCMediaStreamTrack_receiver",mediaTrackSender:"sender",rtpType:{outBound:"outbound-rtp",inBound:"inbound-rtp"},statType:{audio:"audio",video:"video"}},(CallStrengthAnalyser=function(e,t,i){this._id=e,this._peerConnection=t,this._statType=void 0,this._statsGatheringTimer=void 0,this._updateScoreTimer=void 0,this._callBacks=i,this._prevAudioBytesSent=0,this._prevAudioPacketsSent=0,this._prevAudioPacketsReceived=0,this._prevAudioPacketsLost=0,this._currentAudioPacketsReceived=0,this._currentAudioPacketsLost=0,this._prevVideoFramesDecoded=0,this._prevVideoInterFrameDelay=0,this._prevVideoPacketSendDelay=0,this._prevVideoDecodeTime=0,this._prevVideoEncodeTime=0,this._prevVideoPacketsSent=0,this._prevVideoPacketsLost=0,this._prevVideoPacketsReceived=0,this._prevVideoFramesSent=0,this._prevVideoFramesLost=0,this._prevVideoFramesReceived=0,this._prevVideoFramesEncoded=0,this._prevVideoJitterBufferDelay=0,this._prevVideoJitterBufferEmittedCount=0,this._currentVideoPacketsLost=0,this._currentVideoPacketsReceived=0,this._currentVideoFramesLost=0,this._currentVideoFramesReceived=0,this._lastAudioPacketReceivedTimestamp=0,this._lastVideoPacketReceivedTimestamp=0,this._rttArray=[],this._audioJitterBufferArray=[],this._audioPacketsSentArray=[],this._audioBytesSentArray=[],this._framesDecodedArray=[],this._videoJitterBufferArray=[],this._interFrameDelayArray=[],this._decodeTimeArray=[],this._framesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._callStrengthScore=void 0,this._lastUpdatedTime=(new Date).getTime(),this._initiate()}).prototype={getId:function(){return this._id},getConnection:function(){return this._peerConnection},_setStatType:function(e){this._statType=e},_getCurrentStatType:function(){return this._statType},_hasVideoStat:function(){return this._getCurrentStatType()===CallStrengthStatsConstants.statType.video},_setScore:function(e){this._callStrengthScore=e},getScore:function(){return this._callStrengthScore},_initiate:function(){if(void 0!==this._id&&void 0!==this._peerConnection&&void 0!==this._callBacks&&void 0!==this._callBacks.updateCallQuality)return"undefined"==typeof $ZCUtil||!$ZCUtil.Browser.isChrome()&&!$ZCUtil.Browser.isOpera()?"function"==typeof this._callBacks.handleFallback?this._callBacks.handleFallback():void 0:void this._startAnalysis()},_startAnalysis:function(){clearInterval(this._statsGatheringTimer),this._statsGatheringTimer=setInterval(this._initiateStatsGathering.bind(this),CallStrengthStatsConstants.statsGatheringInterval),this._updateScoreTimer=setInterval(this._updateScore.bind(this),CallStrengthStatsConstants.callStrengthCalcInterval)},stopAnalysis:function(){clearInterval(this._statsGatheringTimer),clearInterval(this._updateScoreTimer)},_initiateStatsGathering:function(){this._peerConnection.getStats().then(function(e){this._gatherStats(e)}.bind(this))},_gatherStats:function(e){e.forEach(function(e){e.type===CallStrengthStatsConstants.candidatePair&&e.nominated&&this._rttArray.push(e.currentRoundTripTime),e.kind===CallStrengthStatsConstants.statType.audio?this._gatherAudioStat(e):e.kind===CallStrengthStatsConstants.statType.video&&this._gatherVideoStat(e),void 0!==e.kind&&this._setStatType(e.kind)}.bind(this))},_gatherAudioStat:function(e){e.type===CallStrengthStatsConstants.rtpType.outBound&&void 0!==e.mediaSourceId&&(this._audioPacketsSentArray.push(e.packetsSent-this._prevAudioPacketsSent),this._audioBytesSentArray.push(e.bytesSent-this._prevAudioBytesSent),this._prevAudioPacketsSent=e.packetsSent,this._prevAudioBytesSent=e.bytesSent),e.type===CallStrengthStatsConstants.rtpType.inBound&&e.lastPacketReceivedTimestamp-this._lastAudioPacketReceivedTimestamp>0&&(this._audioJitterBufferArray.push(e.jitter),this._currentAudioPacketsLost=e.packetsLost,this._currentAudioPacketsReceived=e.packetsReceived,this._lastAudioPacketReceivedTimestamp=e.lastPacketReceivedTimestamp)},_gatherVideoStat:function(e){if(e.id.includes(CallStrengthStatsConstants.mediaTrackSender)&&(this._framesSentArray.push(e.framesSent-this._prevVideoFramesSent),this._prevVideoFramesSent=e.framesSent),e.id.includes(CallStrengthStatsConstants.mediaTrackReceiver)){this._currentVideoFramesReceived=e.framesReceived,this._currentVideoFramesLost=e.framesDropped;var t=e.jitterBufferDelay,i=e.jitterBufferEmittedCount;0!=this._prevVideoJitterBufferEmittedCount&&(t-=this._prevVideoJitterBufferDelay,i-=this._prevVideoJitterBufferEmittedCount),this._videoJitterBufferArray.push(t/i),this._prevVideoJitterBufferDelay=e.jitterBufferDelay,this._prevVideoJitterBufferEmittedCount=e.jitterBufferEmittedCount}if(e.type===CallStrengthStatsConstants.rtpType.outBound&&void 0!==e.mediaSourceId&&(this._videoFramesEncodingTimeArray.push((e.totalEncodeTime-this._prevVideoEncodeTime)/(e.framesEncoded-this._prevVideoFramesEncoded)),this._videoPacketSendDelayTimeArray.push((e.totalPacketSendDelay-this._prevVideoPacketSendDelay)/(e.packetsSent-this._prevVideoPacketsSent)),this._prevVideoFramesEncoded=e.framesEncoded,this._prevVideoEncodeTime=e.totalEncodeTime,this._prevVideoPacketSendDelay=e.totalPacketSendDelay,this._prevVideoPacketsSent=e.packetsSent),e.type===CallStrengthStatsConstants.rtpType.inBound&&e.lastPacketReceivedTimestamp-this._lastVideoPacketReceivedTimestamp>0){this._currentVideoPacketsLost=e.packetsLost,this._currentVideoPacketsReceived=e.packetsReceived;var a=e.framesDecoded-this._prevVideoFramesDecoded;this._framesDecodedArray.push(a),this._interFrameDelayArray.push((e.totalInterFrameDelay-this._prevVideoInterFrameDelay)/a),this._decodeTimeArray.push((e.totalDecodeTime-this._prevVideoDecodeTime)/a),this._prevVideoFramesDecoded=e.framesDecoded,this._prevVideoDecodeTime=e.totalDecodeTime,this._prevVideoInterFrameDelay=e.totalInterFrameDelay,this._lastVideoPacketReceivedTimestamp=e.lastPacketReceivedTimestamp}},_resetStats:function(){this._rttArray=[],this._audioJitterBufferArray=[],this._audioPacketsSentArray=[],this._audioBytesSentArray=[],this._framesDecodedArray=[],this._videoJitterBufferArray=[],this._interFrameDelayArray=[],this._decodeTimeArray=[],this._framesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[]},getCurrentStats:function(){CallStrengthStatsConstants.maxThresholdScore=Math.round(((new Date).getTime()-this._lastUpdatedTime)/1e3);var e=this._analyseDownStreamConnectionStrength(),t=this._analyseUpStreamConnectionStrength();return CallStrengthStatsConstants.maxThresholdScore=10,{downstreamStrength:e,upstreamStrength:t}},_updateScore:function(){this._lastUpdatedTime=(new Date).getTime();var e=this._analyseDownStreamConnectionStrength(),t=this._analyseUpStreamConnectionStrength(),i=CallStrengthStatsConstants.maxThresholdScore,a=i/2,n=i*CallStrengthStatsConstants.audioDownStreamScore.paramsCount+a*CallStrengthStatsConstants.audioDownStreamScore.lostParamsCount,o=i*CallStrengthStatsConstants.audioUpStreamScore.paramsCount+a*CallStrengthStatsConstants.audioUpStreamScore.lostParamsCount,s=Math.round((n-e.audioJitterScore-e.rttScore-e.audioPacketsLostPercentage)/(n/5)),r=Math.round((o-t.audioPacketsSentScore-t.audioBytesSentScore)/(o/5));(e.audioJitterScore>=.6*i||e.rttScore>=.6*i||e.audioPacketsLostPercentage>=.4*a)&&s>3&&(s=3);var c={upStreamScore:{audioUpStreamPerformanceScore:r},performanceScore:{audioPerformanceScore:s}};if(this._hasVideoStat()){var d=i*CallStrengthStatsConstants.videoDownStreamScore.paramsCount+a*CallStrengthStatsConstants.videoDownStreamScore.lostParamsCount,l=i*CallStrengthStatsConstants.videoUpStreamScore.paramsCount+a*CallStrengthStatsConstants.videoUpStreamScore.lostParamsCount,h=Math.round((d-e.videoJitterScore-e.frameScore-e.interFrameDelayScore-e.videoFramesLostPercentage)/(d/5)),u=Math.round((l-t.frameSentScore-t.videoEncodingScore-t.videoPacketSendDelayScore)/(l/5));(e.videoJitterScore>=.6*i||e.frameScore>=.6*i||e.interFrameDelayScore>=.6*i||e.videoFramesLostPercentage>=.4*a)&&h>3&&(h=3),c.upStreamScore.videoUpStreamPerformanceScore=u,c.performanceScore.videoPerformanceScore=h}var v={downstreamStrength:e,upstreamStrength:t};this._setScore(c),this._callBacks.updateCallQuality(this.getId(),c,v),this._resetStats()},_analyseDownStreamConnectionStrength:function(){var e=this._currentAudioPacketsReceived-this._prevAudioPacketsReceived,t=this._currentAudioPacketsLost-this._prevAudioPacketsLost,i={audioPacketsLostPercentage:this._calculateLossPercentage(e,t),audioJitterScore:this._calculateJitterScore(this._audioJitterBufferArray,CallStrengthStatsConstants.jitter.audioMinThreshold),rttScore:this._calculateRTTScore()};if(this._prevAudioPacketsReceived=this._currentAudioPacketsReceived,this._prevAudioPacketsLost=this._currentAudioPacketsLost,this._hasVideoStat()){var a=this._currentVideoPacketsReceived-this._prevVideoPacketsReceived,n=this._currentVideoPacketsLost-this._prevVideoPacketsLost,o=this._currentVideoFramesReceived-this._prevVideoFramesReceived,s=this._currentVideoFramesLost-this._prevVideoFramesLost;i.videoPacketsLostPercentage=this._calculateLossPercentage(a,n),i.videoFramesLostPercentage=this._calculateLossPercentage(o,s),i.videoJitterScore=this._calculateJitterScore(this._videoJitterBufferArray,CallStrengthStatsConstants.jitter.videoMinThreshold),i.frameScore=this._calculateFrameScore(this._framesDecodedArray),i.interFrameDelayScore=this._calculateFrameDelayScore(),this._prevVideoPacketsReceived=this._currentVideoPacketsReceived,this._prevVideoPacketsLost=this._currentVideoPacketsLost,this._prevVideoFramesReceived=this._currentVideoFramesReceived,this._prevVideoFramesLost=this._currentVideoFramesLost}return i},_analyseUpStreamConnectionStrength:function(){var e={audioPacketsSentScore:this._calculateAudioUpStreamScore(this._audioPacketsSentArray,CallStrengthStatsConstants.packetSent.minThreshold,CallStrengthStatsConstants.packetSent.maxThreshold),audioBytesSentScore:this._calculateAudioUpStreamScore(this._audioBytesSentArray,CallStrengthStatsConstants.bytesSent.minThreshold,CallStrengthStatsConstants.bytesSent.maxThreshold)};if(this._hasVideoStat()){var t=this._calculateFrameScore(this._framesSentArray);e.videoEncodingScore=this._calculateVideoUpStreamDelayScore(this._videoFramesEncodingTimeArray,CallStrengthStatsConstants.video.maxEncodingDelay),e.videoPacketSendDelayScore=this._calculateVideoUpStreamDelayScore(this._videoPacketSendDelayTimeArray,CallStrengthStatsConstants.video.maxPacketSentDelay),e.frameSentScore=t>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:t}return e},_calculateRTTScore:function(){var e=0,t=this._rttArray.length;for(var i of(t<CallStrengthStatsConstants.maxThresholdScore&&(e=CallStrengthStatsConstants.maxThresholdScore-t),this._rttArray))null==i||i>CallStrengthStatsConstants.rtt.maxThreshold?e+=2:i>CallStrengthStatsConstants.rtt.minThreshold&&e++;return e>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:e},_calculateJitterScore:function(e,t){var i=0,a=e.length;for(var n of(a<CallStrengthStatsConstants.maxThresholdScore&&(i=CallStrengthStatsConstants.maxThresholdScore-a),e))(null==n||isNaN(n)||n>t)&&i++;return i},_calculateFrameScore:function(e){var t=0,i=e.length;for(var a of(i<CallStrengthStatsConstants.maxThresholdScore&&(t=CallStrengthStatsConstants.maxThresholdScore-i),e))(null==a||a<CallStrengthStatsConstants.frames.maxDecodeValue)&&t++;return t},_calculateFrameDelayScore:function(){var e=0,t=this._interFrameDelayArray.length;for(var i of(t<CallStrengthStatsConstants.maxThresholdScore&&(e=CallStrengthStatsConstants.maxThresholdScore-t),this._interFrameDelayArray))(null==i||isNaN(i)||i>CallStrengthStatsConstants.frames.delayThreshold)&&e++;return e},_calculateLossPercentage:function(e,t){var i=CallStrengthStatsConstants.maxThresholdScore/2;return null==t||null==e||0==e||isNaN(t)||isNaN(e)||(i=Math.round(t/e*CallStrengthStatsConstants.maxThresholdScore/2))>CallStrengthStatsConstants.maxThresholdScore/2&&(i=CallStrengthStatsConstants.maxThresholdScore/2),i},_calculateAudioUpStreamScore:function(e,t,i){var a=0,n=e.length;for(var o of(n<CallStrengthStatsConstants.maxThresholdScore&&(a=CallStrengthStatsConstants.maxThresholdScore-n),e))null==o||o<t?a+=2:o<i&&a++;return a>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:a},_calculateVideoUpStreamDelayScore:function(e,t){var i=0,a=e.length;for(var n of(a<CallStrengthStatsConstants.maxThresholdScore&&(i=CallStrengthStatsConstants.maxThresholdScore-a),e))(null==n||n>t||isNaN(n))&&i++;return i>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:i}},(GroupCallStrengthAnalyser=function(e,t,i,a){this._id=e,this._stageIncreaseCallBack=t,this._stageReduceCallBack=i,this._networkStrengthCallBack=a,this._prevAudioUpStreamSSRCMap={},this._audioUpStreamSSRCMap={},this._audioUpStreamConnectionCrttArray=[],this._audioUpStreamPeformanceMap={},this._prevAudioDownStreamSSRCMap={},this._audioDownStreamSSRCMap={},this._audioDownStreamConnectionCrttArray=[],this._audioDownStreamPeformanceMap={},this._prevVideoFramesEncoded=0,this._prevVideoEncodeTime=0,this._prevVideoPacketSendDelay=0,this._prevVideoPacketsSent=0,this._prevVideoFramesSent=0,this._videoFramesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._videoDownStreamSSRCMap={},this._audioUpStreamConnectionScore=0,this._audioDownStreamConnectionScore=0,this._videoUpStreamConnectionScore=0,this._videoDownStreamConnectionScore=0,this._isAudioUpStreamAnalysed=!1,this._isAudioDownStreamAnalysed=!1,this._isVideoUpStreamAnalysed=!1,this._isVideoDownStreamAnalysed=!1,this._audioUpStreamConnectionStatsData=void 0,this._audioDownStreamConnectionStatsData=void 0,this._videoUpStreamConnectionStatsData=void 0,this._videoDownStreamConnectionStatsData=void 0,this._audioUpStreamConnectionFilteredStatsData=void 0,this._audioDownStreamConnectionFilteredStatsData=void 0,this._videoUpStreamConnectionFilteredStatsData=void 0,this._videoDownStreamConnectionFilteredStatsData=void 0,this._stageCalcInterval=void 0,this._scoreUpdateInterval=void 0,this.initiate()}).prototype={initiate:function(){clearInterval(this._scoreUpdateInterval),this._scoreUpdateInterval=setInterval(function(){this._calculateAudioUpStreamConnectionScore(),this._calculateAudioDownStreamConnectionScore(),this._calculateVideoUpStreamConnectionScore()}.bind(this),9e3),clearInterval(this._stageCalcInterval),this._stageCalcInterval=setInterval(function(){var e=!1,t=!1,i=0,a=0,n=void 0,o=void 0;this._isAudioDownStreamAnalysed&&(n=this._audioDownStreamConnectionScore,i+=this._audioDownStreamConnectionScore,a++,this._audioDownStreamConnectionScore<=2?e=!0:this._audioDownStreamConnectionScore>=4&&(t=!0),this._isAudioDownStreamAnalysed=!1),this._isAudioUpStreamAnalysed&&(o=this._audioUpStreamConnectionScore,i+=this._audioUpStreamConnectionScore,a++,this._audioUpStreamConnectionScore<=2?(e=!0,t=!1):this._audioUpStreamConnectionScore>=4&&!e&&(t=!0),this._isAudioUpStreamAnalysed=!1),a>0&&(i=Math.round(i/a),this._networkStrengthCallBack(i)),t?this._stageIncreaseCallBack(o,n):e&&this._stageReduceCallBack(o,n)}.bind(this),1e3)},destroy:function(){clearInterval(this._scoreUpdateInterval),this._scoreUpdateInterval=void 0,clearInterval(this._stageCalcInterval),this._stageCalcInterval=void 0},updateAudioUpStreamConnectionStatsData:function(e,t){this._audioUpStreamConnectionStatsData=e,this._audioUpStreamConnectionFilteredStatsData=t,this._setAudioUpStreamConnectionStatsData()},updateAudioDownStreamConnectionStatsData:function(e,t){this._audioDownStreamConnectionStatsData=e,this._audioDownStreamConnectionFilteredStatsData=t,this._setAudioDownStreamConnectionStatsData()},updateVideoUpStreamConnectionStatsData:function(e,t){this._videoUpStreamConnectionStatsData=e,this._videoUpStreamConnectionFilteredStatsData=t,this._setVideoUpStreamConnectionStatsData()},updateVideoDownStreamConnectionStatsData:function(e,t){this._videoDownStreamConnectionStatsData=e,this._videoDownStreamConnectionFilteredStatsData=t,this._setVideoDownStreamConnectionStatsData()},_setAudioUpStreamConnectionStatsData:function(){var e=this._audioUpStreamConnectionStatsData,t=this._audioUpStreamConnectionFilteredStatsData;if(e&&t){void 0!==t.rtt&&this._audioUpStreamConnectionCrttArray.push(t.rtt);var i=t.ssrclist;for(var a of i){var n=t[a],o=this._audioUpStreamSSRCMap[a];o?(o.jitter.push(n.sendaudiojitter),o.packetsLost=n.sendaudiopacketlost,o.packetsSent=n.audiopacketssent):this._audioUpStreamSSRCMap[a]={jitter:[n.sendaudiojitter],packetsLost:n.sendaudiopacketlost,packetsSent:n.audiopacketssent}}}},_calculateAudioUpStreamConnectionScore:function(){if(this._audioUpStreamConnectionStatsData&&this._audioUpStreamConnectionFilteredStatsData){this._audioUpStreamPeformanceMap={};var e=!1,t=0;if(this._audioUpStreamConnectionCrttArray.length){for(var i of(e=!0,this._audioUpStreamConnectionCrttArray))null==i||i>1?t+=2:i>.3&&t++;t>CallStrengthStatsConstants.maxThresholdScore&&(t=CallStrengthStatsConstants.maxThresholdScore)}var a=0,n=0,o=0,s=0;for(var r in this._audioUpStreamSSRCMap){var c=this._audioUpStreamSSRCMap[r],d=0,l=c.packetsLost,h=c.packetsSent;if(this._prevAudioUpStreamSSRCMap&&this._prevAudioUpStreamSSRCMap[r]){var u=this._prevAudioUpStreamSSRCMap[r];u&&(l-=u.packetsLost,h-=u.packetsSent,l<0&&(l=c.packetsLost||0),h<0&&(h=c.packetsSent))}var v=c.jitter,m=0;if(h>0||l>0)for(var p of v)a++,(null==p||p>.03)&&(m++,n++);m>CallStrengthStatsConstants.maxThresholdScore&&(m=CallStrengthStatsConstants.maxThresholdScore),s+=l,o+=h,d=l>0&&h>0?Math.round(l/h*5):0,(isNaN(d)||d>5||d<0)&&(d=5);var S=0;S=e?Math.round((25-m-d-t)/5):Math.round((15-m-d)/3),m>=6&&S>3&&(S=3),this._audioUpStreamPeformanceMap[r]=S}var C=0;(s>0||o>0)&&(C=Math.round(n/a*CallStrengthStatsConstants.maxThresholdScore));var _=0;s>0&&o>0&&(_=Math.round(s/o*5)),_>CallStrengthStatsConstants.maxThresholdScore&&(_=CallStrengthStatsConstants.maxThresholdScore);var f=C+_,g=0;(g=e?Math.round((25-(f+t))/5):Math.round((15-f)/3))>2&&(C>5||_>2||e&&t>5)&&(g=2),this._audioUpStreamConnectionScore=g,this._prevAudioUpStreamSSRCMap=ZCJQuery.extend(!0,{},this._audioUpStreamSSRCMap),this._audioUpStreamConnectionCrttArray=[],this._isAudioUpStreamAnalysed=!0}},_setAudioDownStreamConnectionStatsData:function(){var e=this._audioDownStreamConnectionStatsData,t=this._audioDownStreamConnectionFilteredStatsData;if(e&&t){void 0!==t.rtt&&this._audioDownStreamConnectionCrttArray.push(t.rtt);var i=t.ssrclist;for(var a of i){var n=t[a],o=this._audioDownStreamSSRCMap[a];o?(o.jitter.push(n.recvaudiojitter),o.packetsLost=n.recvaudiopacketlost,o.packetsReceived=n.audiopacketsreceived):this._audioDownStreamSSRCMap[a]={jitter:[n.recvaudiojitter],packetsLost:n.recvaudiopacketlost,packetsReceived:n.audiopacketsreceived}}}},_calculateAudioDownStreamConnectionScore:function(){if(this._audioDownStreamConnectionStatsData&&this._audioDownStreamConnectionFilteredStatsData){this._audioDownStreamPeformanceMap={};var e=!1,t=0;if(this._audioDownStreamConnectionCrttArray.length){for(var i of(e=!0,this._audioDownStreamConnectionCrttArray))null==i||i>1?t+=2:i>.3&&t++;t>CallStrengthStatsConstants.maxThresholdScore&&(t=CallStrengthStatsConstants.maxThresholdScore)}var a=0,n=0,o=0,s=0;for(var r in this._audioDownStreamSSRCMap){var c=this._audioDownStreamSSRCMap[r],d=0,l=c.packetsLost,h=c.packetsReceived;if(this._prevAudioDownStreamSSRCMap&&this._prevAudioDownStreamSSRCMap[r]){var u=this._prevAudioDownStreamSSRCMap[r];u&&(l-=u.packetsLost,h-=u.packetsReceived,l<0&&(l=c.packetsLost||0),h<0&&(h=c.packetsReceived))}var v=c.jitter,m=0;if(h>0||l>0)for(var p of v)a++,(null==p||p>.03)&&(m++,n++);m>CallStrengthStatsConstants.maxThresholdScore&&(m=CallStrengthStatsConstants.maxThresholdScore),s+=l,o+=h,d=l>0&&h>0?Math.round(l/h*5):0,(isNaN(d)||d>5||d<0)&&(d=5);var S=0;S=e?Math.round((25-m-d-t)/5):Math.round((15-m-d)/3),m>=6&&S>3&&(S=3),this._audioDownStreamPeformanceMap[r]=S}var C=0;(s>0||o>0)&&(C=Math.round(n/a*CallStrengthStatsConstants.maxThresholdScore));var _=0;s>0&&o>0&&(_=Math.round(s/o*5)),_>CallStrengthStatsConstants.maxThresholdScore&&(_=CallStrengthStatsConstants.maxThresholdScore);var f=C+_,g=0;(g=e?Math.round((25-(f+t))/5):Math.round((15-f)/3))>2&&(C>5||_>2||e&&t>5)&&(g=2),this._audioDownStreamConnectionScore=g,this._prevAudioDownStreamSSRCMap=ZCJQuery.extend(!0,{},this._audioDownStreamSSRCMap),this._audioDownStreamConnectionCrttArray=[],this._isAudioDownStreamAnalysed=!0}},_setVideoUpStreamConnectionStatsData:function(){var e=this._videoUpStreamConnectionStatsData,t=this._videoUpStreamConnectionFilteredStatsData;if(e&&t){var i=t[t.ssrclist[0]],a=i.totalencodetime-this._prevVideoEncodeTime,n=i.framesencoded-this._prevVideoFramesEncoded;this._videoFramesEncodingTimeArray.push(a/n);var o=i.totalpacketsenddelay-this._prevVideoPacketSendDelay,s=i.packetssent-this._prevVideoPacketsSent;this._videoPacketSendDelayTimeArray.push(o/s),this._videoFramesSentArray.push(i.framessent-this._prevVideoFramesSent),this._prevVideoFramesEncoded=i.framesencoded,this._prevVideoEncodeTime=i.totalencodetime,this._prevVideoPacketSendDelay=i.totalpacketsenddelay,this._prevVideoPacketsSent=i.videopacketssent,this._prevVideoFramesSent=i.videoframessent}},_calculateVideoUpStreamConnectionScore:function(){if(this._videoUpStreamConnectionStatsData&&this._videoUpStreamConnectionFilteredStatsData){var e=0;for(var t of this._videoFramesSentArray)(null==t||t<5)&&e++;var i=Math.round(e/this._videoFramesSentArray.length)*CallStrengthStatsConstants.maxThresholdScore;i>CallStrengthStatsConstants.maxThresholdScore&&(i=CallStrengthStatsConstants.maxThresholdScore);var a=0;for(var n of this._videoFramesEncodingTimeArray)(null==n||isNaN(n)||n>.15)&&a++;var o=Math.round(a/this._videoFramesEncodingTimeArray.length)*CallStrengthStatsConstants.maxThresholdScore;o>CallStrengthStatsConstants.maxThresholdScore&&(o=CallStrengthStatsConstants.maxThresholdScore);var s=0;for(var r of this._videoPacketSendDelayTimeArray)(null==r||isNaN(r)||r>.1)&&s++;var c=Math.round(s/this._videoPacketSendDelayTimeArray.length)*CallStrengthStatsConstants.maxThresholdScore;c>CallStrengthStatsConstants.maxThresholdScore&&(c=CallStrengthStatsConstants.maxThresholdScore);var d=Math.round((30-i-o-c)/6);this._videoUpStreamConnectionScore=d,this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._videoFramesSentArray=[],this._isVideoUpStreamAnalysed=!0}},_setVideoDownStreamConnectionStatsData:function(){}};var AdhocCallBridge={},ZCMediaDomUtil={},ZCPIPManager={},ZCMediaDialogs={},ZCWMSEventSync={},ZCMediaNetworkPredictor={},ZCMediaNetworkPredictorImpl={},ZCMediaUtil={};class AVCliqDimensions{constructor(e=0,t=0,i=0,a=0){this.xAxis=e,this.yAxis=t,this.width=i,this.height=a,this.margin=0}clone(){return new AVCliqDimensions(this.xAxis,this.yAxis,this.width,this.height)}setMargin(e){this.resetMargin(),this.margin=e,this._updateMargin()}resetMargin(){this.margin=-this.margin,this._updateMargin(),this.margin=0}_updateMargin(){this.xAxis+=this.margin,this.yAxis+=this.margin,this.width-=2*this.margin,this.height-=2*this.margin}moveAxis(e=0,t=0){this.xAxis+=e,this.yAxis+=t}resetAxis(){this.xAxis=0,this.yAxis=0}alterMeasurements(e=0,t=0){this.width=e,this.height=t}fitWidthOnAspectRatio(e){var t=this.width,i=this.height,a=t*e;a>t&&(a=t),this.width=a,this.height=a/e,this.height>i&&(this.height=i),this.xAxis+=(t-a)/2,this.yAxis+=(i-this.height)/2}}AdhocCallBridge={attach:function(e){var t=e.getAssociatedConferenceId(),i=ZCSmartConferenceImpl.getCurrentActiveSession();i&&i.getId()===t&&(i.subscribe(AdhocOneToOneCallHandler),e.subscribe(AdhocConferenceHandler))},detach:function(e){var t=e.getAssociatedConferenceId(),i=ZCSmartConferenceImpl.getCurrentActiveSession();i&&i.getId()===t&&(i.unSubscribe(),e.unSubscribe())},publish:function(e,t,i){e.hasSubscribed()&&e.getSubscribedHandler()[t](e,i.associatedSessionId,i)}},ZCMediaDomUtil={openFullScreen:function(e,t,i){if(e){var a=function(){"function"==typeof t&&t(e),"function"==typeof i&&(void 0!==e.onfullscreenchange?e.onfullscreenchange=function(t){i(t,document.fullscreenElement===e)}:void 0!==e.onMSFullscreenChange?e.onMSFullscreenChange=function(t){i(t,document.msFullscreenElement===e)}:void 0!==e.onmozfullscreenchange?e.onmozfullscreenchange=function(t){i(t,document.mozFullScreenElement===e)}:void 0!==e.onwebkitfullscreenchange&&(e.onwebkitfullscreenchange=function(t){i(t,document.webkitFullscreenElement===e)}))},n=(e.requestFullscreen||e.msRequestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen).call(e);n?n.then(a):a()}},exitFullScreen:function(e,t){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){var i=(document.exitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen).call(document);"function"==typeof e&&(i?i.then(e):e())}else"function"==typeof t&&t()},getFullScreenElement:function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},placeCursorAtEnd:function(e){if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange(),i=window.getSelection();t.selectNodeContents(e),t.collapse(!1),i.removeAllRanges(),i.addRange(t)}else if(void 0!==document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}},limitInput:function(e){var t=$WC.Util.isEmpty(event)?void 0:event.which,i="TEXTAREA"===(e=ZCJQuery(e))[0].nodeName||"INPUT"===e[0].nodeName,a=i?e.val():e.text(),n=e.siblings("[category='charcount']"),o=n.attr("limit"),s=$WC.Util.isEmpty(t)||27!=t?o-a.length:o;n.html(s),n.toggleClass("zc-av-clr-R",s<10),s<0&&(i?e.val(a.substring(0,o)):e.text(a.substring(0,o)),this.placeCursorAtEnd(e[0]),n.html(0))},addLoadIcon:function(e){if(!e.find("[av_async_loading]").length){e.attr("style","pointer-events:none; text-decoration:none; color:transparent !important;");var t=(MediaUtil.isAVLibraryLoadedInChatbar()?"zc-av-":"")+"reqprocess_anim";e.prepend('<span av_async_loading class="'+t+'"></span>')}},removeLoadIcon:function(e){e.length&&(e.removeAttr("style"),e.find("[av_async_loading]").remove())}},ZCPIPManager=function(){const e={pipOverlay:'<div class="avcliq-pip-container flexM" id="avcliq-pip-overlay">\n\t\t\t\t\t\t<div class="flexM fdirC avcliq-pip-card">\n\t\t\t\t\t\t    <div class="avcliq-pip-icon zcf-pip"></div>\n\t\t\t\t\t\t    <div class="avcliq-pip-btn-cont">\n\t\t\t\t\t\t    \t{{content}}\n\t\t\t\t\t\t        <div class="zcl-btn-xs zcl-btn-neg--primary mL10" {{custom_attribute}} purpose="exitPIP">{{btn_text}}</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>'};var t=void 0,i=void 0;return{isSupported:a,getPIPOverlay:function(t){return $WC.template.replace(e.pipOverlay,{$content:"avcliq.media.pip.active",$btn_text:"common.close",custom_attribute:t})},toggleCamInPIP:function(e){document.pictureInPictureElement&&n()&&navigator.mediaSession.setCameraActive(!e)},toggleMicInPIP:function(e){document.pictureInPictureElement&&n()&&navigator.mediaSession.setMicrophoneActive(!e)},paintCanvasAndOpenPip:async function(e,i,n,r,c){if($canvasElem=ZCJQuery(e),!a()||!e||!$canvasElem.is("canvas"))return;e.width=i.width,e.height=i.height,function(e,i){try{if(t)return;var a=`var paintInCanvasTimer;\n\t\t\t\t\t\t\tonmessage = function(e) {\n\t\t\t\t\t\t\t\tif(e.data == 'start') {\n\t\t\t\t\t\t\t\t\tclearInterval(paintInCanvasTimer);\n\t\t\t\t\t\t\t\t\tpaintInCanvasTimer = setInterval(function(){ postMessage('start pip'); },${ZCMediaConstants.pip.paintInterval});\t\t//NO I18N\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if(e.data == 'stop') {\n\t\t\t\t\t\t\t\t\tclearInterval(paintInCanvasTimer);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}`,n=new Blob([a]),o=window.URL.createObjectURL(n);(t=new Worker(o)).onmessage=function(t){e()},t.postMessage("start")}catch(e){s(),"function"==typeof i&&i()}}((function(){n()}));const d=e.getVideoElement(ZCMediaConstants.pip.videoFps);d.muted=!0,await d.play(),o(d,r,c)},openPictureInPicture:o,exitPictureInPicture:function(e,t){if(!(e=e||i))return;if(!document.pictureInPictureEnabled&&!e.webkitSupportsPresentationMode)return;var a=function(){"function"==typeof t&&t()};s(),"function"==typeof document.exitPictureInPicture?document.pictureInPictureElement?document.exitPictureInPicture().then(a):a():void 0!==e&&"function"==typeof e.webkitSetPresentationMode&&"picture-in-picture"===e.webkitPresentationMode&&(e.webkitSetPresentationMode("inline"),a())}};function a(){return document.pictureInPictureEnabled&&$ZCUtil.Browser.isChrome()}function n(){return void 0!==navigator.mediaSession&&"function"==typeof navigator.mediaSession.setCameraActive}function o(e,t,o={}){var s=ZCJQuery(e);if(a()&&e&&s.is("video")&&document.pictureInPictureElement!==e){var r=function(){"function"==typeof t&&t(e)},c=function(e,t){n()&&("function"==typeof o.onCamToggle&&(navigator.mediaSession.setCameraActive(!o.isVideoMuted()),navigator.mediaSession.setActionHandler("togglecamera",t?function(e){var t=o.isVideoMuted();o.onCamToggle(t),navigator.mediaSession.setCameraActive(t)}:null)),"function"==typeof o.onMicToggle&&(navigator.mediaSession.setMicrophoneActive(!o.isAudioMuted()),navigator.mediaSession.setActionHandler("togglemicrophone",t?function(){var e=o.isAudioMuted();o.onMicToggle(e),navigator.mediaSession.setMicrophoneActive(e)}:null)),"function"==typeof o.onHangup&&navigator.mediaSession.setActionHandler("hangup",t?function(){o.onHangup(),navigator.mediaSession.setMicrophoneActive(!1),navigator.mediaSession.setCameraActive(!1)}:null)),"function"==typeof o.onChange&&o.onChange(e,t)},d=function(e){"function"==typeof o.onResize&&o.onResize(e)};"function"==typeof e.requestPictureInPicture?(s.one("enterpictureinpicture",(function(e){e.currentTarget.setPIP(),c(e,!0),i=e.originalEvent.pictureInPictureWindow,"function"==typeof o.onResize&&i.addEventListener("resize",d)})),s.one("leavepictureinpicture",(function(e){e.currentTarget.resetPIP(),void 0!==i&&i.removeEventListener("resize",d),c(e,!1),i=void 0})),e.requestPictureInPicture().then(r)):"function"==typeof e.webkitSetPresentationMode&&(e.onwebkitpresentationmodechanged=function(t){c(t,"picture-in-picture"===e.webkitPresentationMode)},e.webkitSetPresentationMode("picture-in-picture"),r())}}function s(){t&&(t.postMessage("stop"),t.terminate(),t.onmessage=void 0,t=void 0)}}(),ZCPIPUtil={_pipImageCache:{},_pipIconContent:{Web:{library:"\ue911",native:"\uea3f"},Mobile:{library:"\ue90f",native:"\ue983"}},showPIPOverlay:function(e,t){e.append(ZCPIPManager.getPIPOverlay(t))},removePIPOverlay:function(e){e.find("#avcliq-pip-overlay").remove()},paintBackground:function(e,t,i){e.fillStyle=t,e.fillRect(i.xAxis,i.yAxis,i.width,i.height)},getIconContent:function(e,t){var i=this._pipIconContent[e];return i?t?i.library:i.native:""},paintMainBackground:function(e,t){var i=e.canvas,a={radius:60,xAxis:i.width/2+10,yAxis:i.height/2+10},n={radius:300,xAxis:i.width/2,yAxis:i.height/2},o=e.createRadialGradient(a.xAxis,a.yAxis,a.radius,n.xAxis,n.yAxis,n.radius);o.addColorStop(1,"#246378"),o.addColorStop(0,"#1d2f4f"),this.paintBackground(e,o,t)},paintEachVideoInPIP:function(e,t,i,a){if(a.setMargin(2),this.paintBackground(e,"rgba(0,0,0,0.4)",a),i.muted)this.paintMutedVideoInPIP(e,i.name,a);else{var n=t.find("video")[0];a.fitWidthOnAspectRatio(n.getAspectRatio()),i.mirror?this.mirrorAndPaintVideo(e,n,a):e.drawImage(n,a.xAxis,a.yAxis,a.width,a.height)}},applyCanvasDimension:function(e,t){var i=e.canvas;t.width!==i.width&&(i.width=t.width),t.height!==i.height&&(i.height=t.height)},drawText:function(e,t,i,a={}){var n=e.measureText(t).width,o=a.maxWidth||e.canvas.width;if(n>o){var s=(n-o)/e.measureText(t[t.length-1]).width;t=t.slice(0,t.length-s-4)+"..."}e.font=a.font||"bold 24px Lato",e.textAlign=a.align||"start",e.fillStyle=a.color||"#FFF",e.textBaseline=a.baseline||"alphabetic",e.fillText(t,i.xAxis,i.yAxis)},drawCircle:function(e,t,i){e.beginPath(),e.arc(t.xAxis,t.yAxis,i,0,2*Math.PI),e.fillStyle="rgba(0,0,0,0.4)",e.fill(),e.lineWidth=6,e.strokeStyle="#f3a83b",e.stroke()},drawUserImage:function(e,t,i,a,n){this.drawCircle(e,a,n);var o=this._pipImageCache[t];if(o){if("loading"===o.state||"error"===o.state)return void this.drawText(e,i,a,{align:"center",baseline:"middle",maxWidth:2*n});this.drawCircularImage(e,o.img,a,n)}else{this.drawText(e,i,a,{align:"center",baseline:"middle",maxWidth:2*n});var s=new Image;s.crossOrigin="anonymous",fetch(this.getCorsImageUrl(t),{credentials:"include"}).then(e=>e.blob()).then(e=>{s.src=URL.createObjectURL(e),this._pipImageCache[t].img=s,this._pipImageCache[t].state="loaded"}),s.onload=()=>{URL.revokeObjectURL(s.src)},s.onerror=()=>{this._pipImageCache[t].state="error"},this._pipImageCache[t]={img:void 0,state:"loading"}}},drawCircularImage:function(e,t,i,a){e.save(),e.clip();var n,o,s=t.naturalWidth/t.naturalHeight;t.naturalWidth<t.naturalHeight?o=(n=2*a)/s:n=(o=2*a)*s,e.imageSmoothingEnabled=!0,e.drawImage(t,i.xAxis-n/2,i.yAxis-o/2,n,o),e.restore()},getCorsImageUrl:function(e){return MediaUtil.BRIDGE.Users.getImgUrlById(e,"original")+"&domain="+window.location.host},paintMutedVideoInPIP:function(e,t,i){this.paintBackground(e,"rgba(0,0,0,0.4)",i.clone());var a=new AVCliqDimensions(i.xAxis+i.width/2,i.yAxis+i.height/2);this.drawText(e,t,a,{align:"center"})},mirrorAndPaintVideo:function(e,t,i){e.save(),e.scale(-1,1),e.drawImage(t,-1*(i.xAxis+i.width),i.yAxis,i.width,i.height),e.restore()},drawRoundedCornerRectangle:function(e,t,i,a,n){i="number"==typeof i?{tl:i,tr:i,br:i,bl:i}:{tl:0,tr:0,br:0,bl:0,...i},e.beginPath(),e.moveTo(t.xAxis+i.tl,t.yAxis),e.lineTo(t.xAxis+t.width-i.tr,t.yAxis),e.quadraticCurveTo(t.xAxis+t.width,t.yAxis,t.xAxis+t.width,t.yAxis+i.tr),e.lineTo(t.xAxis+t.width,t.yAxis+t.height-i.br),e.quadraticCurveTo(t.xAxis+t.width,t.yAxis+t.height,t.xAxis+t.width-i.br,t.yAxis+t.height),e.lineTo(t.xAxis+i.bl,t.yAxis+t.height),e.quadraticCurveTo(t.xAxis,t.yAxis+t.height,t.xAxis,t.yAxis+t.height-i.bl),e.lineTo(t.xAxis,t.yAxis+i.tl),e.quadraticCurveTo(t.xAxis,t.yAxis,t.xAxis+i.tl,t.yAxis),e.closePath(),a&&(e.fillStyle=a,e.fill()),n&&(e.strokeStyle=n,e.stroke())}},ZCMediaDialogs={showUDPBlockedInfo:function(){if(!$WC.$Win.isExist("udp_blocked_info")){var e=void 0!==MediaUtil.BRIDGE?MediaUtil.BRIDGE.ServerConstants.AV_UDP_IP_WHITELISTING_DOC:$zcg._AV_UDP_IP_WHITELISTING_DOC,t=void 0!==MediaUtil.BRIDGE?MediaUtil.BRIDGE.Constants._cssClasses:$zcg._cssClasses;MediaUtil.createDialog({id:"udp_blocked_info",version:2,class:"zcdalogbx zcbg_mask alert_dialog zc-av-device-switch-popup",headerhtml:$WC.$Dlg.frameHeaderHTML({header:MediaUtil.getResource("avcliq.media.udp.blocked.header")}),bodyhtml:$WC.$Dlg.frameBodyInfoHTML({info:[MediaUtil.getResource("avcliq.media.udp.blocked.info",["zc-av-hyperlink",e])]}),buttons:[$WC.$Dlg.getButtonObj(MediaUtil.getResource("common.okgotit"),t.SECONDARY_BTN)]},!0)}}},ZCWMSEventSync={_receivedEventIds:[],pushEventId:function(e){1e3===this._receivedEventIds.length&&this._receivedEventIds.shift(),e&&this._receivedEventIds.push(e)},isDuplicateEvent:function(e){return e&&this._receivedEventIds.includes(e)}},(ZCMediaNetworkPredictor=function(e,t){this._id=e,this._updateUserNetworkCallback=t,this._predictionCallbackInterval=void 0,this._initialize()}).prototype={_initialize:function(){"function"==typeof this._updateUserNetworkCallback&&(clearInterval(this._predictionCallbackInterval),this._predictionCallbackInterval=setInterval(this.predictUserNetwork.bind(this),ZCMediaNetworkPredictorImpl.PREDICTION_INTERVAL),ZCMediaNetworkPredictorImpl.start(this._id))},predictUserNetwork:function(){var e=ZCMediaNetworkPredictorImpl.states.GOOD,t=ZCMediaNetworkPredictorImpl.getRecentHttpRequestRtt(),i=ZCMediaNetworkPredictorImpl.getCDNPollingRtt(),a={recentHttpReqRtt:t,CDNPollingRtt:i,WmsRtt:ZCMediaNetworkPredictorImpl.getWMSRtt()};i>ZCMediaNetworkPredictorImpl.CDN_RTT_MAX_THRESHOLD&&(e=ZCMediaNetworkPredictorImpl.states.POOR),this._updateUserNetworkCallback(e,a,this._id)},updateId:function(e){ZCMediaNetworkPredictorImpl.updateAssociatedId(this._id,e),this._id=e},stop:function(){clearInterval(this._predictionCallbackInterval),this._predictionCallbackInterval=void 0,ZCMediaNetworkPredictorImpl.stop(this._id)}},ZCMediaNetworkPredictorImpl=function(){var e={},t=[],i=[],a=[],n=void 0,o=void 0,s=void 0,r=void 0;return{NETWORK_RTT_MAX_THRESHOLD:800,CDN_RTT_MAX_THRESHOLD:500,WMS_RTT_MAX_THRESHOLD:500,PREDICTION_INTERVAL:5e3,POLLING_INTERVAL:5e3,CDN_RTT_POLLING_TIMEOUT:3e3,addHttpRequestInfo:function(e){e.status===MediaCallConstants.request.status.SUCCESS&&(3===t.length&&t.shift(),t.push({rtt:e.endTime-e.startTime}))},startCDNPolling:function(e,t){var a=new Date,o=void 0!==MediaUtil.BRIDGE?MediaUtil.BRIDGE.Constants.IMGDEFAULTSTATICURL:$zcg._IMGDEFAULTSTATICURL;fetch(o+"/av_network_prediction.png",{mode:"cors",cache:"no-store"}).then((function(t){200===t.status&&(n=new Date-a,i.push(n),"function"==typeof e&&e(n))})).catch((function(){"function"==typeof t&&t()}))},startWmsPingPongPolling:function(){if(void 0!==MediaUtil.BRIDGE&&"function"==typeof MediaUtil.BRIDGE.getWmsRtt&&MediaUtil.BRIDGE.isWMSConnected()){a.push(ZCMediaNetworkPredictorImpl.WMS_RTT_MAX_THRESHOLD);try{MediaUtil.BRIDGE.getWmsRtt((function(e){o=e,a.pop(),a.push(o)}))}catch(e){}}},getRecentHttpRequestRtt:function(){var e=t[t.length-1];return void 0!==e&&e.rtt},states:{GOOD:1,POOR:0},isPoorNetwork:function(e){return e===this.states.POOR},start:function(t){e[t]=t,void 0===s&&(s=setInterval(this.startPolling.bind(this),this.POLLING_INTERVAL),this.startPolling())},startPolling:function(){this.startWmsPingPongPolling(),this.startCDNPolling()},stop:function(r){delete e[r],0===Object.keys(e).length&&(clearInterval(s),s=void 0,t=[],i=[],a=[],n=void 0,o=void 0)},updateAssociatedId:function(t,i){delete e[t],e[i]=i},getCDNPollingRtt:function(){return n},getInitialCDNRtt:function(){return i.length?i[0]:0},getCurrentCDNRtt:function(e){var t=function(t){clearTimeout(r),e(t)};this.startCDNPolling(t,t),r=setTimeout((function(){t(ZCMediaNetworkPredictorImpl.CDN_RTT_POLLING_TIMEOUT)}),this.CDN_RTT_POLLING_TIMEOUT)},getWMSRtt:function(){return o},getAvgCdnRtt:function(){var e=i.length;if(e>0)return i.reduce((e,t)=>e+t,0)/e},getAvgWmsRtt:function(){var e=a.length;if(e>0)return a.reduce((e,t)=>e+t,0)/e}}}(),ZCMediaUtil={switchToAvailableTrackForTrackEnd:function(e,t,i,a,n={}){if(a&&i&&"audio"===t.kind){var o=i._getPrimaryAudioTrack();if(o&&o.id===t.id){var s=function(e){"function"==typeof n.successCB&&n.successCB(e,i)},r=function(){"function"==typeof n.failureCB&&n.failureCB()},c=function(e){if("function"==typeof n.hasCurrentSession&&n.hasCurrentSession()&&e&&e.name===WebRTCUserMedia.errors.OverconstrainedError&&"deviceId"===e.constraint){var t=function(){ZCMediaDevices.clearPreferredAudioInputDevice(),WebRTCUserMedia.requestAndReplaceTracksInStream(i,WebRTCUserMedia.streamTypes.AUDIO_ONLY,(function(e){s(e)}),r,void 0,void 0)};WebRTCUserMedia.getMediaDevices(t,t)}else r()},d=void 0;e&&e.currentTarget&&e.currentTarget.label&&(d=e.currentTarget.label);var l=a.getAudioTrackEndedInfo();d&&l&&l.trackLabel&&l.trackLabel===d&&l.time-MediaCall.BRIDGE.Util.getSyncedCurrentTime()>12e4?ZCMediaDevices.isDefaultDeviceId(i._getAudioDeviceId())?r():c({name:WebRTCUserMedia.errors.OverconstrainedError,constraint:"deviceId"}):WebRTCUserMedia.requestAndReplaceTracksInStream(i,WebRTCUserMedia.streamTypes.AUDIO_ONLY,s,c,void 0,void 0),a.setAudioTrackEndedInfo(d)}}}};var ZCMediaFeedback={};ZCMediaFeedback=function(){var e=[],t={},i=void 0,a={},n=void 0,o=0,s={id:void 0,type:void 0,creatorId:void 0},r={1:{typeClass:"zc-av-feedback-item_issue",emojiClass:"zc-av-smiley-anim-72-upset"},2:{typeClass:"zc-av-feedback-item_moderate",emojiClass:"zc-av-smiley-anim-72-neutral"},3:{typeClass:"zc-av-feedback-item_great",emojiClass:"zc-av-smiley-anim-72-love"}},c=3,d=1,l=2,h=3,u={1:"zcf-sound",2:"zcf-video",3:"zcf-sharescrn2"},v=[],m={},p=[],S={},C={container:'<div id="feedbackCon" class="zc-av-zcl-popup zc-av-zcl-popup-feedback zc-av-flex-col {{view_class}}">\n\t\t\t\t\t   <span purpose="close" class="zc-av-zcl-close zc-av-sm zcf-closeB zc-av-zindex1" title="{{close}}"></span>\n\t\t\t\t\t   <span purpose="goBack" class="zc-av-dN zc-av-feedback-back zc-av-zcl-close zc-av-sm zcf-leftArrow zc-av-zindex1" title="{{back}}"></span>\n\t\t\t\t\t   <div id="feedbackMain" class="zc-av-flexG zc-av-feedback-main zc-av-zcpseudo-bg zc-av-pattern-bg zc-av-flex-col">\n\t\t\t\t\t   \t  <div class="zc-av-fshrink zc-av-mB12">\n\t\t\t\t\t\t      <div class="zc-av-font17 zc-av-fontB">{{label}} {{type}}</div>\n\t\t\t\t\t\t      <div class="zc-av-line19 zc-av-font14 zc-av-clr-Sec zc-av-mT12">{{desc}}</div>\n\t\t\t\t\t\t      {{options}}\n\t\t\t\t\t      </div>\n\t\t\t\t\t      <div id="feedbackSubCon" class="zc-av-flexG zc-av-flex-col zc-av-ovrflwH zc-av-dN">{{sub_options}}</div>\n\t\t\t\t\t   </div>\n\t\t\t\t\t   <div class="zc-av-feeback-ftr zc-av-fshrink zc-av-footr-padding2 zc-av-flexC zc-av-justifyE">\n\t\t\t\t\t      <div purpose="cancel" class="zc-av-zcl-btn-sm zc-av-zcl-btn--secondary zc-av-mR20">{{cancel}}</div>\n\t\t\t\t\t      <div purpose="submit" id="submitBtn" class="zc-av-zcl-btn-sm zc-av-zcl-btn--primary" disabled>{{submit}}</div>\n\t\t\t\t\t   </div>\n\t\t\t\t\t</div>',emojihtml:'<div class="zc-av-flexM zc-av-fdirC zc-av-feedback-item zc-av-zcpseudo-bg {{TYPECLASS}}" rating="{{rating}}" purpose="selectRating">\n\t\t\t            <div class="zc-av-smiley-anim-72 {{EMOJICLASS}}"></div>\n\t\t\t            <div class="zc-av-feedback-item-label zc-av-font13">{{LABEL}}</div>\n\t\t\t            <span class="zc-av-feedback-tick zcf-tick zc-av-flexM"></span>\n\t\t\t         </div>',optiontitle:'<div class="zc-av-flexC zc-av-font15 {{MARGINTOP}}">\n\t\t\t\t\t\t<span class="zc-av-clr-icon2 {{ICON_CLASS}} zc-av-mR6"></span>\n\t\t\t\t\t\t{{LABEL}}\n\t\t\t\t\t  </div>',option:'<div class="zc-av-zcl-alert zc-av-zcl-alert-info zc-av-feedback-option zc-av-curP" category={{CATEGORY}} ID={{ID}} purpose="selectReason">\n\t\t\t\t\t{{LABEL}}\n\t\t\t\t\t<span class="zcf-tick zc-av-feedback-option-tick zc-av-font8 zc-av-mL4 zc-av-mT1"></span>\n\t\t\t\t </div>',attachment:'<span class="zcf-attach zc-av-clr-icon zc-av-fontB zc-av-feedback-attach-icon">\n\t\t\t\t\t\t<form id="feedbackUpload" type="html5" enctype="multipart/form-data">\n\t\t\t\t\t\t\t<input type="file" multiple name="file1" class="zc-av-feedback-sendfile zc-wh100" id="feedbackFile" />\n\t\t\t\t\t\t</form>\n\t\t\t\t\t  </span>',composer:'<div class="zc-av-feedback-composer zc-av-feedback-subcont zc-av-mT12 zc-av-flex-col zc-av-fshrink">\n\t\t\t\t\t   <textarea feedbackinput id="feedbackTextarea" class="zc-av-flexG zc-av-feedback-textarea" placeholder="{{placeholder}}" maxlength="4000"></textarea>\n\t\t\t\t\t   <div category="charcount" class="zc-av-limit-txt zc-av-dN" limit="4000">4000</div>\n\t\t\t\t\t   <div class="zc-av-flexC zc-av-mT5">\n\t\t\t\t\t      <div id="attachmentList" class="zc-av-flexG zc-av-flexC zc-av-gap10">\n\t\t\t\t\t      </div>\n\t\t\t\t\t      <div class="zc-av-fshrink zc-av-mLA zc-av-feedback-attach zc-av-posrel zc-av-alignselfE">\n\t\t\t\t\t         {{FILEUPLOAD}}\n\t\t\t\t\t         <div class="zc-av-feedback-tooltip">\n\t\t\t\t\t            <div>{{upload_files}}</div>\n\t\t\t\t\t            <div>{{size}}: {{limit}}</div>\n\t\t\t\t\t         </div>\n\t\t\t\t\t      </div>\n\t\t\t\t\t   </div>\n\t\t\t\t   </div>',successInfo:'<div id="feedback_success_info" class="zc-av-feedback-success-box zc-av-flexM zc-av-fdirC zc-vhcenter">\n\t\t\t\t<span purpose="closeSuccessInfo" class="zc-av-zcl-close zc-av-sm zcf-closeB zc-av-zindex1" title="{{close}}"></span>\n\t\t\t\t<div class="zc-av-zcl-img zcf-tick zc-av-xl zc-av-flexM zc-av-bg-success"></div>\n\t\t\t\t<div class="zc-av-font22 zc-av-fontB zc-av-mT24">{{header}}</div>\n    \t\t\t<div class="zc-av-font15 zc-av-mT14 zc-av-clrW-lite">{{desc}}</div>\n\t\t\t</div>'},_=e=>{var t="",i="";return p.forEach(a=>{if(a===d||a===l&&e&&e.video||a===h&&e&&e.screen){var n=S[a];t+=$WC.template.replace(C.optiontitle,{MARGINTOP:i,ICON_CLASS:n.iconclass,LABEL:n.label}),t+='<div class="zc-av-mT12 zc-av-flexC zc-av-gap10 zc-av-flexW">',n.options.forEach(e=>{t+=$WC.template.replace(C.option,{LABEL:e.label,ID:e.id,CATEGORY:n.id})}),t+="</div>",i="zc-av-mT16"}}),`<div id="feedbackoptioncon" class="zc-av-feedback-subcont zc-av-flexG zc-av-ovrflwA">${t}</div>`},f=()=>{var e=$WC.template.replace(C.composer,{FILEUPLOAD:C.attachment},"InSecureHTML");return $WC.template.replace(e,{$upload_files:"avcliq.common.files.upload",$size:"avcliq.feedback.file.size",limit:"10 MB",$placeholder:"avcliq.feedback.placeholder"})},g=()=>{var e="";return v.forEach(t=>{var i=m[t];e+=$WC.template.replace(C.emojihtml,{LABEL:i.label,TYPECLASS:r[i.type].typeClass,EMOJICLASS:r[i.type].emojiClass,rating:i.id})}),`<div id="feedbackEmojiCon" class="zc-av-feedback-emoji-con zc-av-flexM">${e}</div>`},T=(e,t)=>{if($WC.Matcher.check("imagemimetype",e.type)){var i=new FileReader;i.onload=function(i){var a='<img class="zc-av-zcl-img-elem" src="'+i.target.result+'" /><span id="close" class="zc-av-zcl-img-remove zcf-closeB" title="'+MediaUtil.getResource("avcliq.common.remove")+'"></span></div>';y(t,a,e.name,e)},i.readAsDataURL(e)}else{var a='<div class="zc-av-zcl-img_file zc-av-flexM"><span class="zc-av-zcl-img_filename zc-av-ellips">{FILETYPE}</span></div><span id="close" class="zc-av-zcl-img-remove zcf-closeB" title="'+MediaUtil.getResource("avcliq.common.remove")+'"></span>';y(t,a,e.name,e)}},y=(t,i,a,n)=>{var s=[n,a];e.push(s);var r=a.lastIndexOf(".")+1;if(-1!==r){var c=a.substring(r);i=i.replace(/{FILETYPE}/g,$WC.$CUtil.processXSS(c))}else i=i.replace(/{FILETYPE}/g,"");var d=$WC.template.replace('<div type="preview" name="{{file_name}}" class="zc-av-zcl-img zc-av-flexM">{{body}}</div>',{body:i},"InSecureHTML");d=$WC.template.replace(d,{file_name:a}),t.prepend(d),ZCJQuery("#close").on("click",(function(t){for(var i=ZCJQuery(this).parent(),a=i.attr("name"),n=e,s=n.length,r=0;r<s;r++)if(n[r][1]===a)return o-=n[r][0].size,e.splice(r,1),void i.remove()}))},I=e=>{var t=void 0;if(MediaUtil.isOneToOneCall(e)?t=ZCMediaConstants.settingKey.CALL_FEEDBACK:MediaUtil.isGroupCall(e)&&(t=ZCMediaConstants.settingKey.MEETING_FEEDBACK),t){var i={};i[t]=MediaUtil.BRIDGE.Util.getSyncedCurrentTime(),"undefined"!=typeof WmsImpl&&WmsImpl.isGuestConferenceUser()?Settings.updateInObj(i):MediaUtil.updateSettingsValue(i)}},k=o=>{var r={sessionKey:s.id,module:s.type,rating:n,creatorId:s.creatorId};if(m[n].type!=c){var d=i.find("#feedbackTextarea").val().trim();d.length>0&&(r.comment=d),e.length&&(r.files=e),r.reasons=Object.keys(t),"function"==typeof a.submitCallBack&&a.submitCallBack(a)}MediaAPI.submitFeedback(r,o,(function(){var e=a.container;if(I(s.type),b(),e)0===e.find("#feedback_success_info").length&&(e.addClass("zc-av-feedback-expanded"),e.append($WC.template.replace(C.successInfo,{$header:"avcliq.feedback.success.header",$desc:"avcliq.feedback.success.desc",$close:"avcliq.common.close"})),A(e.find("#feedback_success_info")));else{var t=MediaUtil.getResource("avcliq.feedback.success.header")+" "+MediaUtil.getResource("avcliq.feedback.success.desc");MediaUtil.updateBanner(t,2e3,!1)}}),(function(){}))},b=()=>{ZCJQuery("#feedbackCon").remove(),a.container&&a.container.removeClass("zc-av-feedback-expanded"),i=void 0,a={},s={},e=[],t={},n=void 0},R={selectRating:function(e){(e=>{if(!e.hasClass("zc-av-sel")){e.addClass("zc-av-sel").siblings().removeClass("zc-av-sel"),i.addClass("zc-av-feedback-choosed"),a.container&&a.container.addClass("zc-av-feedback-expanded"),i.find("#submitBtn").removeAttr("disabled");var t=i.find("#feedbackSubCon");n=e.attr("rating");var o=t.is(":visible"),s=m[n].type===c;if(t.toggleClass("zc-av-dN",s),void 0===a.container&&!o&&!s)void 0===MediaUtil.setContainerPosition(i,30,30).top&&i.css("top",i.offset().top),i.css("bottom","unset")}})(e)},selectReason:function(e){(e=>{var i=e.attr("id");e.hasClass("zc-av-sel")?(e.removeClass("zc-av-sel"),delete t[i]):(e.addClass("zc-av-sel"),t[i]=!0)})(e)},goBack:function(e){n=void 0,i.removeClass("zc-av-feedback-choosed"),a.container&&a.container.removeClass("zc-av-feedback-expanded"),i.find("#submitBtn").attr("disabled"),i.find("#feedbackSubCon").addClass("zc-av-dN"),i.find('[purpose="selectRating"]').removeClass("zc-av-sel")},submit:function(e){k(e)},closeSuccessInfo:function(){var e=ZCJQuery("#feedback_success_info"),t=e.parents(".zc-av-feedback-expanded");e.remove(),t.removeClass("zc-av-feedback-expanded")},close:function(e){I(s.type),b()},cancel:function(i){var a;Object.keys(t).length||e.length?(a=MediaUtil.getCssClassesConstants(),MediaUtil.createDialog({id:"closeFeedbackConfirmation",version:3,class:"zcl-alert-dialog-2 zcldel-dialog-box",headerhtml:$WC.$Dlg.frameHeaderHTML({imagehtml:'<div class="zc-av-zcl-img zc-av-xl zc-av-flexM zc-av-mAuto zcf-delete2 zc-av-zcl-img--neg"></div>',header:MediaUtil.getResource("avcliq.feedback.cancel.confirm"),subheader:[MediaUtil.getResource("avcliq.feedback.cancel.confirm.info")]}),bodyhtml:"",buttons:[$WC.$Dlg.getButtonObj("avcliq.common.go.back",a.SECONDARY_BTN),$WC.$Dlg.getButtonObj("avcliq.common.cancel",a.NEG_PRIMARY_BTN,(function(){b()}))]},!0)):b()}},A=e=>{e.on("click","[purpose]",e=>{var t=ZCJQuery(e.currentTarget),i=t.attr("purpose");R[i](t)})},P=e=>{A(i),i.on("keyup keydown focus","[feedbackinput]",e=>{ZCMediaDomUtil.limitInput(e.currentTarget)}),i.on("change","#feedbackFile",(function(){(e=>{var t=i.find("#attachmentList"),a=e.length;if(t.find('[type="preview"]').length+a>5)MediaUtil.updateBanner(MediaUtil.getResource("avcliq.feedback.error.fileslimit",[5]),2e3,!0);else{for(var n=0;n<a;n++){var s=e[n];if(o+s.size>10485760)return void MediaUtil.updateBanner(MediaUtil.getResource("avcliq.feedback.error.sizelimit"),2e3,!0);o+=s.size,T(s,t)}i.find("#feedbackUpload")[0].reset()}})(this.files)})),e.drag&&i.setAsDraggable({ondrag:function(e){i.css("bottom","unset")}})},D=(e,t,n,o)=>{if(void 0!==typeof MediaUtil.BRIDGE&&MediaUtil.BRIDGE.isMediaFeedbackEnabled()&&0!==v.length){b(),a=o;var r=((e,t)=>{var i="avcliq.module."+(MediaUtil.isOneToOneCall(e)?"call":"meeting"),a=$WC.template.replace(C.container,{options:g(),sub_options:_(t)+f()},"InSecureHTML");return $WC.template.replace(a,{view_class:t.miniView?"zc-av-feedback-minview zc-av-nite-mode":"",$label:"avcliq.feedback.label",$desc:"avcliq.feedback.desc",$cancel:"avcliq.common.cancel",$submit:"avcliq.common.submit",$close:"avcliq.common.close",$back:"common.go.back",$type:i})})(t,o);o.container?ZCJQuery(o.container).append(r):void 0!==MediaCall.BRIDGE&&"function"==typeof MediaCall.BRIDGE.handleBodyMount?MediaCall.BRIDGE.handleBodyMount(ZCJQuery(r)):ZCJQuery("body").append(r),s={type:t,id:e,creatorId:n},i=ZCJQuery("#feedbackCon"),P(o);var c={sessionKey:e,module:t,creatorId:n};MediaAPI.updateFeedbackShownTime(c)}};return{checkAndshow:(e,t,i,a)=>{var n=-1;if(MediaUtil.isOneToOneCall(t))n=MediaUtil.getSettingsValue(ZCMediaConstants.settingKey.CALL_FEEDBACK);else{if(!MediaUtil.isGroupCall(t))return;n=MediaUtil.getSettingsValue(ZCMediaConstants.settingKey.MEETING_FEEDBACK)}MediaUtil.BRIDGE.Util.getSyncedCurrentTime()-parseInt(n)<1728e6||D(e,t,i,a)},show:D,updateTemplateOptions:e=>{for(var t of e.reason_types)p.push(t.id),S[t.id]={id:t.id,label:t.label,iconclass:u[t.id],options:[]};for(var i of e.reasons){var a={id:i.id,label:i.label};S[i.type].options.push(a)}for(var n of e.ratings)v.push(n.id),m[n.id]={id:n.id,label:n.label,type:n.type}}}}();