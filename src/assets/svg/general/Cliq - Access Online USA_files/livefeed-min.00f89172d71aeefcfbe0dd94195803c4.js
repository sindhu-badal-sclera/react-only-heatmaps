var LiveFeedUI={},LiveFeedImpl={},LiveFeedAPI={},LiveFeedConstants={livePictureCaptureTimeInterval:1e3,livePictureCanvasHeight:200};LiveFeedUI={bindEvents:function(){var e=$(document);e.on("click","[livefeedbuttons]",(function(e){e.stopPropagation();var t=$(this),i=t.attr("purpose");LiveFeedHandler.UIEvents[i](e,t)})),e.on("change","[livefeedcheckbox]",(function(e){var t=$(this),i=t.attr("purpose");LiveFeedHandler.UIEvents[i](e,t)}))},_enabledAlertUIShown:!1,getIncomingFeedWrapper:function(e){return $("[incomingFeedWrapper][liveFeedId="+e+"]")},removeIncomingFeedWrapper:function(e){this.getIncomingFeedWrapper(e).remove()},setIncomingWrapperId:function(e,t){this.getIncomingFeedWrapper(e).attr("liveFeedId",t)},getOutgoingFeedWrapper:function(){return $("#outgoingFeedWrapper")},showOutgoingUI:function(e){if(0===this.getOutgoingFeedWrapper().length){var t=!0;RemoteWork.isLiveFeedEnabled()&&!e&&(t=!1,e=!0,this.showEnabledAlertUI()),$("#RW_band_livefeed").append(LiveFeedTemplates.getOutgoingWrapperHTML(e,t)),e&&void 0!==LiveFeedImpl._avUpStream&&!LiveFeed.isVideoFeedAsPictureEnabled()&&this.playOutgoingStream(LiveFeedImpl._avUpStream)}if(LiveFeedImpl.hasOutgoingFeedSession()){var i=LiveFeedImpl.getOutgoingFeedSession();LiveFeedUI.updateViewersContainer(i)}},setOutgoingUIStatus:function(e){var t=this.getOutgoingFeedWrapper();t.toggleClass("zc-vf-off",!e),t.find('[purpose="toggleFeedStatus"]').prop("checked",e);var i=RemoteWork.isLiveFeedEnabled()&&!e;t.find("[liveContainer]").toggleClass("hide",!i),t.find("[imageContainer]").toggleClass("hide",!i),e||($("#enabledAlertCnt").remove(),t.find("[currentFeedImage]").removeAttr("src"))},playOutgoingStream:function(e){var t=this.getOutgoingFeedWrapper(),i=t.find("video")[0];if(i){i.setStream(e),i.setOrientation(!0);var n=t.find("[loadingContainer]");n.removeClass("hide"),i.playStream((function(){n.addClass("hide")}))}},updateLivePictureForOutgoingFeed:function(e){this.getOutgoingFeedWrapper().find("[currentFeedImage]").attr("src",e)},drawLivePicture:function(e,t){return e.getContext("2d").drawImage(t,0,0,e.width,e.height),e.toDataURL("image/jpeg",.5).toString()},setIncommingImage:function(e,t){var i=this.getIncomingFeedWrapper(e);0!==i.length&&(i.find("[liveFeedImage]").attr("src",t),i.find("[feedloader]").addClass("hide"),LiveFeedUI.showRequestCallContainer(e))},playIncomingStream:function(e,t,i){var n=this.getIncomingFeedWrapper(e);if(0!==n.length){var s=n.find("video")[0];s.setStream(t),s.playStream((function(){n.find("[feedloader]").addClass("hide"),"function"==typeof i&&i()}))}},showIncomingFeedDisabledState:function(e){var t=e.getHost(),i=e.getId(),n=this.getIncomingFeedWrapper(i);n.html(LiveFeedTemplates.getFeedDisabledInfoHTML(t.getId(),t.getName())),n.addClass("zc-vf-disabled"),setTimeout((function(){n.remove()}),2e3)},showIncomingFeedWrapper:function(e){var t=e.getId(),i=this.getIncomingFeedWrapper(t);0===i.length&&($("body").append(LiveFeedTemplates.getIncomingWrapperHTML(t)),(i=this.getIncomingFeedWrapper(t)).setAsDraggable(),MediaUtil.setContainerPosition(i,10,10))},showRequestCallContainer:function(e){var t=this.getIncomingFeedWrapper(e);0!==t.length&&(0===t.find("[requestCallCnt]").length&&t.append(LiveFeedTemplates.getRequesToCallCntHTML()))},resetViewersContainer:function(){this.getOutgoingFeedWrapper().find("[viewersContainer]").addClass("hide").attr("title","")},updateViewersContainer:function(e){var t=e.getMemberIds().length-1,i=this.getOutgoingFeedWrapper().find("[viewersContainer]");i.toggleClass("hide",0===t);var n=[],s=e.getMembers();for(var d in s)if(d!==$zcg._ZUID){var o=s[d];n.push(o.getName())}i.attr("title",$Util.getTooltipTextForList(n))},setReconnectingState:function(e,t){var i=this.getIncomingFeedWrapper(e);if(0!==i.length){var n=i.find("[feedloader]");n.toggleClass("hide",!t);var s=t?"":Resource.getRealValue("videochat.message.reconnect");n.find("[loaderContent]").text(s)}},showEnabledAlertUI:function(){this._enabledAlertUIShown||(this._enabledAlertUIShown=!0,0===$("#enabledAlertCnt").length&&$("#remote_main_cnt").prepend(LiveFeedTemplates.getEnabledAlertCntHTML()))},showConsentAlertCnt:function(){if(!LiveFeedImpl.hasEnabledFeed())return RemoteWork.isCheckInAllowed()&&!RemoteWork.hasUserCheckedIn()?(LiveFeedUI.setOutgoingUIStatus(!1),void UI.updateBanner(Resource.getRealValue("livefeed.checkin.off"),2e3,!0)):void $WC.$Win.create({id:"liveFeedConsent",version:2,type:"popup",class:"modalwindow zcl-win-modal1 zcalgncntr zcbg_mask RW-lf-consentdlg",header:"",html:LiveFeedTemplates.getConsentHTML(),closefn:function(){LiveFeedImpl.hasEnabledFeed()||LiveFeedUI.setOutgoingUIStatus(!1)}})},handleResize:function(){}},LiveFeedImpl={_avUpStream:void 0,_feedEnabled:!1,sessionStates:{REQUESTED:"requested",INCOMING:"incoming",OUTGOING:"outgoing"},_outgoingFeedSession:void 0,_requestedFeedSessions:{},_incomingFeedSessions:{},hasEnabledFeed:function(){return this._feedEnabled},setFeedAsEnabled:function(){this._feedEnabled=!0},setFeedAsDisabled:function(){this._feedEnabled=!1},setOutgoingFeedSession:function(e){this._outgoingFeedSession=e},getOutgoingFeedSession:function(){return this._outgoingFeedSession},hasOutgoingFeedSession:function(){return void 0!==this._outgoingFeedSession},clearOutgoingFeedSession:function(){this._outgoingFeedSession=void 0},getRequestedFeedSessions:function(){return this._requestedFeedSessions},getRequestedFeedSession:function(e){return this._requestedFeedSessions[e]},addInRequestedFeedSession:function(e,t){this._requestedFeedSessions[e]=t},removeFromRequestedFeedSession:function(e){delete this._requestedFeedSessions[e]},getIncomingFeedSessions:function(){return this._incomingFeedSessions},getIncomingFeedSession:function(e){return this._incomingFeedSessions[e]},getIncomingFeedSessionByHostId:function(e){var t=this._incomingFeedSessions;for(var i in t){var n=t[i];if(n.getHostId()===e)return n}},addInIncomingFeedSession:function(e,t){this._incomingFeedSessions[e]=t},removeFromIncomingFeedSession:function(e){delete this._incomingFeedSessions[e]},init:function(){LiveFeedUI.bindEvents()},enableFeed:function(){if(!this.hasEnabledFeed()&&!RemoteWork.isLiveFeedEnabled()){LiveFeedImpl.setFeedAsEnabled();var e=function(){LiveFeedImpl.setFeedAsDisabled(),LiveFeedUI.setOutgoingUIStatus(!1),void 0!==LiveFeedImpl._avUpStream&&(WebRTCUserMedia.closeStreamInstance(WebRTCUserMedia.streamInstanceIds.livefeed_video,LiveFeedImpl._avUpStream._getType()),LiveFeedImpl._avUpStream=void 0)},t=function(t){if(LiveFeedImpl._avUpStream=t,LiveFeedImpl.hasEnabledFeed()){RemoteWork.trackAction("Live Feed Enabled");LiveFeedAPI.initiate((function(e){var t=new LiveFeedSession(e);t.setSessionState(LiveFeedImpl.sessionStates.OUTGOING),t.getHost().setClientSupport(MediaManager.getClientSupport()),t.setAVUpStream(LiveFeedImpl._avUpStream),t.setTurnCredentials(e.credentials),LiveFeed.isVideoFeedAsPictureEnabled()&&t.initLiveFeedAsPicture(),LiveFeedUI.setOutgoingUIStatus(!0),LiveFeedImpl.setOutgoingFeedSession(t)}),e)}else e()}.bind(this);this._accessVideoFeed(t,(function(e,t){LiveFeedImpl.setFeedAsDisabled(),LiveFeedUI.setOutgoingUIStatus(!1),void 0!==e&&MediaManager.handleMediaError(e,t)}))}},_accessVideoFeed:function(e,t){var i=WebRTCUserMedia.streamTypes.VIDEO_ONLY;MediaManager.setAsStreamRequested(i);var n=MLBackgroundProcessor.isEnabledForLiveFeed()?{background:{type:"blur"}}:void 0;WebRTCUserMedia.requestNewStreamInstance(WebRTCUserMedia.streamInstanceIds.livefeed_video,i,(function(t){MediaManager.resetStreamRequested(),MLBackgroundProcessor.isEnabledForLiveFeed()?MLBackgroundProcessor.enableVirtualBackground($Util.getSolidColorImageUrl(200,200,"#FFFFFF"),t,!1,(function(){e(t)})):e(t)}),(function(e,i){MediaManager.resetStreamRequested(),t(e,i)}),void 0,n)},applyStreamConstraints:function(e){},requestFeed:function(e){if(void 0===this.getIncomingFeedSessionByHostId(e)&&void 0===this.getRequestedFeedSession(e)){var t=this.getIncomingFeedSessions();for(var i in t)LiveFeedImpl.disConnectFeed(t[i].getHostId());var n=this.getRequestedFeedSessions();for(var s in n)LiveFeedImpl.disConnectFeed(s);var d=new LiveFeedSession({id:e,host:{id:e}}),o=new LiveFeedMember($zcg._ZUID,Users.getName($zcg._ZUID));o.setClientSupport(MediaManager.getClientSupport()),d.addMember(o),d.setSessionState(LiveFeedImpl.sessionStates.REQUESTED),this.addInRequestedFeedSession(e,d),LiveFeedUI.showIncomingFeedWrapper(d);LiveFeedAPI.request(e,o.getClientSupport(),(function(t){var i=LiveFeedImpl.getRequestedFeedSession(e);i.setTurnCredentials(t.credentials),i.setRequestTimeout(),i.getHost(t.host.id).setName(t.host.name)}),(function(t){if(void 0!==t&&t.code===LiveFeedAPI.errorCodes.LIVE_FEED_DISABLED){var i=LiveFeedImpl.getRequestedFeedSession(e);void 0!==i&&LiveFeedUI.showIncomingFeedDisabledState(i)}else LiveFeedUI.removeIncomingFeedWrapper(e);LiveFeedImpl.removeFromRequestedFeedSession(e)}))}},handleFeedUnavailable:function(e){LiveFeedAPI.checkAvailablity(e),LiveFeedImpl.disConnectFeed(e)},disConnectFeed:function(e){var t;void 0!==(t=LiveFeedImpl.getIncomingFeedSessionByHostId(e))?(t.terminate(),LiveFeedAPI.disconnect(t.getId(),e),LiveFeedImpl.removeFromIncomingFeedSession(t.getId()),LiveFeedUI.removeIncomingFeedWrapper(t.getId())):void 0!==(t=LiveFeedImpl.getRequestedFeedSession(e))&&(t.terminate(),LiveFeedImpl.removeFromRequestedFeedSession(e),LiveFeedUI.removeIncomingFeedWrapper(t.getId()))},disableFeed:function(e){LiveFeedImpl.setFeedAsDisabled(),LiveFeedUI.resetViewersContainer();var t=LiveFeedImpl.getOutgoingFeedSession();t&&(e&&(LiveFeedAPI.disable(t.getId(),t.getMemberIds()),RemoteWork.setLiveFeedStatus("disabled"),RemoteWork.trackAction("Live Feed Disabled")),t.terminate(),this.clearOutgoingFeedSession()),LiveFeedUI.setOutgoingUIStatus(!1),void 0!==this._avUpStream&&(WebRTCUserMedia.closeStreamInstance(WebRTCUserMedia.streamInstanceIds.livefeed_video,this._avUpStream._getType()),this._avUpStream=void 0)},disableFeeds:function(){this.disableFeed(!1),LiveFeedAPI.disableFeeds(),RemoteWork.setLiveFeedStatus("disabled")},disConnectAllRequestedFeedSessions:function(){var e=this.getRequestedFeedSessions();for(var t in e){var i=e[t];this.disConnectFeed(i.getHostId())}},disConnectAllIncomingFeedSessions:function(){var e=this.getRequestedFeedSessions();for(var t in e){var i=e[t];this.disConnectFeed(i.getHostId())}},handleUnload:function(){this.disableFeed(!0),this.disConnectAllRequestedFeedSessions(),this.disConnectAllIncomingFeedSessions()}},LiveFeedAPI={errorCodes:{LIVE_FEED_DISABLED:"live_feed_disabled"},initiate:function(e,t){var i={};i.session_id=WmsImpl.getSid(),$ZCAjx.ajax({url:"/v2/livefeeds",type:"POST",contentType:"application/json",headers:i,data:{type:LiveFeed.types.VIDEO},success:function(t){e(t)},error:function(){t()}})},checkAvailablity:function(e){$ZCAjx.ajax({url:"/v2/users/"+e+"/checkfeedavailablity",type:"POST",contentType:"application/json"})},sendActiveStatus:function(e){$ZCAjx.ajax({url:"/v2/livefeeds/active",type:"PUT",contentType:"application/json"})},request:function(e,t,i,n){$ZCAjx.ajax({url:"/v2/users/"+e+"/livefeed",type:"POST",contentType:"application/json",status:{error:"livefeed.forbidden"},data:{client_support:t},success:function(e){i(e)},error:function(e){n(e)}})},sendOfferSdp:function(e,t,i,n,s,d,o,a,r){var c={answerer_id:t,description:i,connection_state:n,tracks_media_id:s,client_time:$Util.getSyncedCurrentTime()};void 0!==d&&(c.client_support=d),void 0!==o&&o>0&&(c.reconnection_id=o),$ZCAjx.ajax({url:"/v2/livefeeds/"+e+"/sendoffersdp",type:"PUT",contentType:"application/json",data:c,success:function(e){"function"==typeof a&&a(e)},error:function(e){"function"==typeof r&&r(e)}})},sendAnswerSdp:function(e,t,i,n,s,d,o,a,r){var c={offerer_id:t,description:i,connection_state:n,tracks_media_id:s,client_time:$Util.getSyncedCurrentTime()};void 0!==d&&(c.client_support=d),void 0!==o&&o>0&&(c.reconnection_id=o),$ZCAjx.ajax({url:"/v2/livefeeds/"+e+"/sendanswersdp",type:"PUT",contentType:"application/json",data:c,success:function(e){"function"==typeof a&&a(e)},error:function(e){"function"==typeof r&&r(e)}})},updateIceCandidates:function(e,t,i,n,s,d){if(n.length){var o={ice_candidates:n,connection_state:s,client_time:$Util.getSyncedCurrentTime()};i?o.answerer_id=t:o.offerer_id=t,void 0!==d&&d>0&&(o.reconnection_id=d),$ZCAjx.ajax({url:"/v2/livefeeds/"+e+"/icecandidate",type:"PUT",contentType:"application/json",data:o})}},disconnect:function(e,t){var i={user_id:t};$ZCAjx.ajax({url:"/v2/livefeeds/"+e+"/disconnect",type:"POST",contentType:"application/json",data:i})},disable:function(e,t){var i={};i.session_id=WmsImpl.getSid();var n={user_ids:t};$ZCAjx.ajax({url:"/v2/livefeeds/"+e,type:"DELETE",contentType:"application/json",headers:i,data:n})},disableFeeds:function(){$ZCAjx.ajax({url:"/v2/livefeeds/disable",type:"POST",contentType:"application/json"})}};var LiveFeedTemplates={};LiveFeedTemplates=function(){var e={outgoingWrapper:'<div id="outgoingFeedWrapper" class="zc-vf-prev-cnt {{feed_status_class}}">{{live_cnt}}{{viewers_cnt}}{{toggle_status_cnt}}<img class="wh100 posa {{img_class}}" src="{{img_src}}" imageContainer><span class="img-prv-ldng hide" loadingContainer></span><img class="zc-vf-video {{feed_class}}" currentFeedImage></img>{{feed_off_cnt}}</div>',liveCnt:'<div class="zc-vf-liveinfo flexC {{hide_class}}" liveContainer><span class="live-red"></span><span class="clr-R text-transU font10">{{content}}<span></div>',viewersCnt:'<span class="zc-vf-viewers flexM hide" viewersContainer><em class="zcf-visible zc-vf-viewersicon clr-R"></em></span>',toggleStatusCnt:'<div class="zc-vf-switch-cnt flexM"><label class="zcl-switch zcl-switch-sm no-icon mT4"><input type="checkbox" {{checked}} livefeedcheckbox purpose="toggleFeedStatus"><span class="slider"></span><em class="switch"></em></label></div>',feedOffCnt:'<span class="zc-vf-off-cnt flexM"><em class="zcf-livefeed font24"></em></span>',incomingWrapper:'<div liveFeedId="{{id}}" incomingFeedWrapper class="zc-vf-wrapper"><em class="zc-vf-close zcf-closeB" livefeedbuttons purpose="disconnectFeed"></em>{{loader_cnt}}<img class="zc-vf-video bdrR100 objFitCover dN" liveFeedImage></img></div>',loader:'<div class="zc-vf-loader flexM" feedloader><span class="zcl-rloader sm"></span><div class="font14 mT5" loaderContent>{{content}}</div></div>',feedDisabledCnt:'<div class="zc-vf-disabled-cnt bdrR100"><div class="zc-vf-title ellips mT25">{{user_name}}</div>{{img_cnt}}</div>',userImgCnt:'<div class="zc-vf-img-cnt"><img src="{{user_img}}"><div class="font15 mT8">{{content}}</div></div>',requestCallCnt:'<div class="zc-vf-btns flexM w100" requestCallCnt><div class="zcl-btn-xs zcl-btn--primary mB20 vsbH req-to-speak-btn" livefeedbuttons purpose="requestCall">{{request}}</div><div class="flexC flex-col hide" livefeedbuttons purpose="cancelCallRequest"><div class="font13 bold" content>{{cancel}}</div><div class="zcl-icon zcf-closeB zc-vf-cancel-btn mT12"></div></div></div>',enabledAlertCnt:'<div id="enabledAlertCnt" class="RW-chkin-bnr flexC justifySB w100 fshrink"><div class="flexG">{{content}}</div><div class="fshrink flexC"><div class="fshrink RW-dontshow" livefeedbuttons purpose="closeEnabledAlert">{{dontshow_content}}</div><div class="mL30 zcf-closeB zcl-icon-sm zcl-round" livefeedbuttons purpose="closeEnabledAlert"></div></div></div>',consentCnt:'<div class="mcontent zcrchmcnt"><div class="zcl-win-modal1-hdr fshrink zc-vf-win-modal"><div class="w100 justifySB flexC"><div class="flexM fdirC"><div class="feed-icn flexM font25"><span class="zcf-livefeed"></span></div><div class="mT15 line24 font16 clr-M">{{info}}</div></div></div><span id="winclose" class="zcf-closeB zcl-icon-lg fshrink zcl-icon--plain zcl-round font12"></span></div><div class="zc-vf-win-dlg-cnt"><div class="zc-vf-win-dlg"><div class="consentdlg-info"><div class="font14 line22 clr-M">{{note}}</div></div></div><div class="fshrink flexC justifyE"><div class="zcl-btn zcl-btn--secondary mR20" livefeedbuttons purpose="closeConsent">{{cancel}}</div><div class="zcl-btn zcl-btn--primary fontB" livefeedbuttons purpose="enableFeedFromConsent">{{turn_on}}</div></div></div></div>'},t=function(t){return $WC.template.replace(e.liveCnt,{hide_class:t?"hide":"",$content:"common.live"})},i=function(t){return $WC.template.replace(e.toggleStatusCnt,{checked:t?"checked":""})},n=function(t,i){return $WC.template.replace(e.userImgCnt,{user_img:Users.getImgUrlById(t),content:i})},s=function(){var e=parseInt(SecurityManager.getModuleConfig(Modules.LiveFeed,MConfigs.LiveFeedViewers)),t="",i=[];return 1&e?t=Resource.getRealValue("livefeed.allemployee"):(2&e&&i.push(Resource.getRealValue("livefeed.org_admins")),4&e&&i.push(Resource.getRealValue("livefeed.department_members",$Util._getCustomFieldName("department")||Resource.getRealValue("common.departmentname"))),8&e&&i.push(Resource.getRealValue("livefeed.immediate_lead")),16&e&&i.push(Resource.getRealValue("livefeed.department_head",$Util._getCustomFieldName("department")||Resource.getRealValue("common.departmentname"))),t=i.length?"Your "+i.join(","):"Allowed members"),t};return{getOutgoingWrapperHTML:function(n,s){return $WC.template.replace(e.outgoingWrapper,{feed_status_class:n?"":"zc-vf-off",img_class:s?"hide":"",feed_class:s?"":"hide",img_src:Users.getImgUrlById($zcg._ZUID),live_cnt:t(s),viewers_cnt:e.viewersCnt,toggle_status_cnt:i(n),feed_off_cnt:e.feedOffCnt},"InSecureHTML")},getIncomingWrapperHTML:function(t){var i,n=$WC.template.replace(e.incomingWrapper,{loader_cnt:(i=Resource.getRealValue("common.loading"),$WC.template.replace(e.loader,{content:i}))},"InSecureHTML");return $WC.template.replace(n,{id:t})},getFeedDisabledInfoHTML:function(t,i){var s=$WC.template.replace(e.feedDisabledCnt,{img_cnt:n(t,Resource.getRealValue("livefeed.disabled"))},"InSecureHTML");return $WC.template.replace(s,{user_name:Users.getName(t,i)})},getRequesToCallCntHTML:function(){var t="";return MediaCall.isVideoCallAllowed()&&(t=$WC.template.replace(e.requestCallCnt,{$request:"primetime.speaker.request",$cancel:"common.cancel",$retry:"message.option.retry"})),t},getEnabledAlertCntHTML:function(){return $WC.template.replace(e.enabledAlertCnt,{$content:"livefeed.enabled.alert",$dontshow_content:"announcement.close"})},getConsentHTML:function(){var t=s();return $WC.template.replace(e.consentCnt,{$info:["livefeed.consent.info",t],$note:"livefeed.consent.note",$cancel:"common.cancel",$turn_on:"common.turn.on"})}}}();var LiveFeedHandler={};LiveFeedHandler={peerConnectionEvents:{sendOffer:function(e,t,i,n,s,d){var o=LiveFeedImpl.getOutgoingFeedSession();o&&o.getId()===e&&LiveFeedAPI.sendOfferSdp(e,t,i,n,d,o.getCurrentMember().getClientSupport(),s,void 0,void 0)},sendAnswer:function(e,t,i,n,s,d){var o=LiveFeedImpl.getIncomingFeedSession(e);o&&LiveFeedAPI.sendAnswerSdp(e,t,i,n,d,o.getCurrentMember().getClientSupport(),s,void 0,void 0)},updateIceCandidates:function(e,t,i,n,s,d){var o=LiveFeedImpl.getOutgoingFeedSession();o&&o.getId()===e?LiveFeedAPI.updateIceCandidates(e,i,!0,n,s,d):LiveFeedImpl.getIncomingFeedSession(e)&&LiveFeedAPI.updateIceCandidates(e,t,!1,n,s,d)},handleReconnect:function(e,t,i,n,s){var d=LiveFeedImpl.getOutgoingFeedSession();if(d&&d.getId()===e)d.getMember(s).handleReconnect(t);else{var o=LiveFeedImpl.getIncomingFeedSession(e);o&&LiveFeedUI.setReconnectingState(o.getId(),!1)}},handleReinit:function(e,t,i){},handleRenegotiate:function(e,t,i){},handleTrack:function(e,t,i){void 0!==LiveFeedImpl.getIncomingFeedSession(e)&&LiveFeedUI.playIncomingStream(e,i[0],(function(){LiveFeedUI.showRequestCallContainer(e)}))},handleIncommingDataChannel:function(e){var t=LiveFeedUI.getIncomingFeedWrapper(e);t.find("video").addClass("dN"),t.find("[liveFeedImage]").removeClass("dN")},handleReceive:function(e,t){void 0!==LiveFeedImpl.getIncomingFeedSession(e)&&LiveFeedUI.setIncommingImage(e,t)},handleDisconnected:function(e,t){},handleFailed:function(e,t){},handleConnected:function(e,t,i,n){var s=LiveFeedImpl.getIncomingFeedSession(e);s&&LiveFeedUI.setReconnectingState(s.getId(),!0)},handleClosed:function(e,t,i){var n=LiveFeedImpl.getOutgoingFeedSession();n&&n.getId()===e?(n.getMember(i).closeConnection(),n.removeMember(i),LiveFeedUI.updateViewersContainer(n)):LiveFeedImpl.getIncomingFeedSession(e)&&LiveFeedImpl.disConnectFeed(liveFeedSession.getHostId())}},wmsEvents:{requestFeed:function(e){var t=LiveFeedImpl.getOutgoingFeedSession();if(t){var i=new LiveFeedMember(e.userId,e.userName,t.getId());t.addMember(i),i.initConnection(t.getHostId(),t.getTurnCredentials(),t.getAVUpStream())}},checkFeedAvailablity:function(e){var t=LiveFeedImpl.getOutgoingFeedSession();t&&LiveFeedAPI.sendActiveStatus(t.getId())},handleOfferSdp:function(e){var t=LiveFeedImpl.getIncomingFeedSession(e.id),i=void 0;if(void 0!==t)i=t.getCurrentMember();else{var n=LiveFeedImpl.getRequestedFeedSession(e.offererId);void 0!==n&&(n.clearRequestTimeout(),LiveFeedUI.setIncomingWrapperId(n.getId(),e.id),n.setId(e.id),LiveFeedImpl.addInIncomingFeedSession(e.id,n),LiveFeedImpl.removeFromRequestedFeedSession(e.offererId),(i=n.getCurrentMember()).setLiveFeedId(e.id),t=n)}void 0!==i&&i.connectConnection(e.offererId,JSON.parse(e.offerSdp),t.getTurnCredentials())},handleAnswerSdp:function(e){var t=LiveFeedImpl.getOutgoingFeedSession();t&&t.getId()===e.id&&(t.getMember(e.answererId).storeAndSetRemoteSdp(JSON.parse(e.answerSdp)),LiveFeedUI.updateViewersContainer(t))},handleOffererIceCandidates:function(e){var t=LiveFeedImpl.getIncomingFeedSession(e.id),i=void 0;if(void 0!==t)i=t.getCurrentMember();else{var n=LiveFeedImpl.getRequestedFeedSession(e.offererId);void 0!==n&&(n.clearRequestTimeout(),LiveFeedUI.setIncomingWrapperId(n.getId(),e.id),n.setId(e.id),LiveFeedImpl.addInIncomingFeedSession(e.id,n),LiveFeedImpl.removeFromRequestedFeedSession(e.offererId),(i=n.getCurrentMember()).setLiveFeedId(e.id))}void 0!==i&&i.storeAndSetRemoteIceCandidates(JSON.parse(e.iceCandidates))},handleAnswererIceCandidates:function(e){var t=LiveFeedImpl.getOutgoingFeedSession();t&&t.getId()===e.id&&t.getMember(e.answererId).storeAndSetRemoteIceCandidates(JSON.parse(e.iceCandidates))},disconnectFeed:function(e){var t=LiveFeedImpl.getOutgoingFeedSession();t&&t.getId()===e.id&&(t.getMember(e.viewerId).closeConnection(),t.removeMember(e.viewerId),LiveFeedUI.updateViewersContainer(t))},feedDisabled:function(e){var t=LiveFeedImpl.getIncomingFeedSession(e.id);if(void 0!==t)LiveFeedUI.showIncomingFeedDisabledState(t),t.terminate(),LiveFeedImpl.removeFromIncomingFeedSession(e.id);else{var i=LiveFeedImpl.getRequestedFeedSession(e.hostId);void 0!==i&&(LiveFeedUI.showIncomingFeedDisabledState(i),i.terminate(),LiveFeedImpl.removeFromRequestedFeedSession(e.hostId))}},feedDisabledAsStale:function(e){LiveFeed.disableFeeds()},feedEnabled:function(e){LiveFeedImpl.getOutgoingFeedSession()&&WmsImpl.getSid()!==e.sessionId&&(RemoteWork.setLiveFeedStatus("enabled"),LiveFeed.disableFeed(!1))},disableFeeds:function(e){WmsImpl.getSid()!==e.sessionId&&(RemoteWork.setLiveFeedStatus("disabled"),LiveFeed.disableFeed(!1))}},UIEvents:{toggleFeedStatus:function(e,t){t.is(":checked")?LiveFeedUI.showConsentAlertCnt():LiveFeedImpl.hasOutgoingFeedSession()?LiveFeed.disableFeed(!0):LiveFeed.disableFeeds()},disconnectFeed:function(e,t){var i=t.parents("[liveFeedId]").attr("liveFeedId");LiveFeedUI.removeIncomingFeedWrapper(i);var n=LiveFeedImpl.getIncomingFeedSession(i),s=void 0!==n?n.getHostId():i;LiveFeedImpl.disConnectFeed(s)},enableFeedFromConsent:function(e,t){$WC.$Win.destroy("liveFeedConsent"),MLBackgroundProcessor.isEnabledForLiveFeed()?MLBackgroundProcessor.initialize(()=>{LiveFeed.enableFeed()}):LiveFeed.enableFeed()},closeConsent:function(e,t){LiveFeedImpl.hasEnabledFeed()||LiveFeedUI.setOutgoingUIStatus(!1),$WC.$Win.destroy("liveFeedConsent")},requestCall:function(e,t){var i=t.parents("[liveFeedId]").attr("liveFeedId"),n=LiveFeedImpl.getIncomingFeedSession(i);if(void 0!==n){var s=LiveFeedUI.getIncomingFeedWrapper(i);s.find('[purpose="requestCall"]').addClass("hide"),s.find('[purpose="cancelCallRequest"]').removeClass("hide"),MediaCall.convertLiveFeedToCall(MediaCallConstants.types.VIDEO,n.getHostId(),void 0,ZCMediaConstants.triggerSource.LIVE_FEED,n.getId())}},cancelCallRequest:function(e,t){var i=t.parents("[liveFeedId]").attr("liveFeedId"),n=LiveFeedImpl.getIncomingFeedSession(i);if(void 0!==n){var s=LiveFeedUI.getIncomingFeedWrapper(i);s.find('[purpose="cancelCallRequest"]').addClass("hide"),s.find('[purpose="requestCall"]').removeClass("hide"),MediaCallImpl.handleEnd(n.getAssociatedCallId(),!0)}},closeEnabledAlert:function(e,t){$("#enabledAlertCnt").remove()}},callEvents:{handlEnd:function(e){var t=e.getAssociatedLiveFeedId();if(void 0!==LiveFeedImpl.getIncomingFeedSession(t)){var i=LiveFeedUI.getIncomingFeedWrapper(t);i.find('[purpose="cancelCallRequest"]').addClass("hide"),i.find('[purpose="requestCall"]').removeClass("hide")}},adaptUIToState:function(e,t){var i=e.getAssociatedLiveFeedId(),n=LiveFeedImpl.getIncomingFeedSession(i),s=LiveFeedUI.getIncomingFeedWrapper(i);if(void 0!==n){var d=void 0;if(t===MediaCallConstants.states.WAITING_FOR_PERMISSION)d="avcliq.media.permission.state.prompt";else if(t===MediaCallConstants.states.INITIATING)d="mediacall.state.initiating";else if(t===MediaCallConstants.states.CALLING)d="videochat.message.calling";else if(t===MediaCallConstants.states.RINGING)d="videochat.message.ringing";else if(t===MediaCallConstants.states.CONNECTING){var o=MediaCallUI.getMediaCallWrapper(e.getId()),a=s.position();if(LiveFeedUI.removeIncomingFeedWrapper(i),LiveFeedImpl.disConnectFeed(n.getHostId()),o.removeClass("AV-call-live-feed"),MediaCallUI.isInDetachedView(o)){var r=o.parent();r.css(a),MediaCallUI.adjustCallContainerHeight(o),MediaUtil.setContainerPosition(r,MediaCallUI.DETACHED_CONTAINER_ADJUST_WIDTH,MediaCallUI.DETACHED_CONTAINER_ADJUST_WIDTH)}}void 0!==d&&s.find('[purpose="cancelCallRequest"] [content]').text(Resource.getRealValue(d))}}}};var LiveFeedSession=function(e){this._id=e.id,this._type=e.type,this._startTime=e.start_time,this._hostId=e.host.id,this._sessionState=void 0,this._avUpStream=void 0,this._turnCredentials={},this._members={},this._members[this._hostId]=new LiveFeedMember(this._hostId,e.host.name,this._id),this._associatedCallId=void 0,this._requestFeedTimeout=void 0,this._livePictureCaptureTimeout=void 0,this._livePictureCanvasElem=void 0,this._liveFeedVideoElem=void 0,this._lastActiveFeedImage=void 0};LiveFeedSession.prototype={getId:function(){return this._id},getType:function(){return this._type},getHostId:function(){return this._hostId},getMember:function(e){return this._members[e]},getHost:function(){return this._members[this.getHostId()]},getCurrentMember:function(){return this._members[$zcg._ZUID]},getAVUpStream:function(){return this._avUpStream},getTurnCredentials:function(){return this._turnCredentials},getMembers:function(){return this._members},getMemberIds:function(){return Object.keys(this.getMembers())},getAssociatedCallId:function(){return this._associatedCallId},setAssociatedCallId:function(e){this._associatedCallId=e},setId:function(e){this._id=e},setSessionState:function(e){this._sessionState=e},setAVUpStream:function(e){this._avUpStream=e},setTurnCredentials:function(e){void 0!==e&&(this._turnCredentials=e)},setRequestTimeout:function(){clearTimeout(this._requestFeedTimeout),this._requestFeedTimeout=setTimeout(function(){LiveFeedImpl.handleFeedUnavailable(this.getHostId())}.bind(this),15e3)},initLiveFeedAsPicture:function(){var e=this._avUpStream._getVideoSize(),t=e.width/e.height;this._livePictureCanvasElem=document.createElement("canvas"),this._livePictureCanvasElem.width=t*LiveFeedConstants.livePictureCanvasHeight,this._livePictureCanvasElem.height=LiveFeedConstants.livePictureCanvasHeight,this._liveFeedVideoElem=document.createElement("VIDEO"),this._liveFeedVideoElem.setStream(this._avUpStream),this._liveFeedVideoElem.playStream(),RemoteWork.isInRemoteWorkView()&&(this.drawLivePicture(),LiveFeedUI.updateLivePictureForOutgoingFeed(this._lastActiveFeedImage)),this.updateLiveFeedImage()},updateLiveFeedImage:function(){clearTimeout(this._livePictureCaptureTimeout),this._livePictureCaptureTimeout=setTimeout(function(){var e=RemoteWork.isInRemoteWorkView(),t=this.hasActiveMembers();(e||t)&&this.drawLivePicture(),e&&LiveFeedUI.updateLivePictureForOutgoingFeed(this._lastActiveFeedImage),t&&this.sendLivePictureForActiveConnection(),this.updateLiveFeedImage()}.bind(this),LiveFeedConstants.livePictureCaptureTimeInterval)},sendLivePictureForActiveConnection:function(){var e=this.getMembers();for(var t in e)t!==$zcg._ZUID&&e[t].sendLivePicture(this._lastActiveFeedImage)},drawLivePicture:function(){this._lastActiveFeedImage=LiveFeedUI.drawLivePicture(this._livePictureCanvasElem,this._liveFeedVideoElem)},getLivePicture:function(){return this._lastActiveFeedImage},hasActiveMembers:function(){for(var e in this.getMembers())if(e!==$zcg._ZUID)return!0;return!1},clearRequestTimeout:function(){clearTimeout(this._requestFeedTimeout)},addMember:function(e){this._members[e.getId()]=e},removeMember:function(e){delete this._members[e]},setHostId:function(e){this._hostId=e},terminate:function(){this.clearRequestTimeout(),clearTimeout(this._livePictureCaptureTimeout);var e=this.getMembers();for(var t in e){e[t].closeConnection()}}};var LiveFeedMember=function(e,t,i){this._id=e,this._name=t,this._liveFeedId=i,this._clientSupport={perfect_renegotiation:!0,multi_stream:!0},this._connection=void 0,this._remoteSdp=void 0,this._remoteIceCandidates=[],this._avDownStream=void 0,this._avDownStreamTracks=[],this._remoteTracksMediaId={}};LiveFeedMember.prototype={getId:function(){return this._id},getName:function(){return this._name},getLiveFeedId:function(){return this._liveFeedId},getClientSupport:function(){return this._clientSupport},setLiveFeedId:function(e){this._liveFeedId=e},setName:function(e){this._name=e},setClientSupport:function(e){this._clientSupport=e},storeRemoteSdp:function(e){this._remoteSdp=e},storeAndSetRemoteSdp:function(e){this.storeRemoteSdp(e),this._connection.setRemoteTracksMediaId(this._remoteTracksMediaId),this._connection.setRemoteSdp(e),this._connection.updateLocalIceCandidates(),this._connection.addRemoteIceCandidates(this._remoteIceCandidates),this._remoteIceCandidates=[]},storeRemoteIceCandidates:function(e){e.forEach(function(e){this._remoteIceCandidates.push(e)}.bind(this))},storeAndSetRemoteIceCandidates:function(e){this.storeRemoteIceCandidates(e),void 0!==this._remoteSdp&&(this._connection.addRemoteIceCandidates(e),this._remoteIceCandidates=[])},initConnection:function(e,t,i){this._connection=new LiveFeedRTCPeerConnection(this.getLiveFeedId(),e,this.getId(),t,LiveFeedHandler.peerConnectionEvents),this._connection.init(i,LiveFeed.isVideoFeedAsPictureEnabled())},connectConnection:function(e,t,i){this._connection?this.restartAnswererConnection(t):(this.storeRemoteSdp(t),this._connection=new LiveFeedRTCPeerConnection(this.getLiveFeedId(),e,this.getId(),i,LiveFeedHandler.peerConnectionEvents),this._connection.connect(this._remoteSdp,this._remoteIceCandidates,void 0,void 0,LiveFeed.isVideoFeedAsPictureEnabled()))},handleReconnect:function(){this._remoteSdp=void 0,this._remoteIceCandidates=[],this._avDownStream=void 0,this._avDownStreamTracks=[],this._connection.restartOffererProcess()},restartAnswererConnection:function(e){this._remoteSdp=e,this._remoteIceCandidates=[],this._avDownStream=void 0,this._avDownStreamTracks=[],this._connection.restartAnswererProcess(e)},closeConnection:function(){this._connection&&this._connection.close()},sendLivePicture:function(e){this._connection&&this._connection.sendThroughDataChannel(e)}};var LiveFeedRTCPeerConnectionConstants={};LiveFeedRTCPeerConnectionConstants={processTypes:{INIT:"init",REINIT:"reinit",RESTART:"reconnection",RENEGOTIATE:"renegotiate"}};var LiveFeedRTCPeerConnection=function(e,t,i,n,s){this._connectionId=e,this._hostId=t,this._offererId=t,this._answererId=i,this._connection=void 0,this._turnCredentials=n,this._avUpStream=void 0,this._localSdp=void 0,this._remoteSdp=void 0,this._localIceCandidates=[],this._remoteIceCandidates=[],this._audioRtpSenders=[],this._videoRtpSenders=[],this._localTracksMediaId={},this._remoteTracksMediaId={},this._dataChannel=void 0,this._canUpdateLocalIceCandidates=!1,this._iceCandidatesGatheringTimer=void 0,this._disconnectTimer=void 0,this._endReconnectionTimer=void 0,this._reconnectionId=0,this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.INIT,this._handler=s,this._useGeo=!0};LiveFeedRTCPeerConnection.prototype={_getConfiguration:function(){if($WC.Util.isEmpty(this._turnCredentials)||$WC.Util.isEmptyObject(this._turnCredentials))return{};var e=this._useGeo&&!$WC.Util.isEmpty(this._turnCredentials.geo_turnurls)?this._turnCredentials.geo_turnurls:this._turnCredentials.main_turnurls,t=this._turnCredentials.username,i=this._turnCredentials.credential,n=[];return e.forEach((function(e){n.push({urls:e,username:t,credential:i})})),{iceServers:n}},_addTracksInConnection:function(){void 0!==this._avUpStream&&this._addVideoTracksInConnection()},_addVideoTracksInConnection:function(){this._avUpStream.getTracks().forEach(function(e){"video"===e.kind&&(this._videoRtpSenders.push(this._connection.addTrack(e,this._avUpStream)),this._localTracksMediaId.video=this._avUpStream.id)}.bind(this))},_removeVideoTracksInConnection:function(){this._videoRtpSenders.forEach(function(e){delete this._localTracksMediaId.video,this._connection.removeTrack(e)}.bind(this)),this._videoRtpSenders=[]},init:function(e,t){this._connection=new RTCPeerConnection(this._getConfiguration()),this._bindEventHandlers(),this._avUpStream=e,t?(this._createDataChannel(),this._createOffer(this._processType,!1)):(this._addTracksInConnection(),this._createOffer(this._processType,this._processType===LiveFeedRTCPeerConnectionConstants.processTypes.REINIT))},connect:function(e,t,i,n){this._connection=new RTCPeerConnection(this._getConfiguration()),this._bindEventHandlers(),this._remoteSdp=e,void 0!==t&&(this._remoteIceCandidates=t),this._avUpStream=i,n||this._addTracksInConnection(),this._createAnswer(this._processType)},_bindEventHandlers:function(){var e=this._connection,t=function(e){var t=e.candidate;if(t){if(this._localIceCandidates.push(t),!this._canUpdateLocalIceCandidates)return;if(!this._iceCandidatesGatheringTimer){var i=function(){this._handler.updateIceCandidates(this._connectionId,this._offererId,this._answererId,this._localIceCandidates,this._processType,this._reconnectionId),this._localIceCandidates=[],this._iceCandidatesGatheringTimer=void 0}.bind(this);this._iceCandidatesGatheringTimer=setTimeout(i,100)}}}.bind(this),i=function(t){var i=e.iceConnectionState;if(WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED===i){var n=this._processType;this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.INIT,clearTimeout(this._endReconnectionTimer),this._endReconnectionTimer=void 0,clearTimeout(this._disconnectTimer),this._disconnectTimer=void 0,this._handler.handleConnected(this._connectionId,this._connection,this._hostId,n)}else WebRTCPeerConnectionConstants.iceConnectionStates.DISCONNECTED===i&&(void 0===this._endReconnectionTimer&&(this._endReconnectionTimer=setTimeout(function(){this._handler.handleClosed(this._connectionId,this._hostId,this._answererId)}.bind(this),3e4)),clearTimeout(this._disconnectTimer),this._disconnectTimer=setTimeout(function(){this._reconnect()}.bind(this),2e3),this._handler.handleDisconnected(this._connectionId,this._hostId))}.bind(this),n=function(e){this._handler.handleTrack(this._connectionId,e.track,e.streams)}.bind(this),s=function(e){this._handler.handleIncommingDataChannel(this._connectionId),this._createDataChannel(e.channel)}.bind(this);e.onicecandidate=t,e.oniceconnectionstatechange=i,this._offererId!==$zcg._ZUID&&(e.ondatachannel=s),e.ontrack=n},_createOffer:function(e,t){var i=t?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{};this._connection.createOffer(i).then(function(t){this._localSdp=t,this._connection.setLocalDescription(t).then(function(){this._handler.sendOffer(this._connectionId,this._answererId,this._localSdp,e,this._reconnectionId,this._localTracksMediaId)}.bind(this))}.bind(this))},_createAnswer:function(e){var t={};this._connection.setRemoteDescription(this._remoteSdp).then(function(){this._connection.createAnswer(t).then(function(t){this._localSdp=t,this._connection.setLocalDescription(t).then(function(){this._handler.sendAnswer(this._connectionId,this._offererId,this._localSdp,e,this._reconnectionId,this._localTracksMediaId),this.updateLocalIceCandidates()}.bind(this))}.bind(this)),this.addRemoteIceCandidates()}.bind(this))},_createDataChannel:function(e){this._dataChannel&&(this._dataChannel.close(),this._dataChannel=void 0),this._offererId===$zcg._ZUID?(this._dataChannel=this._connection.createDataChannel("sendChannel"),this._dataChannel.binaryType="arraybuffer"):(this._dataChannel=e,this._dataChannel.binaryType="arraybuffer",this._dataChannel.onmessage=function(e){this._handler.handleReceive(this._connectionId,e.data)}.bind(this))},sendThroughDataChannel:function(e){void 0!==this._dataChannel&&"open"==this._dataChannel.readyState&&this._dataChannel.send(e)},_reinit:function(){this._handler.handleReinit(this._connectionId,this._hostId,this._offererId===this._hostId)},_renegotiate:function(){this._handler.handleRenegotiate(this._connectionId,this._hostId,this._offererId===this._hostId)},_reconnect:function(){this._reconnectionId++,this._handler.handleReconnect(this._connectionId,this._reconnectionId,this._hostId,this._offererId===this._hostId,this._answererId)},restartOffererProcess:function(){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.RESTART,this._closeConnection(),this._useGeo=!1,this.init(this._avUpStream,!0)},restartAnswererProcess:function(e){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.RESTART,this._closeConnection(),this._useGeo=!1,this.connect(e,void 0,this._avUpStream,!0)},reinitOfferer:function(){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.REINIT,this._closeConnection(),this.init(this._avUpStream,!0)},reinitAnswerer:function(e){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.REINIT,this._closeConnection(),this.connect(e,void 0,this._avUpStream,this._screenUpStream)},renegotiateOfferer:function(e){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.RENEGOTIATE,this._offererId=this._hostId,this._canUpdateLocalIceCandidates=!1,this._localIceCandidates=[],this._createOffer(this._processType,!e)},renegotiateAnswerer:function(e,t){this._processType=LiveFeedRTCPeerConnectionConstants.processTypes.RENEGOTIATE,this._remoteSdp=e,this._offererId=t,this._createAnswer(this._processType)},setRemoteSdp:function(e){this._remoteSdp=e,this._connection.setRemoteDescription(this._remoteSdp)},setRemoteTracksMediaId:function(e){this._remoteTracksMediaId=e},updateLocalIceCandidates:function(){this._canUpdateLocalIceCandidates=!0,this._handler.updateIceCandidates(this._connectionId,this._offererId,this._answererId,this._localIceCandidates,this._processType,this._reconnectionId),this._localIceCandidates=[]},addRemoteIceCandidates:function(e){e&&e.forEach(function(e){this._remoteIceCandidates.push(e)}.bind(this));var t=this._connection;this._remoteIceCandidates.forEach((function(e){t.addIceCandidate(new RTCIceCandidate(e))})),this._remoteIceCandidates=[]},_closeConnection:function(){clearTimeout(this._iceCandidatesGatheringTimer),this._iceCandidatesGatheringTimer=void 0,this._connection&&(this._connection.close(),this._connection=void 0),this._localSdp=void 0,this._remoteSdp=void 0,this._localIceCandidates=[],this._remoteIceCandidates=[],this._audioRtpSenders=[],this._videoRtpSenders=[],this._screenRtpSenders=[],this._localTracksMediaId={},this._remoteTracksMediaId={}},close:function(){clearTimeout(this._endReconnectionTimer),this._endReconnectionTimer=void 0,clearTimeout(this._disconnectTimer),this._disconnectTimer=void 0,this._closeConnection()}};