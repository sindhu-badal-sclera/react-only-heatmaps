var ThreadChatUtils,ThreadMsgObj,ThreadCardEvents=function(){var e=function(){var e="[thread-card] [thread-card-reply-msg]",t=`${e} [purpose='openSmileyBox'],${e} [purpose='reacted'],${e} [purpose='staroptions']`;$(document).on("click",t,(function(e){ThreadCard.getUIInstanceFromThreadCardElement(e.currentTarget.closest("[thread-card]")).onReactedAndStarClick(e.target.getAttribute("purpose"),e)}))},t=function(){$(document).on("click","[thread-card] [data-id=autocomplete] [purpose='search']",(function(e){var t=ThreadCard.getUIInstanceFromThreadCardElement(e.currentTarget.closest("[thread-card]"));t&&t.onAutoCompleteClick(e),e.stopImmediatePropagation()}))},a=function(e){var t=e.currentTarget,a=t.dataset.hoverAction;if(a&&a in s){var r=ThreadCard.getUIInstanceFromThreadCardElement(t.closest("[thread-card]"));s[a](r,e)}},r=function(e){if(!e.target.dataset.action&&!window.getSelection().toString()&&"msghistory"!=e.target.getAttribute("purpose")){var t=ThreadCard.getUIInstanceFromThreadCardElement(e.currentTarget.closest("[thread-card]"));s.onParentMsgClick(t,e)}},o=function(e){var t=e.target.dataset.action,a=e.currentTarget;t&&t in s||(t=function(e){var t="noActionThreadCardClick";return e.target.hasAttribute("composer-component-editor")&&(t="handleComposerClick"),t}(e));var r=ThreadCard.getUIInstanceFromThreadCardElement(a);r&&s[t](r,e)},s={openReplyInsideParentChat:function(e){e.convertToReplyMode()},openThreadChatInParentChat:function(e){e.openThreadChatInsideParentChat()},openThreadChatOutsideParentChat:function(e){e.openThreadChatOutsideParentChat()},loadMoreReplies:function(e){e.loadMoreReplies()},closeReplyPreview:function(e){e.closeReplyPreview()},handleComposerClick:function(e){e.handleComposerClick()},retryNewMsgFetch:function(e){e.retryNewMsgFetch()},openThreadFollowersWindow:function(e){e.openThreadFollowersWindow()},noActionThreadCardClick:function(e){e.noActionThreadCardClick()},openComposerAndFetchReplies:function(e){e.openComposerAndFetchReplies()},onParentMsgClick:function(e){e.onParentMsgClick()},onfollowUnfollowBtnHover:function(e,t){e.onfollowUnfollowBtnHover(t)},onfollowUnfollowBtnClick:function(e,t){e.onfollowUnfollowBtnClick(t)},addMember:function(e,t){e.addAtMentionedMembers(t)},cancelMemberAdd:function(e,t){e.cancelAtMentionedMembersAdd(t)}};return{init:function(){var s=$(document);s.on("click","[thread-card]",o),s.on("click",".zcmsg-thread-msg-container",r),s.on("mouseenter mouseleave","[thread-card] [data-hover-action]",a),t(),e()}}}();ThreadCardEvents.init(),ThreadChatUtils={constants:{THREAD_CHAT_ERROR:"threadChatError",MODES:{REPLY:"reply",NON_REPLY:"non-reply"},NEW_MSG_THRESHOLD:5,LOAD_MORE_LIMIT:3,IN_BETWEEN_MSG_LIMIT:5,BANNER_UPDATE:"threadNotificationBannerUpdate",DUMMY_CHATID:"dummy_chid",FOLLOWED:"followed",UNFOLLOWED:"unfollowed",CLOSED:"closed",OPENED:"open"},getMsgObj:function(e,t,a){return StorageManager.getMsgObjByMsgUid(e,t,a)},isParentChatStorageExists:function(e,t){return StorageManager.isExist(e,t)},isParentChatStorageNotExists:function(e,t){return!this.isParentChatStorageExists(e,t)},getMockMessage:function(e){var t={curtime:$Util.getSyncedCurrentTime(),chid:e.chatId,repliedmsguid:e.repliedMsgUid,repliedfrom:e.repliedFrom,repliedmsgcontent:e.repliedMsgContent,lastMessage:e.lastMessage,msg:e.msg,ignoreupdate:void 0},a=Composer.getMockMsgObj(t);return a.threadCardParentInfo=e.parentChatInfo,a.postInParent=e.postInParent,MessageFactory(a,e.chatId)},isThreadCardReplyEl:function(e){return e[0].hasAttribute("threadcard-parent-info")},getReplyPreviewLayout:function(e,t){var a=MessagePreview.getPreviewLayout(e,"rplymsg"),r=$WC.template.replace(ThreadChatTemplates.replyPreviewContainer,{replypreview:a},"InSecureHTML");return t?"<pre>"+r+"</pre>":r},getThreadBadgeHtml:function(e,t){return'<span class="old-name-search ellips fshrink fontN dibM" data-purpose="threadChatTitle" title="'+e+'">'+this.getThreadTitle(e,t)+"</span>"},getThreadTitleForTransHeader:function(e,t){return'<span class="mLR5">></span>'+this.getThreadTitle(e,t)},getThreadTitle:function(e,t){return'<span class="'+(t?"zcf-closethread":"zcf-startthread")+' mLR4 font13 clr-icon2"></span>'+$WC.$CUtil.processXSS(e)},isAdminEnabledThread:function(){return SecurityManager.hasPermission(Modules.ThreadsInChannels)},hasThreadReplyPermission:function(e){var t=Channels.getByChid(e);return!Config.isChannelConfigEnabled()||(!!ChannelConfig.isThreadForcedByAdmin(t)||ChannelConfig.isThreadAllowed(t.oc_id)&&ChannelsPermission.hasThreadReplyPermission(t.oc_id))},isReplyInThreadEnabledInPermissions:function(e){var t=Channels.getByChid(e);return!!t&&ChannelsPermission.hasThreadReplyPermission(t.oc_id)},isChannelBelongToThreadAllowedTeams:function(e,t){if(!Config.isThreadFeatureEnabled())return!1;if(!new $CliqChatId(e).isChannel())return!1;var a=$zcg._THREAD_ALLOWED_TEAMS,r=Channels.getByChid(e);if(t&&!this.hasThreadReplyPermission(e))return!1;if(!a||"true"==a)return!0;var o=r.scid;return!(!o||0==o.length)&&(a=a.split(","),o.filter((function(e){return a.includes(e)})).length==o.length)},isThreadEnabledChat:function(e,t){return this.isChannelBelongToThreadAllowedTeams(e,t)},convertToThreadCard:function(e,t){var a=ChatUI.exist[e];a&&a.getCwinThreadController().createThreadCardUI(t)},canShowStartThread:function(e,t){var a=ChatUI.getWin(e);if(!a||!a.isThreadChatAllowed(!0))return!1;var r=a.getMessage(t);return r&&!r.isThreadParentMessage()&&!r.tempThread&&!r.isThreadHeadMessage()},goToHeadMessage:function(e){var t=ChatUI.getWin(e);t&&t.threadChatWindowActions.goToHeadMessage.call(t)},updatePropsInHeadMsgObj:function(e){e.msgobj.threadchatid=e.msgobj.thread_information.chat_id,delete e.threadInfo,delete e.msgobj.thread_information},canReturnThreadCardHtml:function(e,t){var a=e.getObject(),r=StorageManager.getStorage(a.chid,t),o=!1;return r&&e.isEditMessage&&a.msguid==r.msgUidUsedToCreateTempStorage&&(o=!!r.getList().initView),r&&!e.avoidThreadCardHtml&&(e.isThreadParentMessage()||e.tempThread)&&(!e.isEditMessage||e.tempThread||e.isThreadCardConversion||o)&&!e.isDeleteMessage&&!e.isThreadHeadMessage()},isUnreadMessage:function(e,t){var a=ConversationsList.getUnreadTime(e);return-1!==a&&(!!t&&a<=t.getTime())},createConversationObj:function(e){var t=ChatUI.getChatDetailsFromMsg({...e.msgobj});ConversationsList.updateConversationsDB([t])},log:function(e){_print(this.constants.THREAD_CHAT_ERROR,e)},isThreadChat:function(e){return e.ctype==$zcg.THREADCHAT},$getAllThreadsPopUpContainer:function(){return this.$allThreadsPopUp||(this.$allThreadsPopUp=$("#thread-search-popup-container"))},dummyCwinObj:null,getDummyCwinObj:function(){return this.dummyCwinObj||(this.dummyCwinObj=new $Cwin(this.constants.DUMMY_CHATID))},isThreadReplyMessage:function(e){if("object"==typeof e)return"true"===e.threadmsg||e.ctype==$zcg.THREADCHAT},getThreadChatIdFromMsgObj:function(e){return e.threadchatid},getAddInfoForParticipantsUpdate:function(e){let t=+e.pcount;return e.botscount&&(t+=+e.botscount),{isThreadChatParticipantUpdate:!0,parentMsgUid:e.parentmsguid,parentChatId:e.parentChatId,pcount:t}},getUserDetails:function(e){var t=Users.getDetail(e);return $.extend(t,{image:'<img src="'+t.image+'"/>'})},makePostRequest:function(e,t,a){var r={type:"POST",contentType:"application/json",url:e,data:t=t||{}};return r=$.extend({},a||{},r),$ZCAjx.ajax(r)},makePutRequest:function(e,t,a){var r={type:"PUT",contentType:"application/json",url:e,data:t=t||{}};return r=$.extend({},a||{},r),$ZCAjx.ajax(r)},makeGetRequest:function(e,t){return $ZCAjx.ajax({url:e,type:"GET",data:t||{}})},makeDeleteRequest:function(e,t,a){var r={type:"DELETE",contentType:"application/json",url:e,data:t=t||{}};return r=$.extend({},a||{},r),$ZCAjx.ajax(r)},fetchThreadChatDetailsFromServer:function(e){return this.makeGetRequest("/v1/chats",{chat_ids:e}).then((function(e){return ConversationsList.updateConversationsDB(e),e}))},isThreadParentMsg:function(e){return"object"==typeof e.thread_information},isThreadReplyMsg:function(e){return"true"==e.threadmsg},getResolvedPromise:function(e){return Promise.resolve(e)},addThreadCardDetailsInHtml:function(e){return $(e).attr("thread-card-reply-msg","")[0].outerHTML},updateMsgObjForMsgOperations:function(e,t){var a=t.closest("[thread-card]")[0].dataset,r=StorageManager.getStorage(a.parentChid,a.parentViewid).getThreadCards().getInstanceByMsgUid(a.msgUid);e.isThreadCardReplyMsg=!0,e.threadCardUIInstance=r},updateFollowersCountInUI:function(e,t,a){var r=StorageManager.getStoragesByChid(e);for(var o in r)r[o].updateThreadFollowersCount(t,a)},addMeAsFollowerInThreadMsgObj:function(e,t,a,r){var o=StorageManager.getStoragesByChid(e);for(var s in o){var n=o[s],i=n.getThreadCards().getInstanceByMsgUid(t),d=i&&i.amIFollower();n.setThreadFollower(t,!0),d||i&&i.onFollow()}ConversationsList.updateIsThreadFollower(a,!0);var h=ChatUI.getWin(a);h&&h.onFollow()},removeMeFromFollowerInThreadMsgObj:function(e,t,a,r){var o=StorageManager.getStoragesByChid(e);for(var s in o){var n=o[s],i=n.getThreadCards().getInstanceByMsgUid(t),d=i&&!i.amIFollower();n.setThreadFollower(t,!1),d||i&&i.onUnfollow()}ConversationsList.updateIsThreadFollower(a,!1);var h=ChatUI.getWin(a);h&&h.onUnfollow()},updateFollowersCountAndRemoveFromUnsubs:function(e,t,a,r,o,s){void 0!==(o=s?s.pcount:o)&&this.updateFollowersCountInUI(t,a,o),this.isArrayContainsMyZuid(r)&&(this.newUnfollowedThreadChatHandler.remove(e),this.addMeAsFollowerInThreadMsgObj(t,a,e,s)),ThreadUnsubsStorage.removeMany(e,r)},updateFollowersCountAndAddInUnsubs:function(e,t,a,r,o,s){void 0!==(o=s?s.pcount:o)&&this.updateFollowersCountInUI(t,a,o),this.isArrayContainsMyZuid(r)&&(this.newUnfollowedThreadChatHandler.remove(e),this.removeMeFromFollowerInThreadMsgObj(t,a,e,s)),ThreadUnsubsStorage.add(e,r)},isArrayContainsMyZuid:function(e){if(Array.isArray(e))return e.includes(WmsImpl.getZuid())},followThread:function(e,t){if(ChatUI.exist[e]){var a=this,r={parentChatId:t.parentchid,threadChatId:t.threadchid,userIds:[WmsImpl.getZuid()]};return ThreadApis.follow(r).then((function(){a.addMeAsFollowerInThreadMsgObj(t.parentchid,t.parentmsguid,t.threadchid),a.onFollowSuccess(t.threadchid)}),(function(){}))}},unfollowThread:function(e,t){if(ChatUI.exist[e]){var a=this,r={parentChatId:t.parentchid,threadChatId:t.threadchid,userIds:[WmsImpl.getZuid()]};return ThreadApis.unfollow(r).then((function(){a.removeMeFromFollowerInThreadMsgObj(t.parentchid,t.parentmsguid,t.threadchid),a.onUnfollowSuccess(t.threadchid)}),(function(){}))}},onFollowSuccess:function(e){var t=I18N("thread.follow.success");UI.updateBanner(t),ConversationsList.updateIsThreadFollower(e,!0)},onUnfollowSuccess:function(e){var t=I18N("thread.unfollow.success");UI.updateBanner(t),ConversationsList.updateIsThreadFollower(e,!1)},addFollowers:function(e,t,a){var r={parentChatId:e.parentChatId,threadChatId:e.threadChatId,userIds:a.split(","),additionalAjaxOptions:t};ThreadApis.addFollowers(r)},removeFollowers:function(e,t){var a={parentChatId:e.parentChatId,threadChatId:e.threadChatId,userIds:t};ThreadApis.removeFollowers(a)},getTotalFollowersText:function(e){var t=Conference.getChatViewPort().length>0,a=t?"channel.tip.joinedparticip":"thread.nfollowers";return 0==e?e=I18N("emoji.no"):1==e&&(a=t?"chat.participants.count":"thread.onefollower"),Resource.getRealValue(a,[e])},updateTabInfoObjForThreadChat:function(e,t){if(e.parentChatid&&(t.parentChatid=e.parentChatid),e.parentchatid&&(t.parentChatid=e.parentchatid),e.parentmessagesenderid&&(t.parentmessagesenderid=e.parentmessagesenderid),e.parentmsguid&&(t.parentmsguid=e.parentmsguid),e.threadmsguid&&(t.parentmsguid=e.threadmsguid),e.is_follower&&(t.isfollower="true"==e.is_follower),"boolean"==typeof e.isfollower&&(t.isfollower=e.isfollower),e.addinfo){var a=Chat.parseAddinfo(e.addinfo);a.hasOwnProperty("THREAD_STATE")&&(t.thread_state="THREAD_CLOSED"==a.THREAD_STATE?"closed":"")}},isThreadCloseOrReopenMsg:function(e){return e&&e.info&&["THREAD_CLOSED","THREAD_REOPENED"].includes(e.info.mode)},getCurrentPCount:function(e){return Participants.isExist(e)?Participants.get(e).getPcount():0},showConfirmationPopupAndCloseThread:function(e,t,a,r){var o=this;$WC.$Dlg.create({id:"closethread_alert",version:3,class:"zcl-alert-dialog-2 zcldel-dialog-box",headerhtml:$WC.$Dlg.frameHeaderHTML({imagehtml:'<div class="zcl-img xl flexM mAuto zcf-closethread zcl-img--neg"></div>',header:I18N("thread.close.header",'<span class="zcf-startthread font15 mLR4"></span>'+ConversationsList.getTitle(t,r||"")),subheader:[Resource.getRealValue("thread.close.subheader")]}),bodyhtml:"",buttons:[$WC.$Dlg.getButtonObj("common.cancel",$zcg._cssClasses.SECONDARY_BTN,(function(){})),$WC.$Dlg.getButtonObj("thread.close",$zcg._cssClasses.NEG_PRIMARY_BTN,(function(){var r=$("#closethread_alert").find("[button=2]");return $Util.Button.addLoadIconForAjax(r),o.closeThread(e,t,a).then(()=>$WC.$Win.destroy("closethread_alert"),()=>{$Util.Button.showCompletionAndResetContent(r,!0)}),!0}))]})},closeThread:function(e,t,a){return ThreadApis.closeThread(t).then(()=>{this.onCloseThreadSuccess(e,t,a)})},onCloseThreadSuccess:function(e,t,a){var r=I18N("thread.close.success");UI.updateBanner(r),this.updateThreadStateInAllStorages({threadChatId:t,parentChatId:e,msgUid:a,state:this.constants.CLOSED})},onReopenThreadSuccess:function(e,t,a){var r=I18N("thread.reopen.success");UI.updateBanner(r),this.updateThreadStateInAllStorages({threadChatId:t,parentChatId:e,msgUid:a,state:this.constants.OPENED})},updateThreadStateInAllStorages:function(e){var t=e.state.toLowerCase()==this.constants.CLOSED;ConversationsList.updateIsClosedThread(e.threadChatId,t);var a=StorageManager.getStoragesByChid(e.threadChatId);for(var r in a){a[r].setIsClosedThread(t)}},removeNewMsgNotificationIfNewMsgIsPostInParentMsg:function(e){var t=e.unreadCount;if(0!=t){var a=StorageManager.getStorage(e.chatId,e.viewId);if(a){var r=a.getList();if(!r.isEmpty()){for(var o,s=new ReverseIterator(r),n=t;s.hasNext()&&n--;){var i=s.next();if(!i.hasThreadLinkInfo())return}if(Chat.isThreadChatByChid(e.chatId))o=e.chatId;else{var d=i.getObject();if(!d.post_in_parent_information)return;o=d.post_in_parent_information.thread_chat_id}var h=o;Chat.isThreadChatByChid(e.chatId)&&(h=o.split("-T-")[0]),t===ConversationsList.getUnreadCount(h)&&(ChatUI.isExist(h)?ChatUI.getWin(h).removeNewmsgNotification():Chat.propagateMsgSeen(h))}}}},handleThreadChatMsgSeen:function(e){var t=ConversationsList.getParentChatId(e);if(t){var a=ConversationsList.get(t);a&&(a.removeUnreadThreadChid(e),ConversationsUI.updateMsgCount(t,a.getUnreadMsgsCount()),this.removeUnreadYellowBg(e),this.removeUnreadChatInNotificationBanner(t,e),this.isNewUnfollowedThreadChat(e)&&this.newUnfollowedThreadChatHandler.remove(e),this.handleMsgSeenInThreadCard(e))}},handleMsgSeenInThreadCard:function(e){var t=StorageManager.getStoragesByChid(e);if(t)for(var a in t){var r=t[a];r.isThreadCardMsgStorage&&r.handleAfterRead()}},removeUnreadYellowBg:function(e){var t=StorageManager.getStoragesByChid(e);if(t)for(var a in t){var r=t[a].getView();r&&r.removeUnreadHighLight()}},addUnreadChatInNotificationBanner:function(e,t){var a=ChatUI.getWin(e);a&&a.getCwinThreadController().addChidInThreadNotification(t)},removeUnreadChatInNotificationBanner:function(e,t){var a=ChatUI.getWin(e);a&&a.getCwinThreadController().removeChidFromThreadNotification(t)},goToNextUnreadThread:function(e){var t=e.dataset.parentchid,a=ChatUI.getWin(t);a&&a.getCwinThreadController().goToNextUnreadThread()},createHashMap:function(){function e(e){this.items={},e.forEach(this.add.bind(this))}return e.prototype.add=function(e){return this.items[e.id]={id:e.id,sortNumber:e.sortNumber,userId:e.userId},e.userId},e.prototype.update=function(e){this.add(e)},e.prototype.delete=function(e){if(this.has(e)){var t=this.items[e];return delete this.items[e],t.userId}},e.prototype.has=function(e){return this.items.hasOwnProperty(e)},e.prototype.getAll=function(){return Object.values(this.items).sort((function(e,t){return t.sortNumber-e.sortNumber})).map((function(e){return e.userId}))},e.prototype.getUserId=function(e){if(this.has(e))return this.items[e].userId},e.prototype.getFirstId=function(){return Object.values(this.items).sort((function(e,t){return t.sortNumber-e.sortNumber}))[0].id},e.prototype.getLength=function(){return Object.keys(this.items).length},function(t){return new e(t)}}(),focusParentChatAndThenThreadChat:function(e,t){MainUI.getMefront(e,!0,void 0,!0),MainUI.getMefront(t,!0,void 0,!0)},handleGetMeFront:function(e){if((!Config.isGetMeFrontOptimized()||NestedChatUI.isExist("",!0))&&!NestedChatUI.isExist(e,!0)){var t=NestedChatUI.getChidByParentChid(e),a=MainUI.isChatPaneView();t?((Config.isGetMeFrontOptimized()?NestedChatUI.getNestedChatWindow(t):$("#"+t)).show(),a&&NestedChatUI.updateAllNestedCwinPositionBasedOnParentCwinPosition()):a||NestedChatUI.hideAll()}},isUnfollowedThreadChat:function(e){var t=ConversationsList.isThreadFollower(e);return"boolean"==typeof t&&!t},isParentMsgFollower:function(e){var t=Config.isHtKeyEnabled()?"ht":"h";return"object"==typeof e&&!e.hasOwnProperty(t)},isFirstThreadMessage:function(e){return"object"==typeof e&&e.hasOwnProperty("isfirstthreadmessage")},isNewUnfollowedThreadChat:function(e){return this.newUnfollowedThreadChatHandler.has(e)},getTotalUnreadThreadChatIdByParentChid:function(e,t){var a=ConversationsList.getUnReadThreadChids(e)||[];return 0==a.length?0:(t&&(a=a.filter(e=>!this.isNewUnfollowedThreadChat(e))),a.filter(this.hasUnreadMsg).length)},hasUnreadMsg:function(e){return ConversationsList.getUnreadCount(e)>0},newUnfollowedThreadChatHandler:function(){var e=new Set;return{has:function(t){return e.has(t)},remove:function(t){e.delete(t)},add:function(t){e.add(t)}}}(),isInValidInfoMessage:function(e){if(!e||!e.info||!e.info.mode)return!0;return["USER ADDED","USER DELETED"].includes(e.info.mode)},canShowThreadUnreadCountInParentChat:function(){return!Config.isThreadsLhsEnabled()||LhsModules.threadViews.isInlineInChats()},chatIdVsParentChatInfo:function(){var e={};return{add:function(t,a,r){t&&a&&r&&(e[t]={parentChatId:r,parentMsgUid:a})},isExist:function(t){return t&&e.hasOwnProperty(t)},get:function(t){return e[t]}}}(),threadCwinOpenFromWmsResponseWaitTimer:null,applyStyleOnThreadCwinResizing:function(e){var t,a=e.parentChatId,r=e.el,o=ChatUI.getWin(a);if(o){var s=o.win();if(!e.newWidth)t=e.newWidth,r&&r.css({width:t,left:""});else{var n=0;Config.isNewNestedContainerEnabled()&&(n=4),t="calc(100% - "+(e.newWidth+n)+"px)",r.css({left:t})}e.isUpdateSkeletonWidth&&r.css({width:e.newWidth+"px"}),s.find("#chatbody").css({width:t}),s.find(`#compcontainer,#chattabscontainer,#sticky${e.parentChatId}`).css({width:t})}},threadPanelResizedBefore:function(e,t,a){if(!MainUI.isChatPaneView()){var r=localStorage.getItem("resizableComponents");if("undefined"!==r&&null!==r){var o=!!(r=JSON.parse(r)).threadResizePanel&&r.threadResizePanel;if(o){var s={el:e,newWidth:a?"":o,parentChatId:t,isUpdateSkeletonWidth:!a};this.applyStyleOnThreadCwinResizing(s)}}}},openThreadChatInsideParentChatWindow:function(e,t,a,r,o){if(MediaUtil.isInMaximizedView()){var s=ChatUI.exist[a];return s&&s instanceof ThreadCardUI&&delete ChatUI.exist[a],ReplyPrivate.handleMaximizedView(),void Chat.attachSession(a)}var n=ChatUI.exist[e],i=ChatUI.getWin(a),d=i&&i instanceof $Cwin,h=function(){r&&r()},l=this;if(n){var c=NestedChatUI.isExist(a),p=ChatUI.hasChatWindowDOMInView(),g=d&&c,u=d&&!c;if("undefined"!=typeof DetachedCwin&&d&&DetachedCwin.isExist(a)&&(i.isDetachedCwin=!1),g&&p)return MainUI.getMefront(a,!0),void h();if(!NestedChatUI.isLoading(a)){var C=NestedChatUI.getChidByParentChid(e);C&&(n.ignoreOrientation=!0,NestedChatUI.closeNestedWin(C));var f=MainUI.isChatPaneView();if(ThreadChatUI.orientation.setOpenInsideParentChat(a,!0),u&&p){var T=i.win();return T.attr(NestedChatUI.CONSTANTS.parentChid,e),NestedChatUI.getNestedChatWindowContainer().append(T),i.handleFirstUIUpdate(),f&&MainUI.normalizeChatWindow($("#chatwindowsviewport")),Config.isNewNestedContainerEnabled()&&!f&&(NestedChatUI.updateNewNestedCwinPosition(null,a),this.threadPanelResizedBefore(T,e)),MainUI.getMefront(a,!0),void i.updateParticipantsDetailsHtml()}var m=$WC.template.replace(ThreadChatTemplates.nested_thread_chat_container,{chatId:a,parentChatId:e,single_chat_class:f?"":"nested-thread"});Config.isNewNestedContainerEnabled()?(NestedChatUI.getNestedChatWindowContainer().append(m).show(),ChatUI.showMsgTimeOnChatWindowOpened()):$("#nested-chat-windows").append(m).show();var w=$("#"+a);w.html(ThreadChatTemplates.nested_chat_skeleton_loader),!f&&p&&this.threadPanelResizedBefore(w,e);var I=n.getStorage().getThreadCards().getInstanceByMsgUid(t);I&&I.handleBeforeOpeningThreadChatAsSeparateChat(),f&&MainUI.normalizeChatWindow($("#chatwindowsviewport"),{isThreadChatSkeletonLoader:!0}),Config.isNewNestedContainerEnabled()&&!f&&NestedChatUI.updateNewNestedCwinPosition(null,a);var v=function(e,t){o&&o(t,!e),e?l.threadCwinOpenFromWmsResponseWaitTimer=setTimeout(()=>M(),3e3):e||M()},M=function(){ChatUI.isExist(a)||NestedChatUI.isExist(a,!0)||(U(),y(),MainUI.current==n.getChid()&&n.focus())},y=function(){ThreadChatUI.orientation.resetOpenInsideParentChat(a)},U=function(){w.remove();var t=ChatUI.getWin(e);if(t){t.ignoreOrientation=!1;var r=ChatUI.getWin(a);if(r&&r instanceof $Cwin)r.handleOrientation();else{t.win().removeClass("nested-parent");var o={parentChatId:e,newWidth:""};ThreadChatUtils.applyStyleOnThreadCwinResizing(o)}}};Chat.attachSession(a).then((function(e){var t=function(e){return!$.isEmptyObject(e)&&e[0]&&e[0].objString?e[0].objString:""}(e);t&&t.chid&&"false"!=t.chatavailable?(y(),h()):v("false"==t.chatavailable||!t.chid,e)}),v)}}else h()}},(ThreadMsgObj=function(e){this.msgObj=e,this.isThreadParentMsg="object"==typeof e.thread_information,this.isThreadReplyMsg="true"==e.threadmsg,this.threadInfo=null,this.initThreadInfo(),this.threadChatId=this.threadInfo.threadChatId,this.threadMsgUid=this.threadInfo.threadMsgUid,this.parentChid=this.msgObj.parentChatId||this.msgObj.chid,this.isThreadParentMsg&&(this.followersCount=this.threadInfo.followersCount,this.isFollower=this.threadInfo.isFollower,this.threadMsgCount=this.threadInfo.threadMsgCount,this.threadChatTitle=this.threadInfo.threadChatTitle,this.isclosedThread=this.threadInfo.isClosedThread),this.hasThreadLastMessage()&&(this.getThreadLastMessage().isThreadLastMsg=!0),ThreadChatUtils.chatIdVsParentChatInfo.add(this.getThreadChatId(),this.getMsgUid(),this.getParentChid())}).prototype.initThreadInfo=function(){if(this.isThreadParentMsg||this.isThreadReplyMsg){var e=this.msgObj,t=e.thread_information,a={threadChatId:this.isThreadParentMsg?t.chat_id:e.threadchatid,threadMsgUid:this.isThreadParentMsg?t.thread_message_id:e.threadmsguid||e.parentmsguid};!a.threadChatId&&"string"==typeof e.chid&&e.chid.indexOf("-T-")>-1&&(a.threadChatId=e.chid),this.isThreadParentMsg&&(a.threadMsgCount=t.message_count,a.followersCount=t.follower_count,a.isFollower=t.is_follower,a.threadChatTitle=t.title),Object.assign(a,this.getThreadStateObj()),this.threadInfo=a}},ThreadMsgObj.prototype.getThreadStateObj=function(){if(!this.isThreadParentMsg)return{};var e={},t=this.msgObj.thread_state_info;return e.isClosedThread=!!t&&"closed"==t.thread_state,e},ThreadMsgObj.prototype.isClosedThread=function(){return this.isclosedThread},ThreadMsgObj.prototype.setIsClosedThread=function(e){this.isclosedThread=e},ThreadMsgObj.prototype.getThreadChatId=function(){return this.threadChatId},ThreadMsgObj.prototype.getThreadMsgCount=function(){return this.threadMsgCount},ThreadMsgObj.prototype.setThreadMsgCount=function(e){this.threadMsgCount=e},ThreadMsgObj.prototype.getThreadChatTitle=function(){return this.threadChatTitle},ThreadMsgObj.prototype.getMsgUid=function(){return this.threadMsgUid},ThreadMsgObj.prototype.getParentChid=function(){return this.parentChid},ThreadMsgObj.prototype.getFollowersCount=function(){return this.followersCount},ThreadMsgObj.prototype.setFollowersCount=function(e){this.followersCount=e},ThreadMsgObj.prototype.setThreadChatTitle=function(e){this.threadChatTitle=e},ThreadMsgObj.prototype.setIsFollower=function(e){this.isFollower=e},ThreadMsgObj.prototype.amIFollower=function(){return this.isFollower},ThreadMsgObj.prototype.follow=function(){this.setIsFollower(!0)},ThreadMsgObj.prototype.unfollow=function(){this.setIsFollower(!1)},ThreadMsgObj.prototype.hasThreadLastMessage=function(){return this.msgObj.hasOwnProperty("thread_message")},ThreadMsgObj.prototype.getThreadLastMessage=function(){return this.msgObj.thread_message},ThreadMsgObj.prototype.getInfo=function(){return this.threadInfo};var ThreadChatTemplates={mini:{element:'<div class="zcmsg-thread {{newmsgclass}} {{closedthreadclass}} lazy-load lazy-load-threadcard" id="{{id}}" data-parent-chid="{{parentchid}}" data-parent-viewid="{{parentviewid}}" data-thread-chid="{{threadchatid}}" data-msg-uid="{{msguid}}" msguid="{{msguid}}" thread-card notunobserve></div>',container:'<div class="zcmsg-thread_main"><div class="zcmsg-thread-msg-container" thread-card-msg thread-card-content>{{thread_msg_html}}</div><div id="non-msg-container" thread-card-content><div class="thread-more-reply flex dN" id="more-replies-container" data-action="loadMoreReplies"><span class="thread-more-icon zcf-more-h clr-icon flexM tooltip-right" data-action="loadMoreReplies" tooltip-title="'+I18N("thread.previousload")+'"></span></div><div id="thread-msg-loader" class="thread-msg-loader newmsgs dN"></div>{{replies_html}}<div id="thread_promptbanner" style="display:none" class="zcprmtbanr"></div><div id="compautocompletethread{{threadchatid}}" data-id="autocomplete" class="chtedtrdrpdwn" style="display:none"></div><div id="reply-mode-content"></div>{{view_and_open_thread_html}}</div></div>',reply_mode_content:'<div id="composer-cb-cotainer" class="posrel zcmg-thread-composer dN"><div class="posrel">{{composer_html}}{{post_channel_checkbox}}</div><div id="msgoptionspreview" class="zcurlprv"><div data-action="closeReplyPreview" id="closepreview" class="msi-close cclose prvlngcls"></div><div class="zcreplypreview clrboth"><div id="preview" class="dIB zcmsgrlypr msgtxt me"></div></div></div></div>',post_checkbox:'<div class="thread-post_cb mB15">{{checkbox_html}}</div>',new_msg_badge:'<div id="newmsg-badge" class="LHS-count curP dN" data-action="openThreadChatInParentChat"></div>',closed_thread_label:'<div id="closed-label" class="font13 mR6 clr-lp1 closed-label curN flexC zcl-dropdown-divider mL10 pL10 fontN"><span class="zcf-closethread mR5 pT2 font13"></span><span>'+I18N("common.invite.only")+"<span></span></span></div>",replies:'<div class="zcmsg-thread-reply" id="thread-reply-win" thread-card-reply-msg mini-thread-mode="reply"><div id="chatbody" thread-card-chatbody style="overflow:visible !important;"><div id="msgarea"></div></div></div>',reply_here:'<span class="zcl-btn-secondary--link curP font14 thread-reply-here-link" data-action="openReplyInsideParentChat">'+I18N("thread.reply")+"</span>",thread_msg:'<div class="zcmsg-thread-msg-container">{msg}</div>',view_and_open_thread:'<div id="view-option" class="thread-view-options flexC {{view_option_cls}} {{hide}}"><div id="thread-view-btn" class="thread-view-btn flexG flexC ellips" mini-thread-id="{{id}}" data-action="openThreadChatInParentChat"><span id="replies-button" class="zcl-btn-theme--link font13 ellips"  data-action="openThreadChatInParentChat"><span id="total-msgs-cont"  data-action="openThreadChatInParentChat">{{total_replies}}</span></span>{{new_msg_badge}}{{closed_thread_label}}</div><span class="clr-icon zcf-reply font13 mR18 tooltip-up posrel {{disable_reply}}" data-action="openComposerAndFetchReplies" tooltip-title="'+I18N("thread.reply")+'"></span><div id="followers-container" title="{{followers_count_tooltip}}" class="font13 mR6 clr-icon" data-action="openThreadFollowersWindow"><span class="zcf-event-organiser" data-action="openThreadFollowersWindow"></span><span id="followers-count" class="mL4" data-action="openThreadFollowersWindow">{{followers_count}}<span></div><div id="popouticon" class="thread-open-btn flexM zcf-popout clr-icon cur posrel" mini-thread-id="{{id}}" data-action="openThreadChatOutsideParentChat" title="'+I18N("thread.open.new")+'"></div></div>',composer:'<div class="" id="composer-container" mini-thread-mode="reply">{{composer_component}}</div>',newmsg_fetch_link:'<span class="zcl-btn-theme--link" data-action="retryNewMsgFetch" id="retryfetch" >'+I18N("message.option.retry")+"</span>",thread_card_new_msg_loader:'<div class="flex"><div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader mT20 w50"></div></div></div><div class="flex mT35"><div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader mT20 w50"></div></div></div>',dot_loader:'<div id="dotloader" class="hst-loadng"></div>',small_dot_loader:'<div id="small-dot-loader" class="zcl-dot--loader"><span></span><span></span><span></span></div>'},followers_templates:{container:'<div id="thread-followers-container" class="flexC zcmsg-thread_followers" data-threadchid="{{threadchid}}" data-parentchid="{{parentchid}}" data-parentviewid="{{parentviewid}}" data-msguid="{{msguid}}"><span class="clr-lp1 font14 mR6 fshrink">'+I18N("thread.followers")+' : </span><span id="bubble-container" class="flexC mL12">{{bubbles}}</span><div class="posrel"><span id="{{msguid}}add-follower-icon" documentclick="openThreadFollowersAddPopUp" title="'+I18N("thread.add.followers")+'" class="zcl-img xs flexM zcf-plus add-follower-btn">+</span></div></div>',add_followers_html:'<div id="{{search_entity}}" class="addparticipants zcrchmcnt addfollowers"><div class="zccrin reminputbox"><div id="{{search_entity}}-search-field" class="remsrchfield" contenteditable="true" type="text" name="" data-text="{{searchpholder}}"></div></div><div id="{{search_entity}}-results" class="rem-drpdwn-cnt"><div id="{{search_entity}}-list" class="posl zcht100"></div></div><div class="crchndcnt crchndcnt-edit dN" id="selthreadfollowers"><div id="usernodecnt" class="zcrchicnt"><div id="{{search_entity}}-select-field" class="floatl"></div></div><div id="addThreadFollowers" data-action="addFollowers" class="windwbtn dIB cur posrel">{{create}}</div></div></div>',unfollowerHtml:'<div uid="{USERID}" elemtype="contact" purpose="search" data-val="{DNAME}" class="zcrtchtcontct remcontact flexC font13"><div class="list-img posl"><img src="{IMGURL}"><div class="{STATUSCLASS}"></div></div><div class="ellips list-cnt mrgL10"><div class="ellips dflx">{DNAMEVAL}</div><div class="ellips clr6">{EMAILID}</div></div></div>',remove_user_html:'<div class="msi-close user-remove posa dN cur"  data-action="removeUser"></div>',more_users_popup:'<span class="zcl-img--more flexM fontB" id="bubble-more-container">+<span id="bubble-more-count">{{count}}</span></span>',img_node:'<div uid="{{uid}}" elemtype="{{type}}"  title="{{name}}" username="{{name}}" nodetype="@" class="dIB zcricnt posl">{{image}}{{remove_html}}</div>'},bubble_maker:{element:'<div id="{{id}}-bubble-component" class="flexC"></div>',bubble_user:'<span uid="{{uid}}" class="zcl-img xs flexM"><img src="{{src}}"></span>',more_users:'<span class="zcl-img--more flexM fontB" id="bubble-more-container">+<span id="bubble-more-count">{{count}}</span></span>'},head_msg:{element:'<div id="thread-head-msg" thread-head-msg><div class="zcmsg-head_msg"><div id="headmsg-chatbody"><div id="headmsg-msgarea"></div></div></div><div class="h35 thread-reply"></div><div>'},head_message:{element:'<div id="{{ID}}-thread-message-component" class="flex-col thread-msg-hdr-info dN"></div>',container:'<div class="flexG currchatpanel ovrflwH thread-parent-msg-hdr" id="thread-msg-container"></div>',loader:'<div id="thread-msg-loader"><div class="flex p10"><div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader mT20"></div></div></div></div>',chat_body:'<div id="parentmsg-chatbody" class="dN"><div id="parentmsg-msgarea"></div></div>',options:'<div class="thread-head-msg-options flex"><div id="showLess" data-action="showLess" class="cur mR12 dN"><span class="zcl-point mR4"></span><span class="font13">'+I18N("app.show.less")+'</span></div><div id="showMore" data-action="showMore" class="cur mR12 dN"><span class="zcl-point mR4"></span><span class="font13">'+I18N("app.show.more")+'</span></div><div data-action="hideHeadMessage" class="cur"><span class="zcl-point mR4"></span><span class="font13">'+I18N("thread.hidemsg")+"</span></div></div>"},notificationBanner:{container:'<div id="unread-threads-notification" documentclick="goToNextUnreadThread" data-parentchid="{{parentchid}}" class="unread-thread-banner flexC zcl-btn--primary fontN"></div>',content:'<div id="bubbles-container" class="zcl-img-group flexC"></div><div class="mL4">'+I18N("thread.title")+'</div><div id="thread-unread-msg" class="flexM zcl-img xs thread-unread-count fontB">{{unread_count}}</div>'},thread_icon:'<em class="type-icon thread-type-icon flexM zcf-fillthread"></em>',unmuteIcon:'<span class="thread-notify-icon zcf-unmute" data-action="onfollowUnfollowBtnClick"></span>',muteIcon:'<span class="thread-notify-icon zcf-mute" data-action="onfollowUnfollowBtnClick"></span>',chat_img_html:'<div class="posrel wh100 thrdimgwrp"><img elemtype="user" hover="true" uid="{{uid}}" src="{{src}}" class="floatl rds4 cur"><div class="usrstatusbg usrstatusbgmin bdRTLR4"><em class="type-icon thread-type-icon flexM zcf-startthread"></em></div></div>',thread_state_info:'<div class="flexC"><span class="{state_icon} font13 pT2 mR4"></span><span class="pR4 ellips">{info}</span></div>',nested_thread_chat_container:'<div id="{{chatId}}" data-parent-chid="{{parentChatId}}" class="w100 nested-thread-loader {{single_chat_class}}"></div>',nested_chat_skeleton_loader:'<div id="nested-chat-loading" class="nestedchat__skelton__loader flex-col"><div class="nestedchat__skelton__loader--header flexC"><div class="flexC flexG"><div class="skelton-image skelton-color mL40 mR10"></div><div class="skelton-loader" style="width:107px"></div></div><div class="flex fshrink"><div class="skeleton-option skelton-color"></div><div class="skeleton-option skelton-color mL12"></div><div class="skeleton-option skelton-color mL12"></div></div></div><div class="nestedchat__skelton__loader--body flex-col"><div class="flex"> <div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader mT20" ></div><div class="skelton-loader mT20 w75"></div><div class="skelton-loader mT20 w50"></div></div></div><div class="flex mT35"> <div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader w100 skeleton-box-lg mT20"></div></div></div><div class="flex mT35"> <div class="skelton-image skelton-color mR10"></div><div class="flex fdirC mR10 pT6 w100"><div class="skelton-loader w25"></div><div class="skelton-loader skeleton-box-md mT20"></div><div class="skelton-loader mT20 w50"></div><div class="skelton-loader mT20"></div><div class="skelton-loader mT20 w75"></div><div class="skelton-loader mT20 w50"></div></div></div></div><div class="nestedchat__skelton__loader--footer flexC"><div class="skelton__composer skelton-loader mT20 flex justifySB"></div></div></div>',threadCWinHeader:'<div id="thread-msg-hdr-container"><div class="flexC thread-msg-hdr hdrwrap" thread-msg-hdr><div class="thread-back-icon-container dN show-in-nested hide-in-singlesheet"><div class="thread-msg-backicon fshrink dN show-in-nested curP"  data-action="closeThreadChatWindow"><span class="zcl-icon zcl-icon--plain zcl-round zcf-leftArrow" data-action="closeThreadChatWindow"></span></div></div><div class="zcl-img lg mR10 thrd-imgbs"><div id="userimage" class="usrimgsts fshrink wh100"></div></div><div class="flexG thread-chat-info-hdr ellips"><div class="flexC hdrsub ellips mT2"><div id="title{{CHID}}" chid="{{CHID}}" contenteditable="true" class="ellips font16 fontB thread-title zctle floatl bold ellips" spellcheck="false" {{DUMMYCWIN_ATTR}}></div><span id="parent-title-container" class="zcl-alert-xs zcl-alert-info mL8 hide-in-nested ellips fontN curP parent-title-container" data-action="goToHeadMessage"><span id="parent-title{{CHID}}"class="ellips" data-action="goToHeadMessage" {{DUMMYCWIN_ATTR}}></span></span><span non-nested-followBtn class="follow-unfollow-btn">{{followOrUnfollowBtn}}</span></div><div id="usrsmsg{{CHID}}" class="hide-in-nested clr-lp1 mT4 hdrstatus ellips conf-hide-chat-options" {{DUMMYCWIN_ATTR}}></div><span nested-followBtn>{{followOrUnfollowBtn}}</span></div><div id="threadOptionsWrapper" class="fshrink mL8 flexC thread-chat-optns"><div class="flexM chataddoptions" id="chataddoptions" type="chataddoptions"><div id="thread-search" class="zcl-icon-sm max-view-font not-denied thread-hdr-options-bdr"><span class="zcl-btn-separator cht-btn-separator"></span></div><div id="thread-call" class="zc-thrd-grp-call curP thread-hdr-options-bdr"><span class="zcl-btn-separator cht-btn-separator"></span></div></div><div id="chatHeaderDropdown" type="chatHeaderDropdown" class="chatHeaderDropdown flexM posrel dN"><div id="thread-moreoptions_{{CHID}}" class="zcf-more2 zc-mute-bx chw-opt-icon thread-hdr-options-bdr" chid="{{CHID}}" data-purpose="thread-more-options" type="menu-wrapper"><span class="zcl-btn-separator cht-btn-separator right0"></span></div></div><div class="zcl-icon-sm max-view-font zcf-gotochat2  hide-in-nested not-denied" ztooltip="'+I18N("thread.go.main")+'" title="'+I18N("thread.go.main")+'" data-action="goToHeadMessage"><span class="zcl-btn-separator cht-btn-separator"></span></div><div id="opennew" class="zcl-icon-sm max-view-font zcf-popout3 dN show-in-nested not-denied" ztooltip="'+I18N("thread.open.new")+'" title="'+I18N("thread.open.new")+'" data-action="shiftChatWindowToViewPort"><span class="zcl-btn-separator cht-btn-separator hide-in-nested show-in-singlesheet"></span></div><div id="cclose" class="chw-opt-icon zcl-icon-sm max-view-font zcf-close2 hide-in-nested show-in-singlesheet not-denied"></div></div></div><div id="thread-msg-show-hide-container"></div></div>',threadCWinFooter:'<div id="post-in-parent-container" class="flex mT12 post-in-parent"><label class="flexIC curP mL3 max-w100"><div class="zcl-checkbox"><input id="post-in-parent" type="checkbox" ><span class="zcf-tick flexM"></span></div><div class="font14 lineN ellips">{{content}}</div></label></div>',attachmentPostInParentCb:'<div id="post-in-parent-container" class="flex mT12" style="margin-bottom: -15px;">\n        <label class="flexIC curP">\n            <div class="zcl-checkbox">\n                <input id="post-in-parent-attachment" type="checkbox">\n                <span class="zcf-tick flexM"></span>\n            </div>\n            <div class="font14 lineN ellips">{{content}}</div>\n        </label>\n    </div>',moreOptions:{follow:'<div class="zcl-menu-item thread-msg-action follow ellips" data-action="followThread"><div class="zcf-unmute mR10"></div><div><div>'+I18N("thread.follow")+'</div><div class="clr-lp1 font12 mT2">'+I18N("thread.notify.new")+"</div></div></div>",unfollow:'<div class="zcl-menu-item thread-msg-action unfollow ellips" data-action="unfollowThread"><div class="zcf-mute mR10"></div><div><div>'+I18N("thread.unfollow")+'</div><div class="clr-lp1 font12 mT2">'+I18N("thread.notnotify.new")+"</div></div></div>",addfollowers:'<div class="zcl-menu-item thread-msg-action" data-action="openAddFollowersPopUp"><div class="zcf-memberAdd mR10"></div><div>'+I18N("thread.add.followers")+"</div></div>"},replyPreviewContainer:'<blockquote class="quotedmsgdiv" purpose="viewreplied"><span class="msi-reply zcclr floatl"></span>{{replypreview}}</blockquote>',search:{container:'<div id={{id}} chatid={{chatId}} class="flex-col wh100 ovrflwH">\n        </div>',list_item:`\n        <div class="zcl-list-item pL10 {{unread_cls}} {{closedthreadclass}}" list-item data-threadchid={{thread_chat_id}} data-parentmsguid={{parentmsguid}} data-msgtime="{{msgtime}}" data-msgsender="{{msgsender}}">\n            <div class="posrel fshrink mR10 {{hide_class}}">\n                <img elemtype="user" hover="true" src="{{img_url}}" class="zcl-list-item-img36">\n                <em class="type-icon thread-type-icon flexM zcf-fillthread"></em>\n            </div>\n            <div class="flexG ellips">\n                <div class="ellips {{title_class}}">{{thread_chat_title}}</div>\n                <div class="clr8 font13 mT3">{{last_message}}</div>\n            </div>\n            <div class="clr-lp2 font12 fshrink"> \n                {{msg_time_html}} \n            </div>\n            {{unread_count_html}}\n            <div class="fshrink thread-list-options flexC">\n                <div data-action="openThreadChat" title="${I18N("thread.open.new")}" class="fshrink mL15 zcl-icon zcl-icon--default zcf-popout zcl-list-item-icon-right"></div>\n            </div>\n        </div>`,matchedMsg:'<div class="zcunrdltmsg floatl ellips">\n            {{senderName}}\n            <div class="floatl ellips lastMsg">{{msg}}</div>\n        </div>',matchedMsgSender:'<span class="zcunrdname floatl ellips {{bold_class}}">{{senderName}}</span>\n        <span class="zcunrdmsg">:</span>',unread_count:'<div class="LHS-count">{{count}}</div>',searchBar:`\n        <div class="thread-popup-search">\n            <div class="zcl-search2 active">\n                <div class="zcl-seach-icon zcf-search2"></div>\n                <div class="zcl-search-input flexC">\n                    <input id="search-thread-messages"  type="text" placeholder="${I18N("thread.search.placeholder")}"> \n                    <span data-action="clearSearch" class="zcl-search-clear">${I18N("common.clear")}</span>\n                </div>\n            </div>\n        </div>`,autoFollowThreads:`\n        <div class="thread-popup-autofollow flexC">\n            <div class="fontB font15 flexG ellips">\n            {{title}}\n            </div>\n            <div class="flexC fshrink mL12">\n                <span class="zcf-unmute clr-S font12 mT2"></span>\n                <span class="font14 clr-S mL6">${I18N("threadchat.autofollow")}</span>\n                <label id="auto-follow-container" class="zcl-switch zcl-switch-sm no-icon mL6">\n\t    \t\t\t<input id="auto-follow-threads" type="checkbox" chatid="{{chatId}}" {{checked}} >\n\t    \t\t\t<span class="slider">\n\t    \t\t\t\t<em class="switch"></em><div class="zcl-dot--loader"><span></span><span></span><span></span></div>\n\t    \t\t\t</span>\n\t\t\t\t</label>\n            </div>\n        </div>`,closedThreadCheckBox:`\n        <div id="close-thread-cb-container" class="flex-col pL20 pB5">\n            <label class="flexIC curP">\n                <div class="zcl-checkbox">\n                    <input id="closed-threads-cb" type="checkbox"  chatid="{{chatId}}" {{checked}}>\n                    <span class="zcf-tick flexM"></span>\n                </div>\n             <span class="zcf-closethread font13 mL4 mR8 pT2"></span>\n             <div class="font13 lineN ellips">${I18N("thread.close.include")}</div>\n             </label>\n        </div>`,head:'<div class="thread-popup-head fshrink">\n            {{auto_follow_threads}}\n            {{search_bar}}\n            {{close_threads_cb}}    \n            {{tabs}}\n        </div>',body:`<div id="followed-list" class="thread-popup-main flexG ovrflwA p10" ></div>\n            <div id="unfollowed-list" class="thread-popup-main flexG ovrflwA p10 dN" ></div>\n            <div id="followed-list-search-container" class="dN ovrflwA  flex-col flexG thread-popup-main thread-accordion-container"></div>\n            <div id="unfollowed-list-search-container" class="dN ovrflwA flex-col flexG thread-popup-main thread-accordion-container"></div>\n            <div id="bottomloader" class="hstrset dN"> <div class="hst-lodngsb">${I18N("common.loading")}<span class="hst-loadng"></span></div></div>\n        `,followed_title_search_body:`<div id="followed-title-search-head" class="clr-S font14 fontB mTB5 pLR20 line28 fshrink flexC thread-accordion-title cur bg-clr2" data-action="onTitleHeaderClick">\n            <span id="thread-title-accordion-arrow" class="mR8 zcf-pointer clr-icon font12"></span>\n            <span class="flexG">${I18N("threads.title")}</span>\n        </div>\n        <div id="followed-title-search-body" class="ovrflwA thread-accordion-body thread-title-search-body pLR10">{{list}}</div>\n        {{showMore}}\n        `,unfollowed_title_search_body:`<div id="unfollowed-title-search-head" class="clr-S font14 fontB mTB5 pLR20 line28 fshrink flexC thread-accordion-title cur bg-clr2" data-action="onTitleHeaderClick">\n            <span id="thread-title-accordion-arrow" class="mR8 zcf-pointer clr-icon font12"></span>\n            <span class="flexG">${I18N("threads.title")}</span>\n        </div>\n        <div id="unfollowed-title-search-body" class="ovrflwA thread-accordion-body thread-title-search-body pLR10">{{list}}</div>\n        {{showMore}}\n        `,followed_message_search_body:`<div id="followed-message-search-head" class="clr-S font14 fontB mB5 pLR20 line28 fshrink flexC thread-accordion-title cur  bg-clr2" data-action="onMessageHeaderClick">\n            <span id="thread-message-accordion-arrow" class="mR8 zcf-pointer clr-icon font12"></span>\n            <span class="flexG">${I18N("common.messages")}</span>\n        </div>\n        <div id="followed-message-search-body" class="ovrflwA thread-accordion-body flx1 mT5 pLR10">{{list}}{{showMore}}</div>\n        `,unfollowed_message_search_body:`<div id="unfollowed-message-search-head" class="clr-S font14 fontB mB5 pLR20 line28 fshrink flexC thread-accordion-title cur bg-clr2" data-action="onMessageHeaderClick">\n            <span id="thread-message-accordion-arrow" class="mR8 zcf-pointer clr-icon font12"></span>\n            <span class="flexG">${I18N("common.messages")}</span>\n        </div>\n        <div id="unfollowed-message-search-body" class="ovrflwA thread-accordion-body flx1 mT5 pLR10">{{list}}{{showMore}}</div>\n        `,bottom_loader:`<div id="{{id}}" class="hstrset thread-accordion-loader"> <div class="hst-lodngsb">${I18N("common.loading")}<span class="hst-loadng"></span></div></div>`,show_more:`<div id="{{id}}" class="flex justifyE font14 clr-theme curP p10 fshrink" data-action="{{action}}">${I18N("app.show.more")}...</div>`,tabs:'<div class="zcl-hor-tab">\n            {{followed_tab}}\n            {{unfollowed_tab}}\n        </div>',followed_tab:`<div id="followed-tab" data-action="onFollowedTabClick" class="zcl-hor-tab-item showImp sel textL">${I18N("threadchat.followed")}<div id="followed-tab-unread" class="LHS-count dN"></div> </div>`,unfollowed_tab:`<div id="unfollowed-tab" data-action="onUnfollowedTabClick" class="zcl-hor-tab-item showImp textL">${I18N("threadchat.unfollowed")}</div>`,main_loader:'<div id="mainLoader" loader_dom class="wh100 flexM"><div class="zcl-rloader zcl-rloader-sm"></div></div>'},threadCwinActions:{follow:'<div id="followThread" class="zcl-menu-item  ellips dN" purpose="actions"><span class="zcl-menu-item-icn zcf-unmute"></span><span class="ellips">'+I18N("thread.follow")+"</span></div>",closeThread:'<div id="closeThread" class="zcl-menu-item zcl-neg-menu-item ellips dN" purpose="actions"><span class="zcl-menu-item-icn zcf-closethread"></span><span class="ellips">'+I18N("thread.close")+"</span></div>",reopenThread:'<div id="reopenThread" class="zcl-menu-item ellips dN" purpose="actions"><span class="zcl-menu-item-icn zcf-startthread"></span><span class="ellips">'+I18N("thread.reopen")+"</span></div>",unfollow:'<div id="unfollowThread" class="zcl-menu-item zcl-neg-menu-item ellips dN" purpose="actions"><span class="zcl-menu-item-icn zcf-mute"></span><span class="ellips">'+I18N("thread.unfollow")+"</span></div>"}},ThreadCardMsgList=function(e,t,a){this.threadCardUIInstance=e,MessageList.call(this,t,a)};ThreadCardMsgList.prototype=Object.create(MessageList.prototype),ThreadCardMsgList.prototype.constructor=ThreadCardMsgList,ThreadCardMsgList.prototype.super=MessageList.prototype,ThreadCardMsgList.prototype.isThreadCardMsgList=!0,ThreadCardMsgList.prototype.addInMsgMap=function(e){if(e)return this.threadCardUIInstance.addAdditionalPropsForThreadCardMsg(e),this.super.addInMsgMap.apply(this,arguments)};var ThreadCardMsgStorage=function(e,t){this.threadCardUIInstance=t,MessageStorage.call(this,e),this.getList().setTopMore(!0)};ThreadCardMsgStorage.prototype=Object.create(MessageStorage.prototype),ThreadCardMsgStorage.prototype.constructor=ThreadCardMsgStorage,ThreadCardMsgStorage.prototype.super=MessageStorage.prototype,ThreadCardMsgStorage.prototype.isThreadCardMsgStorage=!0,ThreadCardMsgStorage.prototype.resendMessage=async function(e){return this.threadCardUIInstance.sendMessageToServer(e)},ThreadCardMsgStorage.prototype.getNewMessageList=function(e){return void 0===e?new ThreadCardMsgList(this.threadCardUIInstance):new ThreadCardMsgList(this.threadCardUIInstance,e,this.getChid())},ThreadCardMsgStorage.prototype.addNewMessage=function(e,t){this.threadCardUIInstance.beforeAddingNewMessage(e,t)&&(this.super.addNewMessage.call(this,e),this.threadCardUIInstance.afterAddingNewMessage(t,e))},ThreadCardMsgStorage.prototype.handleFetch=function(e){var t={};if(!$.isEmptyObject(e)){var a=e[e.length-1];a.hasOwnProperty("message_count")&&(t.totalMsgCount=a.message_count,e.splice(e.length-1))}var r=this.super.handleFetch.apply(this,arguments);return t.fetchCount=e.length,{...t,...r}},ThreadCardMsgStorage.prototype.handleTopMessages=function(e){var t=e&&e.length>0?e[0]:null;this.super.handleTopMessages.apply(this,arguments),t&&this.getList().setTopMore(MsgUtil.isChatMoreMsg(t))},ThreadCardMsgStorage.prototype.getExactMessageByTime=function(e,t){return this.super.getExactMessageByTime.call(this,e,t,1).then(this.onTranscriptFetchSuccess.bind(this))},ThreadCardMsgStorage.prototype.fetchTopMessages=function(){var e=this.super.fetchTopMessages.apply(this,arguments);return e.then(this.onTranscriptFetchSuccess.bind(this))},ThreadCardMsgStorage.prototype.onTranscriptFetchSuccess=function(e){return this.threadCardUIInstance.onTopTranscriptFetchSuccess(),e},ThreadCardMsgStorage.prototype.threadStateUpdateCallBack=function(e){e?this.threadCardUIInstance.onThreadClose():this.threadCardUIInstance.onThreadReopen()},ThreadCardMsgStorage.prototype.fetchInBetween=function(e,t){return this.super.fetchInBetween.call(this,e,t,ThreadChatUtils.constants.IN_BETWEEN_MSG_LIMIT).then(this.onTranscriptFetchSuccess.bind(this))},ThreadCardMsgStorage.prototype.isEmpty=function(){return this.getList().isEmpty()},ThreadCardMsgStorage.prototype.getSize=function(){return this.getList().getSize()},ThreadCardMsgStorage.prototype.getFirstMsgUid=function(){var e=this.getList().getFirstMessage();e&&e.getMsguid()},ThreadCardMsgStorage.prototype.getNewMessagesCount=function(){var e=ConversationsList.getUnreadTime(this.chid);return-1==e?0:this.getList().getTotalMessagesCountFromSpecificTime(e)},ThreadCardMsgStorage.prototype.fetchRecentNMessages=function(e){var t=ThreadChatUtils.constants.NEW_MSG_THRESHOLD;return e=void 0===e||e>t?t:e,this.setLinesLimit(e),this.super.initialFetch.call(this)},ThreadCardMsgStorage.prototype.removeFirstMessage=function(){var e=this.getList(),t=e.getFirstMessage();t&&(e.remove(t),this.getView().remove(t.getMsguid()))},ThreadCardMsgStorage.prototype.handleAfterRead=function(){this.threadCardUIInstance.isInNonReplyMode()&&ChatUI.isExist(this.chid)&&this.threadCardUIInstance.updateUIAfterReadInNonReplyMode()},ThreadCardMsgStorage.prototype.openReplyPreview=function(e,t){this.threadCardUIInstance.onDoubleClickMsg(e.closest("[msgtime][mtype]").attr("msguid"))},ThreadCardMsgStorage.prototype.hasTopMore=function(){return this.getList().isTopMore()},ThreadCardMsgStorage.prototype.setLinesLimit=function(e){this.linesLimit=e},ThreadCardMsgStorage.prototype.getLinesLimit=function(){return this.linesLimit},ThreadCardMsgStorage.prototype.getAdditionalInfoForTranscriptFetch=function(){return{isThreadCardTranscriptFetch:!0}},ThreadCardMsgStorage.prototype.clearUnreadOnDestroy=function(){};var ThreadCard,ThreadCardMsgView=function(e,t,a,r){MessageView.call(this,e,t,a),this.threadCardUIInstance=r};ThreadCardMsgView.prototype=Object.create(MessageView.prototype),ThreadCardMsgView.prototype.constructor=ThreadCardMsgView,ThreadCardMsgView.prototype.super=MessageView.prototype,ThreadCardMsgView.prototype.initPermission=function(){this.super.initPermission.apply(this,arguments),this.permissions.isThreadCardReplyMsg=!0,this.permissions.avoidNewMessageDom=!0},ThreadCardMsgView.prototype.handleCustomRead=function(){this.threadCardUIInstance.clearUnreadDoms()},ThreadCardMsgView.prototype.removeNavUnreadCount=function(){},ThreadCardMsgView.prototype.getNavElem=function(){return""},ThreadCardMsgView.prototype.getIgnorableMsgSelector=function(){return""},ThreadCardMsgView.prototype.getEntireMessageForReplace=function(e){return this.getEntireMessage(e)},ThreadCardMsgView.prototype.getLoadingHtml=function(e,t){return $WC.template.replace(Template.transLoading.small,{position:e})},ThreadCardMsgView.prototype.handleError=function(e){if(e||e.position)return e.empty=!1,this.super.handleError.apply(this,arguments)},ThreadCardMsgView.prototype.remove=function(e){this.getEntireMessage(e).remove()},ThreadCardMsgView.prototype.getFirstMsgUid=function(){return this.view.find("[msguid]").first().attr("msguid")},ThreadCardMsgView.prototype.isSenderInfoConstructedForFirstVisibleMsg=function(){return"sender"==this.view.children(":first").attr("purpose")},ThreadCardMsgView.prototype.constructSenderForFirstVisibleMsg=function(){if(!this.isSenderInfoConstructedForFirstVisibleMsg()){var e=this.getFirstMsgUid();if(e){var t=this.threadCardUIInstance.getMessage(e),a=ThreadChatUtils.isUnreadMessage(this.getChid(),t),r=MsgTemplate.getSenderField(t.msgobj,{isnew:a});this.getMessage(e).before(r)}}},ThreadCard=function(){var e=function(e){var t=i(e[0]);t&&t.handleVisibility()},t=function(e){$("#"+e.getId()).prev("[purpose=sender]").show()},a=function(e){$("#"+e.getId()).prev("[purpose=sender]").hide()},r=function(e){if(e){var t=e.getParentMessage();if(t){var a=t.getNext();if(a&&a instanceof CommonMessage){var r=t.getSender();if(a.getSender()==r)return a}}}},o=function(e){var t=r(e);if(t){var a=e.parentChatStorage.getView();if(!(0!=a.getSender(t.getMsguid()).length)){var o=ThreadChatUtils.isUnreadMessage(t.msgobj.chid,t),s=MsgTemplate.getSenderField(t.msgobj,{isnew:o});a.getMessage(t.getMsguid()).before(s)}}},s=function(e){var t=r(e);t&&!t.isThreadParentMessage()&&e.parentChatStorage.getView().getSender(t.getMsguid()).remove()},n=function(e){var t=e[0].dataset;return StorageManager.getStorage(t.parentChid,t.parentViewid).getThreadCards().getInstanceByMsgUid(t.parentMsguid)},i=function(e){var t=e.dataset,a=StorageManager.getStorage(t.parentChid,t.parentViewid);return a?a.getThreadCards().getInstanceByMsgUid(t.msgUid):null};return{getUI:function(e,t,a){if(e&&t&&a)return new ThreadCardUI(e,t,a).getHtml()},createInCwin:function(e,t){var r=e.getStorage(),s=r.getList().getMessage(t);(s=window.cloneMessageNode(s,r.getChid())).tempThread=!0,r.replaceMessage(s);var n=r.getThreadCards().getInstanceByMsgUid(t);n.convertToReplyMode(!0),a(n),o(n)},removeFromCwin:function(e,a){var r=e.getStorage(),o=r.getThreadCards().getInstanceByMsgUid(a);t(o),s(o);var n=r.getList().getMessage(a);(n=window.cloneMessageNode(n,r.getChid())).tempThread=!1,n.isThreadCard=!0,n.getMtype()==$zcg.DELETE_MTYPE?r.deleteMessage(n):r.replaceMessage(n),delete n.isThreadCard,r.getThreadCards().deleteThreadCardUIInstance(a),r.onThreadCardReferenceUpdate()},handleVisibileDoms:function(e,t){var a=ChatUI.getWin(t);a&&a.getCwinThreadController().handleVisibleThreadCards(e)},getVisibleDomHandlersArray:function(t){return t.reverse().map((function(t){return e.bind(null,t)}))},showReplyPreview:function(e,t){var a=e.closest("[thread-card]")[0].dataset;StorageManager.getStorage(a.parentChid,a.parentViewid).getThreadCards().getInstanceByMsgUid(a.msgUid).showReplyPreview(t)},removePreviousSenderName:function(e){$("#"+e.getId()).prev("[purpose=sender]").remove()},constructNextSenderName:o,handleResend:function(e){n(e).handleResend(e.attr("msgid"))},handleResendAll:function(e){n(e).handleResendAll()},handleRemoveUnsentMsg:function(e){n(e).removeMessage(e.attr("msgid"))},openComposerAndFetchReplies:function(e){var t=e.closest("[thread-card]")[0].dataset;StorageManager.getStorage(t.parentChid,t.parentViewid).getThreadCards().getInstanceByMsgUid(t.msgUid).openComposerAndFetchReplies()},getUIInstanceFromThreadCardElement:i}}();var ThreadCardUI=function(e,t,a){this.id=window.getEventId(),this.parentMsgUid=a,this.parentChatId=e,this.parentViewId=t,this.parentChatStorage=StorageManager.getStorage(this.parentChatId,this.parentViewId),this.parentChatStorage?(this.threadChatId=this.getParentMsgInfo().threadChatId||null,this.messageStorage=null,this.createMessageStorage(),this.totalMsgCount=this.getParentMessage().isThreadParentMessage()?+this.getParentMessage().getThreadInfo().getThreadMsgCount():0,this.el=null,this.init(),this.DOM_CACHE=new ThreadCardDomCache($(this.el)),this.objectUrls=new Set):ThreadChatUtils.log("Parent chat storage not exists"+e+"_"+t)};ThreadCardUI.prototype.isThreadCard=!0,ThreadCardUI.prototype.hasReaction=$Cwin.prototype.hasReaction,ThreadCardUI.prototype.getReaction=$Cwin.prototype.getReaction,ThreadCardUI.prototype.hasMessage=$Cwin.prototype.hasMessage,ThreadCardUI.prototype.getDomCache=function(){return this.DOM_CACHE},ThreadCardUI.prototype.getId=function(){return this.id},ThreadCardUI.prototype.init=function(){this.initThreadCardElement(),this.clearOldInstanceInParentStorageIfExists(),this.addInstanceInParentChatStorage(),this.setInitialFollowerCountInParticipantObj(),this.mockChatWindowProps()},ThreadCardUI.prototype.createMessageStorage=function(){this.messageStorage=new ThreadCardMsgStorage(this.threadChatId||this.parentMsgUid,this)},ThreadCardUI.prototype.addObjectUrl=function(e){this.objectUrls.add(e)},ThreadCardUI.prototype.revokeAllObjectUrls=function(){this.objectUrls.forEach((function(e){URL.revokeObjectURL(e)}))},ThreadCardUI.prototype.mockChatWindowProps=function(){this.storage=this.messageStorage,this.allowedtriggers=$Util.cloneArray(Composer.defaultTriggers.allowedtriggers),this.suggesttoadd=[],Object.defineProperty(this,"chid",{get:function(){return this.getThreadChatId()}}),Object.defineProperty(this,"storage",{get:function(){return this.getStorage()}})},ThreadCardUI.prototype.setInitialFollowerCountInParticipantObj=function(){this.getParentMessage().isThreadParentMessage()&&this.createParticipantObjAndUpdatePcount()},ThreadCardUI.prototype.getParentMsgInfo=function(){var e=this.getParentMessage();return e.isThreadParentMessage()?e.getThreadInfo().getInfo():{}},ThreadCardUI.prototype.isThreadChat=function(){return!0},ThreadCardUI.prototype.getThreadCardDom=function(){return this.DOM_CACHE.getThreadCard()},ThreadCardUI.prototype.win=function(){return this.getThreadCardDom()},ThreadCardUI.prototype.clearOldInstanceInParentStorageIfExists=function(){var e=this.getParentMsgUid(),t=this.parentChatStorage.getThreadCards();t.hasThread(e)&&t.deleteThreadCardUIInstance(e)},ThreadCardUI.prototype.addInstanceInParentChatStorage=function(){var e=this.getCwinProxy()||this;this.parentChatStorage.getThreadCards().addThreadCardUIInstance(this.getParentMsgUid(),e),this.parentChatStorage.onThreadCardReferenceUpdate()},ThreadCardUI.prototype.getCwinProxy=function(){if(window.Proxy){var e=ThreadChatUtils.getDummyCwinObj();return new Proxy(this,{get:function(t,a){return!(a in t)&&a in e&&(t[a]="function"==typeof e[a]?function(){}:void 0),t[a]}})}},ThreadCardUI.prototype.getCurrentMode=function(){return this.currentMode||ThreadChatUtils.constants.MODES.NON_REPLY},ThreadCardUI.prototype.setCurrentMode=function(e){this.currentMode=e},ThreadCardUI.prototype.getComposerInstance=function(){return this.composerInstance},ThreadCardUI.prototype.setThreadChatId=function(e){this.threadChatId=e},ThreadCardUI.prototype.getThreadChatId=function(){return this.threadChatId},ThreadCardUI.prototype.initComposerInstance=function(){this.composerInstance=this.createAndGetComposerInstance()},ThreadCardUI.prototype.increaseTotalMsgCountByOne=function(){this.totalMsgCount++},ThreadCardUI.prototype.getTotalMsgCount=function(){return this.totalMsgCount},ThreadCardUI.prototype.updateTotalMsgCountUI=function(){this.DOM_CACHE.getTotalMsgContainer().text(this.getTotalReplies())},ThreadCardUI.prototype.updateUnreadMsgCountBeforeReconnection=function(){var e=this.getThreadChatId();ConversationsList.isExists(e)&&(this.unreadMsgCountBeforeReconnection=this.getUnreadMsgCount())},ThreadCardUI.prototype.resetUnreadMsgCountBeforeReconnection=function(){this.unreadMsgCountBeforeReconnection=0},ThreadCardUI.prototype.getUnreadMsgCount=function(){return ConversationsList.getUnreadCount(this.getThreadChatId())},ThreadCardUI.prototype.getUnreadMsgCountBeforeReconnection=function(){return this.unreadMsgCountBeforeReconnection||0},ThreadCardUI.prototype.handleBeforeRemovingUnreadCountOnReconnection=function(){this.updateUnreadMsgCountBeforeReconnection()},ThreadCardUI.prototype.createAndGetComposerInstance=function(){var e={chatId:this.getThreadChatId()||this.getParentChatId(),parentChatId:this.getParentChatId(),attachments:!0,attachmentOptions:{hasSnippet:SecurityManager.hasPermissionForUploadType(MUploadConfigs.CODE_SNIPPET),hasWhiteBoard:SecurityManager.hasPermissionForUploadType(MUploadConfigs.WHITE_BOARD),hasAttachCloud:!1,hasUpload:!0},gifs:!0,recorder:!0,atMention:!0,getSenderAndReplyToMsgUid:this.getSenderAndReplyToMsgUid.bind(this),onChange:this.markRead.bind(this),onCodeSnippetClick:this.openCodeSnippetEditor.bind(this),onWhiteBoardClick:this.openWhiteBoard.bind(this),onFileSelect:this.handleFileSelect.bind(this),onSendVoiceRecording:this.handleSendVoiceRecording.bind(this),onAttachmentPaste:this.onAttachmentPaste.bind(this),enterCallBack:this.onEnterInComposer.bind(this),doubleEnterCallBack:this.onDoubleEnterInComposer.bind(this),upArrowPressCallBack:this.onUpArrowPress.bind(this),hasAtMentionPermission:this.hasAtMentionPermission.bind(this),customAttributes:{threadchat:!0}},t=this.getParentCwin();if(t&&!t.isComposerEmpty){var a=t.getDomCache().getComposer();e.defaultValue=a.html().trim(),$WC.DivEditor.clear(a[0]),t.onComposerEmpty(),_rAF(()=>this.getComposerInstance().afterRender())}var r=ComposerComponent.getNewComposerInstance(e);return r.updateAdditionalSearchCriteria(this.getAdditionalSearchCriteria()),r},ThreadCardUI.prototype.getParentCwin=function(){return ChatUI.getWin(this.getParentChatId())},ThreadCardUI.prototype.showInviteMemberPromptbanner=function(){var e=MsgTemplate.getUserPromptHtml({chid:this.getThreadChatId(),isThreadChat:!0,parentChatId:this.getParentChatId(),suggesttoadd:this.suggesttoadd});this.DOM_CACHE.getPromptBanner().html(e).show()},ThreadCardUI.prototype.addAtMentionedMembers=function(e){e.stopPropagation(),this.clearInviteMemberPromptbanner(),Composer.handleAddMember(this.suggesttoadd,this.getThreadChatId())},ThreadCardUI.prototype.clearUserPrompt=function(){this.suggesttoadd&&(this.suggesttoadd=void 0,this.clearInviteMemberPromptbanner())},ThreadCardUI.prototype.cancelAtMentionedMembersAdd=function(e){e.stopPropagation(),this.clearInviteMemberPromptbanner()},ThreadCardUI.prototype.clearInviteMemberPromptbanner=function(){this.DOM_CACHE.getPromptBanner().hide().html("")},ThreadCardUI.prototype.onEnterInComposer=function(){var e=this.getComposerInstance();if(!e.isContentEmpty()){var t=e.getMsgContent();this.sendMessage(t),e.clearContent()}},ThreadCardUI.prototype.onDoubleEnterInComposer=function(){this.sendMessage("---")},ThreadCardUI.prototype.hasAtMentionPermission=function(){if(!this.isNonCwinView())return this.getParentCwin().currenttriggers.includes("@")},ThreadCardUI.prototype.onUpArrowPress=function(){var e=MessageOperations.edit,t=e.getEditableLastMsg(this),a=e.isSameExist(this.getThreadChatId(),t.msguid);t&&!a&&e.init(this.getThreadChatId(),t.msguid)},ThreadCardUI.prototype.canPostInParent=function(){return this.DOM_CACHE.getPostCheckBox().is(":checked")},ThreadCardUI.prototype.sendMessage=function(e){var t=this.getStorage().getChid(),a=this.getReplyToMsgUidAndContent(),r={chatId:t,lastMessage:this.getStorage().getList().getLastMessage(),msg:e,repliedMsgUid:a.msgUid,repliedMsgContent:a.content,postInParent:this.canPostInParent()};r.parentChatInfo={parentChatId:this.getParentChatId(),parentViewId:this.getParentViewId(),parentMsgUid:this.getParentMsgUid()};var o=ThreadChatUtils.getMockMessage(r);this.addNewMsgInStorage(o,!0),this.sendMessageToServer(o),this.closeReplyPreview()},ThreadCardUI.prototype.getSendAPIParams=function(e){var t=e.getObject();return{threadMsgId:this.getParentMsgUid(),threadChatId:this.getThreadChatId(),parentChatId:this.getParentChatId(),parentMsgSender:this.getParentMessage().getSender(),chid:this.getParentChatId(),msg:t.msg,time:e.getTime(),editParams:{},replyToMsgUid:t.repliedmsguid,postInParent:t.postInParent,isParentMsgReply:t.repliedmsguid&&this.parentChatStorage.getList().hasMessage(t.repliedmsguid)}},ThreadCardUI.prototype.handleResend=function(e){this.getStorage().handleReSend(e)},ThreadCardUI.prototype.handleResendAll=function(){this.getStorage().handleReSendAll()},ThreadCardUI.prototype.removeMessage=function(e){this.getStorage().removeMessage(e,!0)},ThreadCardUI.prototype.getStorage=function(){return this.messageStorage},ThreadCardUI.prototype.sendMessageToServer=function(e){var t=this.getSendAPIParams(e);return ThreadApis.sendMessage(t).then(function(e){if(null===this.getThreadChatId()){var t=Array.isArray(e)?e[0].objString:e;this.handleThreadChidUpdate(t)}}.bind(this),function(){return this.getStorage().handleSendFailed(t.time),Promise.reject()}.bind(this))},ThreadCardUI.prototype.handleThreadChidUpdate=function(e){if(null===this.getThreadChatId()){var t=e.threadchatid||e.chat_id;this.setThreadChatId(t),this.addThreadInfoInParentMsgAndUpdateUI(e),this.updateStorageFromMsgUidToThreadChid(),this.updateMsgAreaFromMsgUidToThreadChid(),this.createOrUpdateParticipantObjPartCount(),this.updateComposerInstanceChatId(),this.addAsActiveCwin(),ThreadChatUtils.updateFollowersCountInUI(this.getParentChatId(),this.getParentMsgUid(),ThreadChatUtils.getCurrentPCount(t)),this.handleUIAfterThreadChidUpdate(),Config.isLimitChannelParticipantsResponseEnabled()&&e&&e.meta&&e.meta.mentions&&Participants.handleAddParticipantsSuggestion(e),this.isInReplyMode()&&this.scrollToThreadCardAndFocusComposer()}},ThreadCardUI.prototype.updateComposerInstanceChatId=function(){var e=this.getComposerInstance();e.getChatId()!=this.getThreadChatId()&&(e.updateChatId(this.getThreadChatId()),e.updateAdditionalSearchCriteria(this.getAdditionalSearchCriteria()))},ThreadCardUI.prototype.updateMsgAreaFromMsgUidToThreadChid=function(){var e=this.getStorage().getView();if(e.container.length){var t=e.getAreaId();e.container.attr("messagearea",t),e.container.find("#msgarea").attr("messagearea",t)}},ThreadCardUI.prototype.getAdditionalSearchCriteria=function(){return null==this.getThreadChatId()?{}:{searchin:SearchAgent.SUBSCRIBERS+SearchAgent.UNSUBSCRIBERS+SearchAgent.CONTACTS+SearchAgent.ORGCONTACTS+SearchAgent.BOTS,threadchid:this.getThreadChatId(),parentchid:this.getParentChatId(),isThreadChat:!0}},ThreadCardUI.prototype.createParticipantObjAndUpdatePcount=function(){var e=this.getThreadChatId();e&&!Participants.isExist(e)&&this.updateParticipantObjPCount()},ThreadCardUI.prototype.getFollowersCount=function(){var e=this.getParentMessage();return e.isThreadParentMessage()?e.getThreadInfo().getFollowersCount():0},ThreadCardUI.prototype.getFollowersCountTooltip=function(){var e=this.getFollowersCount(),t=0==e||1==e?"thread.onefollower":"thread.nfollowers";return Resource.getRealValue(t,[e])},ThreadCardUI.prototype.updateFollowersCount=function(e){var t=this.getParentMessage().getThreadInfo();t&&(t.setFollowersCount(e),this.DOM_CACHE.getFollowersCountContainer().attr("title",this.getFollowersCountTooltip())),this.DOM_CACHE.getFollowersCountContainer().attr("title",this.getFollowersCountTooltip()),this.DOM_CACHE.getFollowersCount().text(e)},ThreadCardUI.prototype.openThreadFollowersWindow=function(){if(!this.isNonCwinView()){var e={isThreadChat:!0,parentChatId:this.getParentChatId(),parentMsgUid:this.getParentMsgUid(),threadChatId:this.getThreadChatId(),threadChatTitle:this.getThreadChatTitle(),isFollower:this.amIFollower()};ParticipantsWin.createModelWindow("participants",e.threadChatId,!0,!0,!0,!0,e)}},ThreadCardUI.prototype.updateParticipantObjPCount=function(){Participants.updateParticipantsObj(this.getThreadChatId(),null,this.getFollowersCount())},ThreadCardUI.prototype.createOrUpdateParticipantObjPartCount=function(){this.getThreadChatId()&&this.updateParticipantObjPCount()},ThreadCardUI.prototype.addThreadInfoInParentMsgAndUpdateUI=function(e){if(!this.getParentMessage().isThreadParentMessage()){var t=this.getParentMessage();t.msgobj.thread_information={chat_id:this.getThreadChatId(),msguid:this.getParentMsgUid(),message_count:this.getStorage().getSize(),follower_count:+e.follower_count,is_follower:!0},t.tempThread=!1,t.isEditMessage=!0,this.parentChatStorage.updateMessage(t)}},ThreadCardUI.prototype.addMeAsThreadFollower=function(){this.getParentMessage().getThreadInfo().setIsFollower(!0)},ThreadCardUI.prototype.amIFollower=function(){return this.getParentMessage().getThreadInfo().amIFollower()},ThreadCardUI.prototype.handleUIAfterThreadChidUpdate=function(){this.DOM_CACHE.getThreadCard().attr("data-thread-chid",this.getThreadChatId()),this.DOM_CACHE.getAutoComplete().attr("id","compautocompletethread"+this.getThreadChatId()),this.DOM_CACHE.getViewOptions().removeClass("dN");var e=this.getParentMessage();this.DOM_CACHE.getParentMsgSender().replaceWith(MsgTemplate.getSenderField(e.getObject(),{isThreadMsg:!0},e))},ThreadCardUI.prototype.updateStorageFromMsgUidToThreadChid=function(){this.getStorage().updateChatId(this.getThreadChatId());var e=StorageManager.getStorages();if(!e.hasOwnProperty(this.getThreadChatId())){var t=e[this.getParentMsgUid()];e[this.getThreadChatId()]=t,delete e[this.getParentMsgUid()]}},ThreadCardUI.prototype.getParentMessage=function(){return this.parentChatStorage.getList().getMessage(this.getParentMsgUid())},ThreadCardUI.prototype.addNewMsgInStorage=function(e,t){this.getStorage().addNewMessage(e,t)},ThreadCardUI.prototype.beforeAddingNewMessage=function(e,t){return!t&&this.isInvalidNewMessage(e)?(e&&e.getMtype()==$zcg.INFO_MTYPE||(this.increaseTotalMsgCountByOne(),this.updateTotalMsgCountUI()),!1):(this.getStorage().isViewExist()||this.initViewIfNotExists(),e.msgobj.isThreadLastMsg||t||ConversationsList.isExists(e.msgobj.threadchatid)||(e.msgobj.parentmessagesenderid=this.getParentMsgSender(),ThreadChatUtils.createConversationObj(e)),!0)},ThreadCardUI.prototype.addAdditionalPropsForThreadCardMsg=function(e){e.msgobj.isThreadCardReplyMsg=!0;var t=this.getParentMessage();$Date.isSameDay(e.getTime(),t?t.getTime():"")&&(e.avoidDate=!0)},ThreadCardUI.prototype.getMessage=function(e){return this.getStorage().getList().getMessage(e)},ThreadCardUI.prototype.getMessageObject=function(e){return this.getMessage(e).getObject()},ThreadCardUI.prototype.hasReaction=function(e){var t=this.getMessage(e);return t instanceof CommonMessage&&t.hasReaction()},ThreadCardUI.prototype.getMsgOptionsContent=function(e){return this.getThreadCardDom().find("#msgoptns"+this.getThreadChatId()+"_"+e)},ThreadCardUI.prototype.getMsgOptionsPopUpContainer=function(e){return this.getThreadCardDom().find("#optnslist"+this.getThreadChatId()+"_"+e)},ThreadCardUI.prototype.getMessageOptions=function(){return MessageOperations.DELETE},ThreadCardUI.prototype.getParentMsgSender=function(){return this.parentChatStorage.getList().getMessage(this.getParentMsgUid()).getSender()},ThreadCardUI.prototype.afterAddingMockMessage=function(){this.closeReplyPreview()},ThreadCardUI.prototype.handleAfterAddingNewMsg=function(){this.updateTotalMsgCountUI(),this.getStorage().getView().handleViewableArea()},ThreadCardUI.prototype.isInReplyMode=function(){return this.getCurrentMode()==ThreadChatUtils.constants.MODES.REPLY},ThreadCardUI.prototype.isInNonReplyMode=function(){return this.getCurrentMode()==ThreadChatUtils.constants.MODES.NON_REPLY},ThreadCardUI.prototype.afterAddingNewMessage=function(e,t){e?this.afterAddingMockMessage():(!t.msgobj.isThreadLastMsg&&t.isSent()&&t.getMtype()!=$zcg.INFO_MTYPE&&this.increaseTotalMsgCountByOne(),this.isInNonReplyMode()?this.handleAfterNewMsgInNonReplyMode(t):this.isInReplyMode()&&this.handleAfterNewMsgInReplyMode(),t.isSentByMe()&&this.closeReplyPreview(),this.handleAfterAddingNewMsg())},ThreadCardUI.prototype.isInvalidNewMessage=function(e){if(e&&e.msgobj.isThreadLastMsg)return!1;var t=!this.amIFollower()&&!this.isNewUnfollowedThreadChat();if(this.getStorage().getSize()>0)return!1;var a=MsgUtil.isNewMessage(e);return this.isInNonReplyMode()&&(t||!a)},ThreadCardUI.prototype.clearUnreadDoms=function(){this.DOM_CACHE.getUnreadBadge().addClass("dN")},ThreadCardUI.prototype.markRead=function(){this.isUnreadMsgTranscriptFetchFailed||this.getStorage().publishEvent("removeNewMsgNotification")},ThreadCardUI.prototype.handleReaction=function(e,t){this.getStorage().handleReaction(e,t)},ThreadCardUI.prototype.updateUIAfterNewMsg=function(){this.isInNonReplyMode()?this.updateUIAfterNewMsgInNonReplyMode():this.isInReplyMode()&&this.updateUIAfterNewMsgInReplyMode()},ThreadCardUI.prototype.updateUIAfterNewMsgInReplyMode=function(){},ThreadCardUI.prototype.updateUIAfterReadInNonReplyMode=function(){this.clearUnreadDoms()},ThreadCardUI.prototype.updateUIAfterNewMsgInNonReplyMode=function(){this.showOrHideLoadMoreDom()},ThreadCardUI.prototype.showOrHideLoadMoreDom=function(){this.DOM_CACHE.getLoadMoreCont().toggleClass("dN",!this.getStorage().hasTopMore())},ThreadCardUI.prototype.onUnfollow=function(){this.updateFollowUnfollowBtn()},ThreadCardUI.prototype.onFollow=function(){this.updateFollowUnfollowBtn()},ThreadCardUI.prototype.updateFollowUnfollowBtn=function(){this.DOM_CACHE.getFollowUnfollowBtn().replaceWith(MsgTemplate.getThreadFollowOrFollowingButton(this.getParentMessage()))},ThreadCardUI.prototype.isNewUnfollowedThreadChat=function(){return ThreadChatUtils.isNewUnfollowedThreadChat(this.getThreadChatId())},ThreadCardUI.prototype.handleAfterNewMsgInNonReplyMode=function(){var e=this.getStorage();e.getSize()>ThreadChatUtils.constants.NEW_MSG_THRESHOLD&&(this.updateUnreadBadge(),e.removeFirstMessage(),e.getView().constructSenderForFirstVisibleMsg()),this.updateUIAfterNewMsgInNonReplyMode()},ThreadCardUI.prototype.getParentViewId=function(){return this.parentViewId},ThreadCardUI.prototype.getParentChatId=function(){return this.parentChatId},ThreadCardUI.prototype.getParentMsgUid=function(){return this.parentMsgUid},ThreadCardUI.prototype.getId=function(){return this.id},ThreadCardUI.prototype.getMsgObj=function(){return ThreadChatUtils.getMsgObj(this.getParentChatId(),this.getParentViewId(),this.getParentMsgUid())},ThreadCardUI.prototype.focusComposer=function(){this.getComposerInstance().focus()},ThreadCardUI.prototype.focus=function(){this.isInReplyMode()&&this.getComposerInstance().focus()},ThreadCardUI.prototype.clear=function(){this.handleBeforeDestroy(),this.destroyComposer(),this.destroyStorage(),this.removeThreadCardFromActiveCwin()},ThreadCardUI.prototype.handleBeforeDestroy=function(){this.saveDrafts(),this.removeAsFocussedInParentCwin(),this.revokeAllObjectUrls()},ThreadCardUI.prototype.getThreadChatDetailsFromClientOrServer=function(){return ConversationsList.isExists(this.getThreadChatId())?Promise.resolve():ThreadChatUtils.fetchThreadChatDetailsFromServer(this.getThreadChatId())},ThreadCardUI.prototype.saveDrafts=function(){if(!this.isInNonReplyMode()&&null!=this.getThreadChatId()){var e=this.getComposerInstance();if(e&&e.isComposerDirty()){var t=e.getMsgData();t&&$WC.Util.isEmpty(t.message)||this.getThreadChatDetailsFromClientOrServer().then(function(){Drafts.addDraft(this.getThreadChatId(),t.message,t.repliedmsguid)}.bind(this))}}},ThreadCardUI.prototype.destroyComposer=function(){var e=this.getComposerInstance();e&&e.clear()},ThreadCardUI.prototype.handleAfterNewMsgInReplyMode=function(){},ThreadCardUI.prototype.bindClickOutside=function(){var e=this,t={destid:this.getId(),doNotClose:function(t,a,r,o,s){return!e.canClose(t,r,s)},additionalInfo:{parentChatId:this.getParentChatId()},customHide:this.handleClickOutside.bind(this)};Clickoutside.bind(t)},ThreadCardUI.prototype.canClose=function(e,t,a){if(null!=$WC.$Win.current)return!1;if(this.getStorage().getUnSentMessagesCount()>0)return!1;if(this.composerInstance&&this.composerInstance.isContentNotEmpty())return!1;var r=this.getStorage().getView();if(a&&$("#"+a).closest("#"+this.getId()).length>0)return!1;if(a&&a=="edit"+this.getParentChatId())return!1;if(t){var o=$(t.target),s=o.attr("purpose");if("createpost"==s)return!1;if("forward"==s)return!1;if(o.closest("#"+e.destid).length>0)return!1;if(0!=o.closest("#editcontainer"+this.getThreadChatId()).length)return!1}if(r&&1==r.container.find("#editcontainer"+this.getThreadChatId()).length)return!1;var n=RemindersWidgetManager.getWidget();return!(n&&n._parentId==this.getThreadChatId()&&n.getContainer().length>0)&&Clickoutside.currentchain.length>0},ThreadCardUI.prototype.canRemoveThreadCardFromCwin=function(){var e=ChatUI.exist[this.getParentChatId()],t=this.getStorage();return e&&t.getChid()==this.getParentMsgUid()&&0==t.getSize()},ThreadCardUI.prototype.handleClickOutside=function(){this.canRemoveThreadCardFromCwin()?ChatUI.exist[this.getParentChatId()].getCwinThreadController().removeThreadCardUI(this.getParentMsgUid()):(this.markRead(),this.convertToNonReplyMode(),this.scrollToParentMsg())},ThreadCardUI.prototype.noActionThreadCardClick=function(){this.isInNonReplyMode()&&this.getUnreadMsgCount()>0&&this.markRead()},ThreadCardUI.prototype.scrollToParentMsg=function(){var e=ChatUI.getWin(this.getParentChatId());if(e&&!e.ignoreOrientation){var t=e.getStorage().getView(),a=t.getThreadMessage(this.getParentMsgUid());t.scrollToDom(a)}},ThreadCardUI.prototype.handleVisibility=function(){this.fetchUnreadMessages()},ThreadCardUI.prototype.initViewIfNotExists=function(){if(!this.getStorage().isViewExist()){var e=new ThreadCardMsgView(this.getStorage().getChid(),this.getStorage().getId(),this.DOM_CACHE.getReply(),this);this.getStorage().initView(e)}},ThreadCardUI.prototype.destroyStorage=function(){this.getStorage()&&this.getStorage().destroy()},ThreadCardUI.prototype.getPostCheckBoxHtml=function(){var e=this.getParentChatId(),t=Channels.getByChid(e);if(!$.isEmptyObject(t)&&!ChannelsPermission.hasPermission(Channels.ACTIONS.SEND_MESSAGE,t))return"";var a=ConversationsList.get(this.getParentChatId()).getTitle();return CHECK_BOX.getHTML({align:"HR",options:[{id:"post-checkbox",checked:!1,label:Resource.getRealValue("thread.post",a)}]})},ThreadCardUI.prototype.handleComposerClick=function(){this.markRead()},ThreadCardUI.prototype.handleReplyModeDomsAndScrollToComposer=function(){var e=this;$Util.queueAnimation((function(){e.DOM_CACHE.getNonMsgContainer().hide()})),$Util.queueAnimation((function(){e.DOM_CACHE.getComposerAndPostCB().show()})),$Util.queueAnimation((function(){e.DOM_CACHE.getTotalMsgContainer().show()})),$Util.queueAnimation((function(){e.DOM_CACHE.getNonMsgContainer().show()})),$Util.queueAnimation((function(){e.scrollToThreadCardAndFocusComposer()}))},ThreadCardUI.prototype.convertToReplyMode=function(e){var t=ThreadChatUtils.constants.MODES.REPLY;this.getCurrentMode()!=t?(this.setCurrentMode(t),this.isSeparateThreadCwinExists()&&this.closeCwinIfExists(),e&&this.scrollToParentMsgIfAnyOtherThreadCardIsAlreadyFocused(),this.bindClickOutside(),this.initViewIfNotExists(),this.addAsActiveCwin(),this.markRead(),this.renderReplyModeContent(),this.updateTotalMsgCountUI(),this.addAsFocussedInParentCwin(),this.handleReplyModeDomsAndScrollToComposer()):this.focusComposer()},ThreadCardUI.prototype.scrollToThreadCardAndFocusComposer=function(){var e=this;setTimeout((function(){$Util.scrollToView(e.DOM_CACHE.getReplyModeContainer(),e.parentChatStorage.getView().container,{scrollDuration:10,heightwithmargin:!0}),e.focusComposer()}),30)},ThreadCardUI.prototype.onMessageActionsClick=function(e,t,a){if(this.isInNonReplyMode()&&this.destroySeparateCwinAndCreateThreadCwinInstance(),t.attr("thread-card-reply-msg",""),"reply"==a){if(!this.isReplyAllowed())return;this.isInNonReplyMode()&&this.convertToReplyMode()}!MessageOperations.handle[a](this.getThreadChatId(),t,e)&&Clickoutside.handleClickOnChild(e),e.stopPropagation()},ThreadCardUI.prototype.onStarClick=function(e){this.isInNonReplyMode()&&this.destroySeparateCwinAndCreateThreadCwinInstance(),e.stopImmediatePropagation(),StarMessagesUI.showStarOptions($(e.currentTarget),e)},ThreadCardUI.prototype.onfollowUnfollowBtnHover=function(e){var t="mouseenter"==e.type,a=!t,r=this.DOM_CACHE.getFollowUnfollowBtn(),o=r.find("#small-dot-loader").length,s=ThreadChatTemplates.unmuteIcon,n=ThreadChatTemplates.muteIcon;if(!o){var i=!this.amIFollower();t&&r.html(i?I18N("threadchat.follow"):n+I18N("threadchat.unfollow")),a&&r.html(i?I18N("threadchat.follow"):s+I18N("threadchat.followed"))}},ThreadCardUI.prototype.onfollowUnfollowBtnClick=function(e){var t=this.DOM_CACHE.getFollowUnfollowBtn(),a=!this.amIFollower(),r=!a,o={parentchid:this.getParentChatId(),threadchid:this.getThreadChatId(),parentmsguid:this.getParentMsgUid()},s=this,n=function(){t.find("#small-dot-loader").remove(),t.removeClass("curN"),s.updateFollowUnfollowBtn()};t.addClass("curN"),t.append(ThreadChatTemplates.mini.small_dot_loader),r?ThreadChatUtils.unfollowThread(this.getParentChatId(),o).then(n,n):a&&ThreadChatUtils.followThread(this.getParentChatId(),o).then(n,n)},ThreadCardUI.prototype.onReactedAndStarClick=function(e,t){"staroptions"!=e?this.isInReplyMode()||this.destroySeparateCwinAndCreateThreadCwinInstance():this.onStarClick(t)},ThreadCardUI.prototype.destroySeparateCwinAndCreateThreadCwinInstance=function(){this.isSeparateThreadCwinExists()&&this.closeCwinIfExists(),this.addAsActiveCwin(!0)},ThreadCardUI.prototype.addAsActiveCwin=function(e){var t=this.getThreadChatId();null==t||ChatUI.isExist[t]||!e&&this.isInNonReplyMode()||(ChatUI.exist[t]=this.getCwinProxy()||this)},ThreadCardUI.prototype.removeThreadCardFromActiveCwin=function(){var e=this.getThreadChatId();if(null!=e){var t=ChatUI.exist[e];t&&t instanceof ThreadCardUI&&delete ChatUI.exist[e]}},ThreadCardUI.prototype.isSeparateThreadCwinExists=function(){var e=ChatUI.exist[this.getThreadChatId()];return e&&e instanceof $Cwin},ThreadCardUI.prototype.closeCwinIfExists=function(){var e=this.getThreadChatId();if(null!=e){var t=ChatUI.exist[e];t&&t instanceof $Cwin&&ChatUI.removeWindow(e)}},ThreadCardUI.prototype.convertToNonReplyMode=function(e){var t=ThreadChatUtils.constants.MODES.NON_REPLY;return!e&&this.isInNonReplyMode()?this:(this.setCurrentMode(t),this.destroyComposer(),this.removeThreadCardFromActiveCwin(),this.clearMessageAreaAndStorage(),this.clearUnreadDoms(),this.clearUserPrompt(),this.updateTotalMsgCountUI(),this.resetVariablesOnThreadCardCollapse(),this.DOM_CACHE.getReplyModeContainer().html(""),this.DOM_CACHE.getComposerAndPostCB().hide(),this)},ThreadCardUI.prototype.resetVariablesOnThreadCardCollapse=function(){this.replyToMsgUid=null,this.removeAsFocussedInParentCwin()},ThreadCardUI.prototype.hasReplyToMsgUid=function(){return Boolean(this.replyToMsgUid)},ThreadCardUI.prototype.getReplyToMsgUid=function(){return this.replyToMsgUid},ThreadCardUI.prototype.onDoubleClickMsg=function(e){this.isReplyAllowed()&&(this.isInNonReplyMode()&&(this.destroySeparateCwinAndCreateThreadCwinInstance(),this.convertToReplyMode()),this.showReplyPreview(e))},ThreadCardUI.prototype.showReplyPreview=function(e){this.replyToMsgUid=e;var t=this.getStorage().getList().getMessage(e)||this.parentChatStorage.getList().getMessage(e),a=ThreadChatUtils.getReplyPreviewLayout(t.msgobj,!0);this.DOM_CACHE.getMsgPreview().html(a),this.DOM_CACHE.getMsgPreviewContainer().show(),this.focusComposer()},ThreadCardUI.prototype.closeReplyPreview=function(){this.replyToMsgUid&&(this.replyToMsgUid=null,this.DOM_CACHE.getMsgPreview().html(""),this.DOM_CACHE.getMsgPreviewContainer().hide())},ThreadCardUI.prototype.isReplyPreviewOpen=function(){return Boolean(this.replyToMsgUid)},ThreadCardUI.prototype.getReplyToMsgUidAndContent=function(){var e,t;if(this.replyToMsgUid){e=this.replyToMsgUid;var a=this.getStorage().getList().getMessage(e)||this.parentChatStorage.getList().getMessage(e);t=ThreadChatUtils.getReplyPreviewLayout(a.msgobj)}return{msgUid:e,content:t}},ThreadCardUI.prototype.getSenderAndReplyToMsgUid=function(){var e=this.getReplyToMsgUidAndContent().msgUid;if(e)return this.getStorage().getList().getMessage(e).getSender()+"_"+e.split("%20")[0]},ThreadCardUI.prototype.getAdditionalDataObj=function(){var e={post_in_parent:this.canPostInParent()};return this.getParentMessage().isThreadParentMessage()||(e.thread_message_id=this.getParentMsgUid()),e},ThreadCardUI.prototype.getMessageDiv=function(e){return this.getStorage().getView().getMessage(e)},ThreadCardUI.prototype.isNonCwinView=function(){return this.parentChatStorage.getView().isNonCwinView},ThreadCardUI.prototype.canAvoidUnreadTranscriptFetch=function(e){var t=this.getThreadChatId();if(!t)return!0;var a=this.getStorage().getSize(),r=ConversationsList.getUnreadCount(t);if(0==r)return!0;var o=this.getStorage().hasTopMore(),s=this.isUnreadMsgTranscriptFetchFailed,n=!this.amIFollower()&&!this.isNewUnfollowedThreadChat();return!(o&&!this.isNonCwinView()&&!this.isUnreadMsgsFetchingInProgress()&&!this.isInReplyMode())||(r>0&&a>0&&(a>=r||a>=ThreadChatUtils.constants.NEW_MSG_THRESHOLD)||!(!n&&!s))},ThreadCardUI.prototype.fetchUnreadMessages=function(e){return this.canAvoidUnreadTranscriptFetch(e)?Promise.resolve():this.fetchUnreadMsgsFromServer()},ThreadCardUI.prototype.isViewEmpty=function(){var e=this.getStorage().getView();return!e||e.isEmpty()},ThreadCardUI.prototype.hideReplyHereDoms=function(){this.DOM_CACHE.getLoadMoreCont().addClass("dN")},ThreadCardUI.prototype.clearMessageAreaAndStorage=function(){return this.hideReplyHereDoms(),this.destroyStorageAndCreateNewStorage(),this},ThreadCardUI.prototype.destroyView=function(){var e=this.getStorage().getView();e&&e.clearView()},ThreadCardUI.prototype.destroyStorageAndCreateNewStorage=function(){this.destroyView(),this.destroyStorage(),this.createMessageStorage()},ThreadCardUI.prototype.handleFileSelect=function(e,t){"html5"===t&&FileUploadUI.handlePreview(this.getParentChatId(),e,!1,!1,this.getOptionsForAttachments())},ThreadCardUI.prototype.handleSendVoiceRecording=function(e,t,a){e&&ZCMediaRecorderImpl.sendRecordedFile(e,t,a,this.getOptionsForAttachments())},ThreadCardUI.prototype.onAttachmentPaste=function(e){var t=FileUploadUI.getAllowedItems(e);t&&t.length&&FileUploadUI.handlePreview(this.getParentChatId(),t,!1,!1,this.getOptionsForAttachments())},ThreadCardUI.prototype.onAutoCompleteClick=function(e){Composer.eventsOnAutoComplete.call(this,e,e.currentTarget)},ThreadCardUI.prototype.openWhiteBoard=function(){ImgViewer.Annotator.loadEditor(this.getParentChatId(),void 0,this.getOptionsForAttachments())},ThreadCardUI.prototype.openCodeSnippetEditor=function(){CodeSnippet.showEditorWindow(this.getParentChatId(),!1,null,this.getOptionsForAttachments())},ThreadCardUI.prototype.getOptionsForAttachments=function(){return{fileShareFromThreadCard:!0,permission:ChatUI.getPermissions(""+$zcg.CT_NFY_ZOHOGROUP),parentChatId:this.getParentChatId(),parentMsgUid:this.getParentMsgUid(),replyToMsgUid:this.replyToMsgUid,isFirstThreadMsg:this.isFirstThreadMsg(),isThreadChat:!0,parentChatTitle:ConversationsList.getTitle(this.getParentChatId()),threadChatId:this.getThreadChatId(),postInParent:this.canPostInParent(),defaultComposerValue:this.getComposerInstance().getComposerContentAsFragment(),chatTitle:this.getThreadChatTitle()||I18N("thread.title"),additionalSearchCriteria:this.getAdditionalSearchCriteria()}},ThreadCardUI.prototype.isFirstThreadMsg=function(){return null==this.getThreadChatId()},ThreadCardUI.prototype.getThreadChatTitle=function(){var e=this.getThreadChatId();if(null!=e)return ConversationsList.getTitle(e)||$WC.$CUtil.processXSS(this.getParentMessage().getThreadInfo().getThreadChatTitle())},ThreadCardUI.prototype.handleNewMessage=function(e){var t=e.msgobj.preserveMockData;this.getStorage().addNewMessage(e,t)},ThreadCardUI.prototype.beforeFetchingUnreadMsgs=function(){this.destroyStorageAndCreateNewStorage(),this.initViewIfNotExists(),this.showNewMsgSkeletonLoader(),this.hideThreadReplyArea()},ThreadCardUI.prototype.fetchUnreadMsgsFromServer=function(){var e=this.getUnreadMsgCount();if(0!=e)return this.beforeFetchingUnreadMsgs(),this.unreadMsgtranscriptFetchPromise=this.getStorage().fetchRecentNMessages(e).then(this.handleUnreadMsgFetchSuccess.bind(this),this.handleUnreadMsgFetchFailure.bind(this)),this.unreadMsgtranscriptFetchPromise},ThreadCardUI.prototype.updateUnreadBadge=function(){var e=this.getUnreadMsgCount();e<=ThreadChatUtils.constants.NEW_MSG_THRESHOLD||this.DOM_CACHE.getUnreadBadge().text(e).removeClass("dN")},ThreadCardUI.prototype.resetUnreadMsgTranscriptFetchPromise=function(e){this.unreadMsgtranscriptFetchPromise=null,this.isUnreadMsgTranscriptFetchFailed=e},ThreadCardUI.prototype.isUnreadMsgsFetchingInProgress=function(){return this.unreadMsgtranscriptFetchPromise instanceof Promise},ThreadCardUI.prototype.handleUnreadMsgFetchSuccess=function(e){this.resetUnreadMsgTranscriptFetchPromise(),e&&e.hasOwnProperty("totalMsgCount")&&(this.totalMsgCount=+e.totalMsgCount),this.updateTotalMsgCountUI(),this.removeNewMsgLoader(),this.showThreadReplyArea(),this.updateUIAfterNewMsg();var t=this.getUnreadMsgCount();t&&e&&t>e.fetchCount&&this.updateUnreadBadge()},ThreadCardUI.prototype.handleUnreadMsgFetchFailure=function(){this.resetUnreadMsgTranscriptFetchPromise(!0),this.showRetryOption()},ThreadCardUI.prototype.retryNewMsgFetch=function(){return 0==this.getUnreadMsgCount()?(this.handleUnreadMsgFetchSuccess(),this.convertToNonReplyMode(!0),void this.expandFewReplies()):this.fetchUnreadMsgsFromServer()},ThreadCardUI.prototype.hideThreadReplyArea=function(){this.DOM_CACHE.getReply().addClass("dN")},ThreadCardUI.prototype.showThreadReplyArea=function(){this.DOM_CACHE.getReply().removeClass("dN")},ThreadCardUI.prototype.showNewMsgSkeletonLoader=function(){this.DOM_CACHE.getNewMsgLoader().html(ThreadChatTemplates.mini.thread_card_new_msg_loader).removeClass("dN")},ThreadCardUI.prototype.showRetryOption=function(){var e=$WC.template.replace(ThreadChatTemplates.mini.newmsg_fetch_link,{id:this.getId()}),t={imageclass:"zcempty-img error_img",title:I18N("threadchat.new.fail",[e]),subtitle:"",fontSize:"18"},a=$Util.emptyStateHtml(t);this.DOM_CACHE.getNewMsgLoader().html(a).removeClass("dN")},ThreadCardUI.prototype.removeNewMsgLoader=function(){this.DOM_CACHE.getNewMsgLoader().empty().addClass("dN")},ThreadCardUI.prototype.updateUnreadAfter=function(){return this.getStorage().updateUnreadAfter(),this},ThreadCardUI.prototype.loadMoreReplies=function(e){return this.initViewIfNotExists(),this.DOM_CACHE.getLoadMoreCont().addClass("curN"),this.getStorage().setLinesLimit(ThreadChatUtils.constants.LOAD_MORE_LIMIT),this.topTranscriptFetchPromise=this.getStorage().fetchTopMessages(e).then(this.onTopTranscriptFetchSuccess.bind(this),this.onTopTranscriptFetchFailure.bind(this)),this.topTranscriptFetchPromise},ThreadCardUI.prototype.onTopTranscriptFetchSuccess=function(){this.topTranscriptFetchPromise=null,this.DOM_CACHE.getLoadMoreCont().removeClass("curN"),this.addorRemoveDotLoader(),this.showOrHideLoadMoreDom(),this.handleAfterAddingNewMsg(),this.isInNonReplyMode()&&this.updateUIAfterNewMsgInNonReplyMode()},ThreadCardUI.prototype.onTopTranscriptFetchFailure=function(){this.addorRemoveDotLoader(),this.DOM_CACHE.getLoadMoreCont().removeClass("curN"),this.topTranscriptFetchPromise=null},ThreadCardUI.prototype.isAnyOtherThreadCardIsInReplyMode=function(){var e=Clickoutside.currentchain;if(e.length){var t=this;return e.filter((function(e){var a=Clickoutside.data[e];return a.additionalInfo&&a.additionalInfo.parentChatId==t.getParentChatId()&&a.destid!=t.getId()})).length>0}},ThreadCardUI.prototype.isInlineComposerExist=function(){var e=this.getComposerInstance();return e&&null!=ComposerComponent.getComposerById(e.composerId)},ThreadCardUI.prototype.openComposerAndFetchReplies=function(){this.isNonCwinView()||(MediaUtil.isInMaximizedView()?this.openThreadChatOutsideParentChat():this.getStorage().isEmpty()||!this.isInlineComposerExist()?(this.scrollToParentMsgIfAnyOtherThreadCardIsAlreadyFocused(),this.convertToReplyMode(),this.getStorage().isEmpty()&&this.loadMoreReplies()):this.focusComposer())},ThreadCardUI.prototype.scrollToParentMsgIfAnyOtherThreadCardIsAlreadyFocused=function(){this.isAnyOtherThreadCardIsInReplyMode()&&setTimeout(()=>this.scrollToParentMsg(),100)},ThreadCardUI.prototype.onParentMsgClick=function(){if(null!=this.getThreadChatId())if(this.getUnreadMsgCount()>0)this.markRead();else{var e=this.getComposerInstance();if(!e||!e.isContentNotEmpty()){var t=this.getStorage();t.isEmpty()?!t.isFetching($zcg.fetchConstants.TOP)&&this.expandFewReplies():this.convertToNonReplyMode(!0)}}},ThreadCardUI.prototype.expandFewReplies=function(){this.addorRemoveDotLoader(!0),this.loadMoreReplies(!0),this.scrollToParentMsgIfAnyOtherThreadCardIsAlreadyFocused()},ThreadCardUI.prototype.addorRemoveDotLoader=function(e){var t=this.DOM_CACHE.getRepliesLink();if(e){var a=$WC.template.replace(ThreadChatTemplates.mini.dot_loader,{id:this.getId()});t.hide(),$(a).insertBefore(t)}else t.show(),this.DOM_CACHE.getThreeDotLoader().remove()},ThreadCardUI.prototype.openThreadChatInsideParentChat=function(){if(this.isNonCwinView())this.openThreadChatOutsideParentChat();else if(ChatUI.exist[this.getParentChatId()]){if("undefined"!=typeof ZCSmartConferenceImpl){var e=ZCSmartConferenceImpl.getCurrentActiveSession();if(void 0!==e&&!e.isInMinimizedView()&&e.getThreadChatId()===this.getThreadChatId())return void ZCSmartConferenceHandler.UIEvents.toggleRHSChat(void 0,$("#conference-rhs-thread"))}var t=this.getStorage().isEmpty(),a=function(){this.handleAfterSeparateChatOpened(),t||this.scrollToParentMsg()}.bind(this);ThreadChatUtils.openThreadChatInsideParentChatWindow(this.getParentChatId(),this.getParentMsgUid(),this.getThreadChatId(),a,(function(){}))}},ThreadCardUI.prototype.handleBeforeOpeningThreadChatAsSeparateChat=function(){this.convertToNonReplyMode(),this.removeThreadCardFromActiveCwin()},ThreadCardUI.prototype.handleAfterSeparateChatOpened=function(){this.convertToNonReplyMode(!0)},ThreadCardUI.prototype.openThreadChatOutsideParentChat=function(){this.isNonCwinView()&&Clickoutside.closeAll();var e=this;this.removeThreadCardFromActiveCwin();var t=this.DOM_CACHE.getPopOutIcon();$Util.Button.addLoadIconForAjax(t);MediaUtil.isInMaximizedView()&&ReplyPrivate.handleMaximizedView(),Chat.attachSession(this.getThreadChatId()).then((function(){e.convertToNonReplyMode(!0),e.scrollToParentMsg(),$Util.Button.resetContent(t)}),(function(){$Util.Button.showCompletionAndResetContent(t,!0)}))},ThreadCardUI.prototype.destroyComposer=function(){var e=this.getComposerInstance();e&&e.clear()},ThreadCardUI.prototype.renderReplyModeContent=function(){this.destroyComposer(),this.initComposerInstance();var e=$WC.template.replace,t=ThreadChatTemplates.mini,a=e(t.composer,{id:this.getId(),composer_component:this.getComposerInstance().getHtml()},"InSecureHTML"),r=e(t.post_checkbox,{checkbox_html:this.getPostCheckBoxHtml()},"InSecureHTML"),o=$WC.template.replace(ThreadChatTemplates.mini.reply_mode_content,{id:this.getId(),threadchatid:this.getThreadChatId()||"",composer_html:a,post_channel_checkbox:r,composer_component:this.getComposerInstance().getHtml()},"InSecureHTML");this.DOM_CACHE.getReplyModeContainer().html(o)},ThreadCardUI.prototype.getTotalReplies=function(){var e=this.getStorage(),t=this.getTotalMsgCount()-e.getUnSentMessagesCount();if(e.isEmpty()&&this.isInNonReplyMode()){var a=0==t||1==t?"threadchat.onereply":"threadchat.nreplies";return 0==t&&(t=1),I18N(a,[t])}return 0==Math.abs(t-e.getSize())?I18N("thread.view"):(0==t&&(t=e.isEmpty()?"":e.getList().getSize()),I18N("thread.nrepliesview",[t]))},ThreadCardUI.prototype.isClosedThread=function(){if(this.getParentMessage().isThreadParentMessage())return this.getParentMessage().getThreadInfo().isClosedThread()},ThreadCardUI.prototype.onThreadClose=function(){this.getParentMessage().getThreadInfo().setIsClosedThread(!0),this.DOM_CACHE.getThreadCard().addClass("closedthread"),this.convertToNonReplyMode(!0),this.DOM_CACHE.getClosedLabel().length||this.DOM_CACHE.getThreadViewBtn().append(ThreadChatTemplates.mini.closed_thread_label)},ThreadCardUI.prototype.onThreadReopen=function(){this.getParentMessage().getThreadInfo().setIsClosedThread(!1),this.DOM_CACHE.getThreadCard().removeClass("closedthread"),this.DOM_CACHE.getClosedLabel().remove()},ThreadCardUI.prototype.isNormalReplyAllowedInChannel=function(){return!0},ThreadCardUI.prototype.isReplyAllowed=function(){return ChatUI.getWin(this.getParentChatId())&&ThreadChatUtils.isReplyInThreadEnabledInPermissions(this.getParentChatId())},ThreadCardUI.prototype.addAsFocussedInParentCwin=function(){var e=ChatUI.getWin(this.getParentChatId());e&&e.focussedThreadCards.add(this.getId())},ThreadCardUI.prototype.removeAsFocussedInParentCwin=function(){var e=ChatUI.getWin(this.getParentChatId());e&&e.focussedThreadCards.delete(this.getId())},ThreadCardUI.prototype.renderLastThreadReply=function(){if(this.getParentMessage().isThreadParentMessage()&&this.getStorage().isEmpty()&&!(ConversationsList.getUnreadCount(this.getThreadChatId())>1||this.getTotalMsgCount()>1)){var e=this.getParentMessage().getThreadInfo();if(e.hasThreadLastMessage()){var t=e.getThreadLastMessage(),a=MessageFactory(t,this.getThreadChatId(),!0,!0);this.addNewMsgInStorage(a)}}},ThreadCardUI.prototype.initThreadCardElement=function(){if(null==this.el){var e=ThreadChatTemplates.mini.element,t=ThreadChatUtils.isUnreadMessage(this.getParentChatId(),this.getParentMessage())?"nwmsg":"",a=this.isClosedThread()?"closedthread":"";e=$WC.template.replace(e,{id:this.getId(),msguid:this.getParentMsgUid(),parentchid:this.getParentChatId(),parentviewid:this.getParentViewId(),threadchatid:this.getThreadChatId()||"",newmsgclass:t,closedthreadclass:a}),this.el=$(e)[0]}},ThreadCardUI.prototype.getHtml=function(){if(this.el.childElementCount>0)return this.el;var e=window.cloneMessageNode(this.getMsgObj(),this.getParentChatId(),void 0,!0);e.avoidThreadCardHtml=!0,e.avoidDate=!0,e.avoidNewMessageDom=!0,this.getParentMessage().isThreadParentMessage()||(e.tempThread=!0);var t=StorageManager.getView(this.getParentChatId(),this.getParentViewId()).getMessageConstructor().getHtmlForNode(e,null,null);t=t?MsgUtil.getHtmlFromElement(t):t;var a=$WC.template.replace,r=ThreadChatTemplates.mini,o=a(r.replies,{id:this.getId()}),s=a(r.new_msg_badge,{id:this.getId()}),n=this.isClosedThread()?r.closed_thread_label:"",i=a(r.view_and_open_thread,{id:this.getId(),hide:this.getThreadChatId()?"":"dN",total_replies:this.getTotalReplies()});i=a(i,{new_msg_badge:s,closed_thread_label:n,followers_count:this.getFollowersCount(),followers_count_tooltip:this.getFollowersCountTooltip(),view_option_cls:"",disable_reply:this.isReplyAllowed()?"":"curN"},"InSecureHTML");var d=a(r.container,{id:"",threadchatid:this.getThreadChatId()||"",thread_msg_html:t,replies_html:o,reply_here:r.reply_here,view_and_open_thread_html:i},"InSecureHTML");return this.el.innerHTML=d,this.renderLastThreadReply(),this.el};var ThreadHeadMessageUI,ThreadHeadMessageView,ThreadHeadMessageStorage,$TCwin=function(e,t,a,r,o){$Cwin.call(this,e,o),this.parentMsgUid=a,this.parentChatId=t,this.parentMsgSenderId=r,this.init()};$TCwin.prototype=Object.create($Cwin.prototype),$TCwin.prototype.constructor=$TCwin,$TCwin.prototype.super=$Cwin.prototype,$TCwin.prototype.canMakeThreadReopenApiCallOnReopenFromComposer=!0,$TCwin.prototype.updateTitle=function(){this.super.updateTitle.apply(this,arguments),this.updateParentTitle()},$TCwin.prototype.isChatInviteAllowed=function(){return!0},$TCwin.prototype.update=function(e){if(e)return!this.getParentMsgSenderId()&&e.parent_message_sender&&(this.setParentMsgSenderId(e.parent_message_sender),this.renderChatImage()),e.isChatOpenedFromBasicInfo&&(e.parent_message_sender||this.renderChatImage(),void 0===e.isfollower&&(this.isFollowerOrNonfollowerNotKnown=!0,this.$(this.DOM_CACHE.threadFollowUnfollowBtn).hide())),this.isFollowerOrNonfollowerNotKnown&&"boolean"==typeof e.isfollower&&(this.isFollowerOrNonfollowerNotKnown=!1,this.updateFollowUnfollowBtn(e.isfollower)),"false"==e.parent_participant&&this.setIsParentParticipant(!1),this.setParentChatInfo(e),this.super.update.apply(this,arguments)},$TCwin.prototype.setParentChatInfo=function(e){if(e&&(!this.parentChatId&&e.parentchatid&&(this.parentChatId=e.parentchatid),!this.parentMsgUid&&e.threadmsguid&&(this.parentMsgUid=e.threadmsguid),e.addinfo&&!this.parentMsgSenderId)){var t=Chat.parseAddinfo(e.addinfo);t.PARENT_MESSAGE_SENDER&&(this.parentMsgSenderId=t.PARENT_MESSAGE_SENDER)}},$TCwin.prototype.onThreadClose=function(){Drafts.has(this.getChid())||(Config.isProminentClosedThreadIndicationEnabled()&&this.disableComposer(this.getChid(),I18N("thread.close.success")+".",void 0,{isThreadClose:!0}),this.win().addClass("closedthread"))},$TCwin.prototype.onThreadReopen=function(){this.win().removeClass("closedthread")},$TCwin.prototype.getParentChatTitle=function(){return ConversationsList.getTitle(this.parentChatId)||Channels.getDisplayNameForChannel(Channels.getByChid(this.parentChatId))||""},$TCwin.prototype.updateParentTitle=function(){var e=$WC.Util.decodeHTMLEntities(this.getParentChatTitle());$(this.DOM_CACHE.parentTitle).text(e).attr("title",e)},$TCwin.prototype.isParentChatIsChannel=function(){var e=Channels.getByChid(this.getParentChatId());return!$.isEmptyObject(e)},$TCwin.prototype.isParentChatOrgChannel=function(){var e=Channels.getByChid(this.getParentChatId());return $.isEmptyObject(e)?!$WC.Util.isEmpty(this.orgid)&&$WC.Util.isEmpty(this.orggroups):Channels.isOrgScope(Channels.getLevel(e))},$TCwin.prototype.isParentChatOrgGroupChannel=function(){var e=Channels.getByChid(this.getParentChatId());return $.isEmptyObject(e)?!$WC.Util.isEmpty(this.orgid)&&!$WC.Util.isEmpty(this.orggroups):Channels.isOrgGroupScope(Channels.getLevel(e))},$TCwin.prototype.isParentChatSharedChannel=function(){if(this.isParentChatIsChannel()){var e=Channels.getByChid(this.getParentChatId());return Channels.isSharedScope(Channels.getLevel(e))}},$TCwin.prototype.getParentChatAllowedUsers=function(){if(this.isParentChatIsChannel()&&this.isParentChatOrgGroupChannel()){var e=Channels.getByChid(this.getParentChatId()).scid.join(",");return Groups.getMembersFromObj(e)}},$TCwin.prototype.updateUI=function(e){e&&this.handleFirstUIUpdate(),this.renderChatImage(),this.disablePostInParentCheckBoxIfParentChatHasNoSendPermission(),this.super.updateUI.apply(this,arguments)},$TCwin.prototype.disablePostInParentCheckBoxIfParentChatHasNoSendPermission=function(){var e=this.getParentChatId(),t=Channels.getByChid(e);$.isEmptyObject(t)||ChannelsPermission.hasPermission(Channels.ACTIONS.SEND_MESSAGE,t)||this.win().find(this.DOM_CACHE.postInParentContainer).addClass("vsbH")},$TCwin.prototype.isParentParticipant=function(){return void 0===this.isParentPart||this.isParentPart},$TCwin.prototype.setIsParentParticipant=function(e){this.isParentPart=e},$TCwin.prototype.handleFirstUIUpdate=function(){this.handleThreadCardIfExists();var e=this.getParentCwin();e&&(e.ignoreOrientation=!1),clearTimeout(ThreadChatUtils.threadCwinOpenFromWmsResponseWaitTimer),ThreadChatUI.orientation.resetOpenInsideParentChat(this.getThreadChatId()),this.handleOrientation(),this.retainParentCwinScrollPosition(),ThreadChatUtils.chatIdVsParentChatInfo.add(this.getThreadChatId(),this.getParentMsgUid(),this.getParentChatId())},$TCwin.prototype.handleThreadCardIfExists=function(){var e=this.getParentCwin();if(e){var t=e.getStorage().getThreadCards().getInstanceByMsgUid(this.getParentMsgUid());t&&t.handleAfterSeparateChatOpened()}},$TCwin.prototype.getParentMsgSenderId=function(){return this.parentMsgSenderId},$TCwin.prototype.setParentMsgSenderId=function(e){this.parentMsgSenderId=e},$TCwin.prototype.renderChatImage=function(){var e=$WC.template.replace(ThreadChatTemplates.chat_img_html,{uid:this.parentMsgSenderId,src:Users.getImgUrlById(this.parentMsgSenderId)});$(this.DOM_CACHE.chatImage).html(e)},$TCwin.prototype.getParticipantHtml=function(e){return ThreadChatUtils.getTotalFollowersText(e)},$TCwin.prototype.updateChatImage=function(){},$TCwin.prototype.init=function(){this.initDomCache(),this.getStorage().threadStateUpdateCallBack=this.onThreadStateUpdate.bind(this)},$TCwin.prototype.onThreadStateUpdate=function(e){e?this.onThreadClose():this.onThreadReopen()},$TCwin.prototype.handleOrientation=function(){var e=this.getParentCwin();e&&e.ignoreOrientation||this.toggleNestedThreadClassInParentCwinAndThreadCwin(NestedChatUI.isExist(this.chid))},$TCwin.prototype.toggleNestedThreadClassInParentCwinAndThreadCwin=function(e){var t=this.getParentCwin();this.win().toggleClass("nested-thread",!!e),t&&t.win().toggleClass("nested-parent",!!e);var a=MainUI.isChatPaneView();!a&&e&&ChatUI.hasChatWindowDOMInView()&&this.addResizePanel(),a||e||this.removeResizePanel()},$TCwin.prototype.addResizePanel=function(){var e=this.win(),t=this.parentChatId,a={element:e,maxWidthToExpand:"50%",localStorageKey:"threadResizePanel",mouseDragFromLeft:!0,onResizing:function(e,a){var r={el:e,newWidth:a,parentChatId:t};ThreadChatUtils.applyStyleOnThreadCwinResizing(r)}};this.resizeInstance=ResizeComponent.init(a)},$TCwin.prototype.removeResizePanel=function(){var e=this.parentChatId,t={onResetHandler:function(t){var a={el:t,newWidth:"",parentChatId:e};ThreadChatUtils.applyStyleOnThreadCwinResizing(a)}};this.resizeInstance&&this.resizeInstance.clear(t)},$TCwin.prototype.bindEvents=function(){this.super.bindEvents.apply(this,arguments),this.bindThreadChatWindowEvents()},$TCwin.prototype.handleBeforeClose=function(){this.clear(),this.super.handleBeforeClose.apply(this,arguments)},$TCwin.prototype.handleAfterClose=function(){this.isCwinClosed||(this.isCwinClosed=!0,this.handleOrientation(),this.retainParentCwinScrollPosition())},$TCwin.prototype.unBindEvents=function(){},$TCwin.prototype.constructParticipantsUI=function(){var e={isThreadChat:!0,parentChatId:this.getParentChatId(),parentMsgUid:this.getParentMsgUid(),threadChatId:this.getThreadChatId(),threadChatTitle:ConversationsList.getTitle(this.getThreadChatId()),isFollower:ConversationsList.isThreadFollower(this.getThreadChatId())};ParticipantsWin.createModelWindow("participants",this.getThreadChatId(),!0,!0,!0,!0,e)},$TCwin.prototype.openFilePreview=function(e){FileUploadUI.handlePreview(this.chid,e,!0,!1,{isThreadChat:!0,parentChatTitle:this.getParentChatTitle(),postInParent:this.canPostInParent()})},$TCwin.prototype.showEditorWindow=function(){CodeSnippet.showEditorWindow(this.chid,null,null,{isThreadChat:!0,parentChatTitle:this.getParentChatTitle(),postInParent:this.canPostInParent()})},$TCwin.prototype.updateAdditionalOptionsUI=function(){var e=this.win();let t=MediaManager.getGroupCallOptionsHtmlForCwin(this);e.find(this.DOM_CACHE.searchContainer).html(this.getSearchHtml().replace(/{CHID}/g,this.getChid())),e.find(this.DOM_CACHE.groupCallContainer).html(t),this.super.updateAdditionalOptionsUI.apply(this,arguments)},$TCwin.prototype.handleUnread=function(e){if(!this.isNewMessage(e))return!0;ConversationsUI.updateMsgCount(this.chid,ConversationsList.getUnreadCount(this.chid))},$TCwin.prototype.disableComposer=function(){var e=this.super.disableComposer.apply(this,arguments);return e&&this.win().find(this.DOM_CACHE.postInParentContainer).addClass("vsbH"),this},$TCwin.prototype.enableComposer=function(){return this.super.enableComposer.apply(this,arguments),this.win().find(this.DOM_CACHE.postInParentContainer).removeClass("vsbH"),this},$TCwin.prototype.closeWindow=function(){this.isCwinClosed=!0;var e=NestedChatUI.isExist(this.getChid());this.super.closeWindow.apply(this,arguments),this.handleOrientation(),e&&this.retainParentCwinScrollPosition()},$TCwin.prototype.retainParentCwinScrollPosition=function(){var e=this.getParentCwin();e&&e.retainScrollOnVisible()},$TCwin.prototype.openAddFollowersWindow=function(){this.constructParticipantsUI(),$(this.DOM_CACHE.addFollowersBtn).click()},$TCwin.prototype.getFollowOrUnfollowOption=function(){var e=ConversationsList.isThreadFollower(this.getThreadChatId()),t=ThreadChatTemplates.threadCwinActions;return e?t.unfollow:t.follow},$TCwin.prototype.getThreadChatId=function(){return this.getChid()},$TCwin.prototype.getParentMsgUid=function(){return this.parentMsgUid},$TCwin.prototype.getParentChatId=function(){return this.parentChatId},$TCwin.prototype.getParentCwin=function(){return ChatUI.getWin(this.getParentChatId())},$TCwin.prototype.clear=function(){this.unBindEvents()},$TCwin.prototype.initDomCache=function(){this.DOM_CACHE={threadChatHeader:"#thread-msg-hdr-container",postInParent:"#"+this.chid+" #post-in-parent",parentTitle:"#"+this.chid+" #parent-title"+this.chid,chatImage:"#"+this.chid+" #userimage ",threadOptions:"#threadoptions"+this.chid,threadOptionsList:"#threadoptions"+this.chid+"-list",searchContainer:"#thread-search",groupCallContainer:"#thread-call",threadFollowUnfollowBtn:".thread-action-btn",postInParentContainer:"#post-in-parent-container",addFollowersBtn:"#participants-usersuggest #addmemberbtn"}},$TCwin.prototype.canPostInParent=function(){return $(this.DOM_CACHE.postInParent).is(":checked")},$TCwin.prototype.popOut=function(){this.threadChatWindowActions.shiftChatWindowToViewPort.call(this)},$TCwin.prototype.getActionDataSet=function(e){var t=e.dataset.action;return t=(t=t||e.parentElement.dataset.action)||e.parentElement.parentElement.dataset.action},$TCwin.prototype.getAdditionalDataObj=function(){return{post_in_parent:this.canPostInParent()}},$TCwin.prototype.bindThreadChatWindowEvents=function(){var e=this;this.win().find(this.DOM_CACHE.threadChatHeader).on("click","[data-action]",(function(t){var a=e.getActionDataSet(t.target);a&&a in e.threadChatWindowActions&&(e.threadChatWindowActions[a].call(e,t),t.stopPropagation())})),this.win().on("click","[data-thread-action]",(function(t){var a=t.target.dataset.threadAction;a&&a in e.threadChatWindowActions&&e.threadChatWindowActions[a].call(e,t)})),this.win().find(this.DOM_CACHE.threadChatHeader).on("mouseenter mouseleave","[data-hover-action]",(function(t){"onfollowUnfollowBtnHover"==t.target.getAttribute("data-hover-action")&&e.threadChatWindowActions.onfollowUnfollowBtnHover.call(e,t)}))},$TCwin.prototype.updateTriggers=function(){var e=this.getParentChatId()||"";if(new $CliqChatId(e).isChannel()){var t=Channels.getChannelId(e),a=Channels.getObject(t);if(!a)return;this.allowedtriggers=[":"],SecurityManager.hasPermission(Modules.Commands)&&this.allowedtriggers.push("/"),ChannelsPermission.hasPermission(Channels.ACTIONS.SPECIAL_MENTIONS,a)&&(this.allowedtriggers.push("#"),this.allowedtriggers.push("cc:@"),this.allowedtriggers.push("cc:")),ChannelsPermission.hasPermission(Channels.ACTIONS.MENTION_USERS,a)&&this.allowedtriggers.push("@")}this.currenttriggers=this.allowedtriggers},$TCwin.prototype.$=function(e){return this.win().find(e)},$TCwin.prototype.updateFollowUnfollowBtn=function(e){this.$(this.DOM_CACHE.threadFollowUnfollowBtn).replaceWith(MsgTemplate.getThreadFollowOrFollowingButton(void 0,{isThreadFollower:"boolean"==typeof e?e:ConversationsList.isThreadFollower(this.getThreadChatId())}))},$TCwin.prototype.onUnfollow=function(){this.updateFollowUnfollowBtn()},$TCwin.prototype.onFollow=function(){this.updateFollowUnfollowBtn()},$TCwin.prototype.threadChatWindowActions={shiftChatWindowToViewPort:function(){this.win().css({left:"",top:"",height:"",zIndex:""}),MainUI.addChatInView(this.win(),this.chid,!0),MainUI.isChatPaneView()&&this.win().show(),MainUI.isChatPaneView()||$("#"+this.getParentChatId()).hide(),this.handleOrientation(),MainUI.current=this.getChid(),Config.isGetMeFrontOptimized()&&MainUI.resize(),this.updateParticipantsDetailsHtml(),this.focus()},closeThreadChatWindow:function(){this.handleCloseWindow()||this.closeWindow($zcg._MOUSECLICKEVENT)},goToHeadMessage:function(){Chat.jumpToConversation(this.getParentChatId(),!1,this.getParentMsgUid())},followThread:function(){var e=this,t={parentChatId:this.getParentChatId(),threadChatId:this.getThreadChatId(),userIds:[WmsImpl.getZuid()]};ThreadApis.follow(t).then((function(){ThreadChatUtils.onFollowSuccess(e.getThreadChatId())}),(function(){}))},unfollowThread:function(){var e=this,t={parentChatId:this.getParentChatId(),threadChatId:this.getThreadChatId(),userIds:[WmsImpl.getZuid()]};ThreadApis.unfollow(t).then((function(){ThreadChatUtils.onUnfollowSuccess(e.getThreadChatId())}),(function(){}))},closeThread:function(){ThreadChatUtils.showConfirmationPopupAndCloseThread(this.getParentChatId(),this.getThreadChatId(),this.getParentMsgUid())},reopenThread:function(){Config.isProminentClosedThreadIndicationEnabled()?this.threadChatWindowActions.onReopenThreadFromComposer.call(this):ThreadApis.reopenThread(this.getThreadChatId()).then(()=>{ThreadChatUtils.onReopenThreadSuccess(this.getParentChatId(),this.getThreadChatId(),this.getParentMsgUid())})},onReopenThreadFromComposer:function(){this.isThreadReopening=!0,this.enableComposer(this.getChid()),this.canMakeThreadReopenApiCallOnReopenFromComposer&&ThreadApis.reopenThread(this.getThreadChatId()).then(()=>{ThreadChatUtils.onReopenThreadSuccess(this.getParentChatId(),this.getThreadChatId(),this.getParentMsgUid())}),this.focus(),this.isThreadReopening=!1},viewFollowers:function(){this.constructParticipantsUI()},openAddFollowersPopUp:function(e){Clickoutside.handleClickOnChild(e)},onfollowUnfollowBtnHover:function(e){var t="mouseenter"==e.type,a=!t,r=this.$(this.DOM_CACHE.threadFollowUnfollowBtn),o=r.find("#small-dot-loader").length,s=ThreadChatTemplates.unmuteIcon,n=ThreadChatTemplates.muteIcon;if(!o){var i=!ConversationsList.isThreadFollower(this.getThreadChatId());t&&r.html(i?I18N("threadchat.follow"):n+I18N("threadchat.unfollow")),a&&r.html(i?I18N("threadchat.follow"):s+I18N("threadchat.followed"))}},onfollowUnfollowBtnClick:function(e){var t=this.$(this.DOM_CACHE.threadFollowUnfollowBtn),a=!ConversationsList.isThreadFollower(this.getThreadChatId()),r=!a,o={parentchid:this.getParentChatId(),threadchid:this.getThreadChatId(),parentmsguid:this.getParentMsgUid()},s=this,n=function(){t.find("#small-dot-loader").remove(),t.removeClass("curN"),s.updateFollowUnfollowBtn()};t.addClass("curN"),t.append(ThreadChatTemplates.mini.small_dot_loader),r?ThreadChatUtils.unfollowThread(this.getThreadChatId(),o).then(n,n):a&&ThreadChatUtils.followThread(this.getThreadChatId(),o).then(n,n)}},(ThreadHeadMessageUI=function(e){this.headMessage=e,this.$el=$(this.getContainer())}).prototype.render=function(){return this.initMessageStorageAndView(),this.messageStorage.addNewMessage(this.headMessage),this},ThreadHeadMessageUI.prototype.initMessageStorageAndView=function(){var e=this.headMessage.getObject().chid;this.messageStorage=new ThreadHeadMessageStorage(e,this.headMessage.getMsguid());var t=new ThreadHeadMessageView(this.messageStorage.getChid(),this.messageStorage.getId(),this.$el);this.messageStorage.initView(t)},ThreadHeadMessageUI.prototype.getStorage=function(){return this.messageStorage},ThreadHeadMessageUI.prototype.getContainer=function(){return $WC.template.replace(this.template.element)},ThreadHeadMessageUI.prototype.getElement=function(){return this.$el[0]},ThreadHeadMessageUI.prototype.template=ThreadChatTemplates.head_msg,(ThreadHeadMessageView=function(e,t,a){MessageView.call(this,e,t,a)}).prototype=Object.create(MessageView.prototype),ThreadHeadMessageView.prototype.constructor=ThreadHeadMessageView,ThreadHeadMessageView.prototype.initContainerAndView=function(e){this.container=e.find("#headmsg-chatbody"),this.view=this.container.find("#headmsg-msgarea")},ThreadHeadMessageView.prototype.blackListed={scrollEvent:!0,dblClickEvent:!0,viewReplied:!0},ThreadHeadMessageView.prototype.removeNavUnreadCount=function(){},ThreadHeadMessageView.prototype.initPermission=function(){var e={star:!1,messageOperations:!0,reply:!0,reaction:!0,addReaction:!0,goToThreadChat:!0,forceAddSender:!0,avoidNewMessageDom:!0,avoidDate:!0,moreOptions:!1,readReceipt:!1,ignoreThreadHtml:!0,isThreadHeadMessage:!0};this.permissions=e},(ThreadHeadMessageStorage=function(e,t){MessageStorage.call(this,e),this.threadHeadMsgUid=t}).prototype=Object.create(MessageStorage.prototype),ThreadHeadMessageStorage.prototype.isThreadHeadMessageStorage=!0,ThreadHeadMessageStorage.prototype.super=MessageStorage.prototype,ThreadHeadMessageStorage.prototype.getThreadHeadMsgUid=function(){return this.threadHeadMsgUid},ThreadHeadMessageStorage.prototype.addNewMessage=function(e){if(e.getMsguid()==this.getThreadHeadMsgUid())return this.super.addNewMessage.apply(this,arguments)},ThreadHeadMessageStorage.prototype.editMessage=function(e){if(e.getMsguid()==this.getThreadHeadMsgUid())return this.super.editMessage.apply(this,arguments)},ThreadHeadMessageStorage.prototype.deleteMessage=function(e){if(e.getMsguid()==this.getThreadHeadMsgUid())return this.super.deleteMessage.apply(this,arguments)};var ThreadCardsReferences=function(){this.threadCardsUI={}};ThreadCardsReferences.prototype.getAllThreadCardsUIInstances=function(){return this.threadCardsUI},ThreadCardsReferences.prototype.getTotal=function(){return Object.keys(this.getAllThreadCardsUIInstances()).length},ThreadCardsReferences.prototype.addThreadCardUIInstance=function(e,t){this.hasThread(e)||(this.getAllThreadCardsUIInstances()[e]=t)},ThreadCardsReferences.prototype.deleteThreadCardUIInstance=function(e){this.hasThread(e)&&(this.getInstanceByMsgUid(e).clear(),delete this.getAllThreadCardsUIInstances()[e])},ThreadCardsReferences.prototype.clearAll=function(){for(var e in this.getAllThreadCardsUIInstances())this.getInstanceByMsgUid(e).clear();this.threadCardsUI={}},ThreadCardsReferences.prototype.hasThread=function(e){return this.getAllThreadCardsUIInstances().hasOwnProperty(e)},ThreadCardsReferences.prototype.focusThreadComposer=function(e){this.getInstanceByMsgUid(e).convertToReplyMode()},ThreadCardsReferences.prototype.getInstanceByMsgUid=function(e){return this.getAllThreadCardsUIInstances()[e]};var ThreadChatUI,ThreadApis={sendMessage:function(e){var t={},a=e.chid,r=e.threadChatId;return r||(t.thread_message_id=e.threadMsgId),t.post_in_parent=e.postInParent,e.isParentMsgReply&&(t.action="head_message_reply"),Chat.sendMessage(r||a,e.msg,e.time,e.editParams,t,e.replyToMsgUid)},addFollowers:function(e){var t="/v2/threads/"+e.threadChatId+"/followers",a={user_ids:e.userIds};return ThreadChatUtils.makePostRequest(t,a,e.additionalAjaxOptions)},removeFollowers:function(e){var t="/v2/threads/"+e.threadChatId+"/followers",a={user_ids:e.userIds};return ThreadChatUtils.makeDeleteRequest(t,a,e.additionalAjaxOptions)},fetchUnsubscribers:function(e){var t="/v2/threads/"+e.threadChatId+"/nonfollowers";return ThreadChatUtils.makeGetRequest(t)},fetchTitleSearch:function(e){var t={parent_chid:e.parentChatId,limit:e.limit||10,totime:e.nextToken,title:e.searchValue};return e.threadType&&(t.thread_type=e.threadType),ThreadChatUtils.makeGetRequest("/v1/chats",t).then((function(e){return ConversationsList.updateConversationsDB(e),e.limit=t.limit,e}))},fetchMessageSearch:function(e){var t={parent_chid:e.parentChatId,message:e.searchValue,lim:e.limit||10};return e.nextToken&&(t.pno=e.nextToken),ThreadChatUtils.makeGetRequest("/v1/messagesearch",t).then((function(e){return e.limit=t.lim,e}))},follow:function(e){var t="/v2/threads/"+e.threadChatId+"/follow";return ThreadChatUtils.makePostRequest(t)},unfollow:function(e){var t="/v2/threads/"+e.threadChatId+"/unfollow";return ThreadChatUtils.makePostRequest(t)},fetchFollowedThreads:function(e){var t={parent_chat_id:e.parentChatId,state:"followed",limit:e.limit||15};return e.nextToken&&(t.next_token=e.nextToken),e.searchValue&&(t.search_key=e.searchValue),e.type&&(t.type=e.type),e.nextSearchToken&&(t.next_search_token=e.nextSearchToken),ThreadChatUtils.makeGetRequest("/v2/threads",t)},fetchUnfollowedThreads:function(e){var t={parent_chat_id:e.parentChatId,state:"not_followed",limit:e.limit||15};return e.nextToken&&(t.next_token=e.nextToken),e.searchValue&&(t.search_key=e.searchValue),e.type&&(t.type=e.type),e.nextSearchToken&&(t.next_search_token=e.nextSearchToken),ThreadChatUtils.makeGetRequest("/v2/threads",t)},enableAutoFollowThreads:function(e){var t="/v1/channels/"+e+"?auto_follow_threads=enable";return ThreadChatUtils.makePutRequest(t)},disableAutoFollowThreads:function(e){var t="/v1/channels/"+e+"?auto_follow_threads=disable";return ThreadChatUtils.makePutRequest(t)},closeThread:function(e){var t="/v2/threads/"+e;return ThreadChatUtils.makePutRequest(t,{action:"close"})},reopenThread:function(e){var t="/v2/threads/"+e;return ThreadChatUtils.makePutRequest(t,{action:"reopen"})}};ThreadChatUI={handleNewMessage:function(e){var t=e.getObject(),a=t.mtype==$zcg.INFO_MTYPE;if(!a||!ThreadChatUtils.isInValidInfoMessage(t)){var r=e.getThreadInfo(),o=r.getParentChid(),s=r.getThreadChatId(),n=t.hasOwnProperty(DummyCwinUtils.CONSTANTS.CHAT_KEY),i=StorageManager.getStoragesByChid(s),d=StorageManager.getStoragesByChid(o);MsgUtil.isNewMessage(e)&&ThreadChatUtils.isFirstThreadMessage(t)&&!ThreadChatUtils.isParentMsgFollower(t)&&Config.isFirstThreadMessageNotifyEnabled()&&ThreadChatUtils.newUnfollowedThreadChatHandler.add(s),ThreadChatUtils.isParentMsgFollower(t)&&this.updateParentChatThreadLmTime(o,e.time),this.handleThreadUnread(s,o,e),a&&ThreadChatUtils.isThreadCloseOrReopenMsg(t)&&ThreadChatUtils.updateThreadStateInAllStorages({threadChatId:s,parentChatId:o,msgUid:t.threadmsguid||t.parentmsguid||Chat.parseAddinfo(t.addinfo).THREAD_MESSAGE_ID,state:t.info.msg.thread_state}),$.isEmptyObject(i)?$.isEmptyObject(d)||this.convertToThreadCardAndAddNewMsg(d,o,t):this.addNewMessageInStorages(i,t,s),n&&!$.isEmptyObject(d)&&this.convertToThreadCardAndAddNewMsg(d,o,t,!0),MsgUtil.isNewMessage(e)&&!this.isUnfollowedThreadChat(s,t)&&this.canNotify(o,s)&&ChatNotify.notify(e.getObject())}},canNotify:function(e,t){return ChatUI.isThreadAsInlineChats()?!ConversationsList.isMuted(e):Chat.isNewUnfollowedThreadChatOrFollower(t)&&!Chat.isParentChatMutedAndUnfollowedThreadChat(t)},updateParentChatThreadLmTime:function(e,t){var a=ConversationsList.get(e);a&&a.setThreadLmTimeIfHigherThanPreviousLmTime(t)},createConversationObj:function(e,t){ConversationsList.isExists(e)||ThreadChatUtils.createConversationObj(t)},isValidNewMessage:function(e){var t=e.getObject();return!(t.mtype==$zcg.INFO_MTYPE&&ThreadChatUtils.isInValidInfoMessage(t))},isParentChatAvailableInClientCache:function(e){return Boolean(ConversationsList.get(e.getThreadInfo().getParentChid()))},fetchParentChatDetailsAndHandleThreadNewMessage:function(e){var t=e.getThreadInfo().getParentChid();Chat.getChatsFromServerByChatIds(t).then(()=>this.handleNewMessage(e))},addUnreadThreadChidInParentChat:function(e,t){var a=ConversationsList.get(e);a&&a.addUnreadThreadChid(t)},removeUnreadThreadChidFromParentChat:function(e,t){var a=ConversationsList.get(e);a&&a.removeUnreadThreadChid(t)},isUnfollowedThreadChat:function(e,t){return!ThreadChatUtils.isNewUnfollowedThreadChat(e)&&!ThreadChatUtils.isParentMsgFollower(t)},isNewUnfollowedThreadChat:function(e){return ThreadChatUtils.isNewUnfollowedThreadChat(e)&&!ConversationsList.isThreadFollower(e)},updateParentChatDetailsInConvObjIfNotExist:function(e,t){var a=ConversationsList.get(e);a.getParentChatId()||a.setParentChatId(t.parentChatId),a.getParentMsgSenderId()||a.setParentMsgSenderId(t.parentmessagesenderid),a.getParentMsgUid()||a.setParentMsgUid(t.parentmsguid)},handleThreadUnread:function(e,t,a){var r=MsgUtil.isNewMessage(a);if(r||Config.isThreadUnreadTempEnabled()){var o=a.getObject();ConversationsList.isExists(e)||ThreadChatUtils.createConversationObj(a),this.updateParentChatDetailsInConvObjIfNotExist(e,o);var s=ConversationsList.get(e);if(s.updateActiveStatus(!0),s.setIsThreadFollower(ThreadChatUtils.isParentMsgFollower(o)),this.isUnfollowedThreadChat(e,o))return this.removeUnreadThreadChidFromParentChat(t,e),s.updateMutedStatus(!0),void(MessageStorageTemp.has(e)&&MessageStorageTemp.remove(e));s.isMuted()&&s.updateMutedStatus(!1),r&&ConversationsList.updateUnreadTimeAndCount(e,a),ChatUI.updateLastMsgInOtherArea(o),Chat.isThreadChatByChid(t)&&_print("parentchid_as_thread_chid",o),r&&this.addUnreadThreadChidInParentChat(t,e);var n=ConversationsList.isPinned(e);r&&!n&&(ChatUI.isThreadAsInlineChats()||this.isNewUnfollowedThreadChat(e))?(ThreadChatUtils.addUnreadChatInNotificationBanner(t,e),ConversationsList.checkAndAddChatInLHS(a),ConversationsUI.updateElement(t,null,!0)):(r&&ThreadChatUtils.addUnreadChatInNotificationBanner(t,e),r&&ConversationsUI.updateMsgCount(e,ConversationsList.getUnreadCount(e)),ConversationsList.checkAndAddChatInLHS(a))}},convertToThreadCardAndAddNewMsg:function(e,t,a,r){var o=a.threadmsguid,s=ThreadChatUtils.getCurrentPCount(a.threadchatid),n={thread_information:{chat_id:a.threadchatid,msguid:o,message_count:0,follower_count:+a.pcount||(r?s:s+1),is_follower:ThreadChatUtils.isParentMsgFollower(a)}};for(var i in e){var d=e[i],h=d.getList().getMessage(o);if(h&&!h.isThreadHeadMessage()){if(this.isThreadCard(h,t,o)||this.convertToThreadCard(h.msgobj,d,n),null==d.getView()){var l=d.getList().getMessage(o);if(l&&l.isThreadParentMessage()){var c=l.getThreadInfo().getThreadMsgCount();l.getThreadInfo().setThreadMsgCount(c+1)}return}var p=d.getThreadCards().getInstanceByMsgUid(o);p||_print("thread_card_construct_error",a),this.isTempThreadCard(h,t,o)&&(h.tempThread=!0,p.handleThreadChidUpdate(n.thread_information)),h.isThreadParentMessage()||p.createOrUpdateParticipantObjPartCount(),p.addNewMsgInStorage(MessageFactory(a,t)),ThreadCard.removePreviousSenderName(p),ThreadCard.constructNextSenderName(p)}}},updateChatIdInThreadCardIfNotDoneAlready:function(e){var t=StorageManager.getStoragesByChid(e.parentChatId);if(t)for(var a in t){var r=t[a].getThreadCards().getInstanceByMsgUid(e.threadmsguid);if(!r||null!=r.getThreadChatId())return;var o=this.getInitialThreadInfo(e);r.handleThreadChidUpdate(o)}},getInitialThreadInfo:function(e){return{chat_id:e.threadchatid,msguid:e.threadmsguid,message_count:0,follower_count:+e.pcount,is_follower:ThreadChatUtils.isParentMsgFollower(e)}},addNewMessageInStorages:function(e,t,a){for(var r in t.hasOwnProperty("threadmsg")||(t.threadmsg="true"),e){var o;o=$Util.cloneObject(t,!0);var s=MessageFactory(o,a);e[r].addNewMessage(s)}},isThreadCard:function(e,t,a){if(e.isThreadParentMessage()||e.tempThread)return!0;var r=ChatUI.getWin(t),o=r&&r.getStorage();return o?o.getThreadCards().hasThread(a):void 0},isTempThreadCard:function(e,t,a){if(e.tempThread)return!0;var r=ChatUI.getWin(t),o=r&&r.getStorage();if(o){var s=o.getThreadCards().getInstanceByMsgUid(a);return s&&null==s.getThreadChatId()}},handleDeleteMessage:function(e,t,a){this.isTempThreadCard(e,t,a)&&ThreadCard.removeFromCwin(ChatUI.getWin(t),a)},convertToThreadCard:function(e,t,a){var r=$.extend({},e,a),o=MessageFactory(r,a.threadChatId);o.isThreadCardConversion=!0,t.replaceMessage(o)},orientation:function(){var e={};return{canOpenInsideParentChat:function(t,a){return!!function(t){return e.hasOwnProperty(t)}(t)&&(e[t]&&MainUI.isChatinViewport(a))},setOpenInsideParentChat:function(t,a){e[t]=a},resetOpenInsideParentChat:function(t){delete e[t]}}}(),handleBotAdditionOrRemoval:function(e){var t=[],a=e.info;if(void 0!==a.botlist){for(var r=0;r<a.botlist.length;r++){var o=a.botlist[r],s=Bots.getObject(o);t.push({zuid:o,uname:o,dname:void 0!==s?s.name:Resource.getRealValue("channel.role.2")})}let n=+e.pcount;e.botscount&&(n+=+e.botscount),Participants.update(e.chid,t,"BOT ADDED"===a.mode?"14":"15",{isThreadChatParticipantUpdate:!0,parentMsgUid:e.threadmsguid,parentChatId:e.parentChatId,pcount:n})}}};var BubbleUserMaker=function(e){this.params=e,this.users=ThreadChatUtils.createHashMap(e.user),this.maxBubbleCount=e.maxBubble||5,this.id=window.getEventId();var t=$WC.template.replace(this.templates.element,{id:this.id});this.$el=$(t),this.moreUsers=[]};BubbleUserMaker.prototype.getHtml=function(){return this.render().$el.html()},BubbleUserMaker.prototype.removeUser=function(e){var t=this.getMoreCount(),a=this.users.delete(e);if(a&&(a=a.replace("$","\\$")),this.$el.find("[uid="+a+"]").first().remove(),t>0){if(1==t)this.$(this.DC.more_container).remove();else{var r=this.getMoreCount();this.$(this.DC.more).text(r)}var o=this.moreUsers.shift(),s=this.$(this.DC.more_container);if(this.$el.find("[uid]").length<this.maxBubbleCount){var n=this.getBubbleUserHtml(o);s.length?s.before(n):this.$el.append(n)}}return this},BubbleUserMaker.prototype.addUser=function(e){var t=this.getMoreCount(),a=this.users.add(e),r=this.getMoreCount();return t<0?(this.$el.append(this.getBubbleUserHtml(a)),this):(0==t?this.$el.append(this.getMoreUsersHtml(1)):this.$(this.DC.more).text(r),this.moreUsers.push(a),this)},BubbleUserMaker.prototype.getFirstBubbleId=function(){return this.users.getFirstId()},BubbleUserMaker.prototype.getUserId=function(e){return this.users.getUserId(e)},BubbleUserMaker.prototype.getUsersCount=function(){return this.users.getLength()},BubbleUserMaker.prototype.getUsers=function(){return this.users.getAll()},BubbleUserMaker.prototype.getMaxBubbleCount=function(){return this.maxBubbleCount},BubbleUserMaker.prototype.getMoreCount=function(){return this.getUsersCount()-this.getMaxBubbleCount()},BubbleUserMaker.prototype.render=function(){var e=this.getUsers();this.moreUsers=[];var t=this.getMaxBubbleCount(),a=e.splice(0,t),r=e.length;if(this.moreUsers=this.moreUsers.concat(e),this.$el.empty(),a.length){var o=this.getBubbleUsersHtml(a);this.$el.append(o)}if(r>0){var s=this.getMoreUsersHtml(r);this.$el.append(s)}return this},BubbleUserMaker.prototype.getBubbleUsersHtml=function(e){var t="",a=this;return e.forEach((function(e){t+=a.getBubbleUserHtml.call(a,e)})),t},BubbleUserMaker.prototype.getMoreUsersHtml=function(e){return e<=0?"":$WC.template.replace(this.templates.more_users,{count:e})},BubbleUserMaker.prototype.getBubbleUserHtml=function(e){return $WC.template.replace(this.templates.bubble_user,{src:Users.getImgUrlById(e),uid:e})},BubbleUserMaker.prototype.DC={more:"#bubble-more-count",more_container:"#bubble-more-container"},BubbleUserMaker.prototype.$=function(e){return this.$el.find(e)},BubbleUserMaker.prototype.templates=ThreadChatTemplates.bubble_maker;var ThreadUnsubs,ThreadUnsubsStorage,ThreadNotificationUI=function(e){this.id=window.getEventId(),this.parentChatId=e,this.unreadChidVsMsgInfo={},this.initUnreadChidVsMsgInfo(),this.bubbleUI=null,this.initBubbleUI(),this.$el=$(this.getContainer())};ThreadNotificationUI.prototype.getId=function(){return this.id},ThreadNotificationUI.prototype.render=function(){var e=this.getNotificationBannerContent();return this.$el.html(e),this},ThreadNotificationUI.prototype.initUnreadChidVsMsgInfo=function(){(ConversationsList.getUnReadThreadChids(this.parentChatId)||[]).forEach(this.setUnreadMsgInfo.bind(this))},ThreadNotificationUI.prototype.isValidUnreadThreadChid=function(e){return 0!=ConversationsList.getUnreadCount(e)},ThreadNotificationUI.prototype.setUnreadMsgInfo=function(e){this.isValidUnreadThreadChid(e)&&(this.unreadChidVsMsgInfo[e]={unreadCount:ConversationsList.getUnreadCount(e),unreadTime:ConversationsList.getUnreadTime(e),senderId:ConversationsList.getParentMsgSenderId(e),lastMsgSenderId:ConversationsList.getLastMsgSenderId(e),msgUid:ConversationsList.getParentMsgUid(e),threadChid:e,parentMsgTime:ConversationsList.getParentMsgUid(e).split("%20")[0]})},ThreadNotificationUI.prototype.isUnreadChidExists=function(e){return this.getUnreadChidVsMsgInfo().hasOwnProperty(e)},ThreadNotificationUI.prototype.getUnreadChidVsMsgInfo=function(){return this.unreadChidVsMsgInfo},ThreadNotificationUI.prototype.getUnReadThreadChids=function(){return Object.keys(this.unreadChidVsMsgInfo)},ThreadNotificationUI.prototype.removeUnreadChatAndUpdateUI=function(e){if(this.isUnreadChidExists(e))return this.bubbleUI.removeUser(e),delete this.getUnreadChidVsMsgInfo()[e],this.updateUnreadChatInUI(),this},ThreadNotificationUI.prototype.addUnreadChatAndUpdateUI=function(e){if(this.isUnreadChidExists(e))this.updateUnreadChat(e);else if(this.isValidUnreadThreadChid(e))return this.setUnreadMsgInfo(e),this.bubbleUI.addUser(this.getUserForConstructingBubble(e)).render(),this.updateUnreadChatInUI(),this},ThreadNotificationUI.prototype.updateUnreadChat=function(e){if(this.isUnreadChidExists(e)){var t=this.getLmsgSenderByChid(e);this.setUnreadMsgInfo(e),t!=this.getLmsgSenderByChid(e)&&this.bubbleUI.addUser(this.getUserForConstructingBubble(e)).render(),this.updateUnreadChatInUI()}},ThreadNotificationUI.prototype.updateUnreadChatInUI=function(){var e=this.getTotalUnreadThreadChats();this.$(this.DC.thread_unread_msg).text(e),PubSub.publish(ThreadChatUtils.constants.BANNER_UPDATE,{id:this.getId(),unreadThreadChatCount:e})},ThreadNotificationUI.prototype.getUsersForConstructingBubbles=function(){return this.getUnReadThreadChids().map(this.getUserForConstructingBubble.bind(this))},ThreadNotificationUI.prototype.getUserForConstructingBubble=function(e){var t=this.getUnreadChidVsMsgInfo()[e];return{id:t.threadChid,sortNumber:t.parentMsgTime,userId:t.lastMsgSenderId}},ThreadNotificationUI.prototype.initBubbleUI=function(){var e={user:this.getUsersForConstructingBubbles(),maxBubble:3};this.bubbleUI=new BubbleUserMaker(e)},ThreadNotificationUI.prototype.getTotalUnreadThreadChats=function(){return this.getUnReadThreadChids().length},ThreadNotificationUI.prototype.getLmsgSenderByChid=function(e){return this.getUnreadChidVsMsgInfo()[e].lastMsgSenderId},ThreadNotificationUI.prototype.getParentMsgUid=function(e){return this.getUnreadChidVsMsgInfo()[e].msgUid},ThreadNotificationUI.prototype.hasUnreadThreadChats=function(){return this.getTotalUnreadThreadChats()>0},ThreadNotificationUI.prototype.goToNextUnreadThread=function(){if(this.hasUnreadThreadChats()){this.disableBanner();var e=this.bubbleUI.getFirstBubbleId(),t=this.getParentMsgUid(e);Chat.jumpToConversation(this.parentChatId,!1,t,null,null,!0).then(this.handleAfterJumpToCoversation.bind(this,e))}},ThreadNotificationUI.prototype.handleAfterJumpToCoversation=function(e){this.fetchUnreadMsgsInThreadCard(e).then(this.afterFetchRecentMsgSuccess.bind(this,e))},ThreadNotificationUI.prototype.afterFetchRecentMsgSuccess=function(e){this.isUnreadChidExists(e)&&(this.scrollToThreadMsg(this.getParentMsgUid(e)),this.removeUnreadChatAndUpdateUI(e),this.enableBanner())},ThreadNotificationUI.prototype.scrollToThreadMsg=function(e){ChatUI.getWin(this.parentChatId).getStorage().getView().scrolltoMsg(e)},ThreadNotificationUI.prototype.fetchUnreadMsgsInThreadCard=function(e){return ChatUI.getWin(this.parentChatId).getStorage().getThreadCards().getInstanceByMsgUid(this.getParentMsgUid(e)).fetchUnreadMessages()},ThreadNotificationUI.prototype.disableBanner=function(){this.$el.addClass("curN")},ThreadNotificationUI.prototype.enableBanner=function(){this.$el.removeClass("curN")},ThreadNotificationUI.prototype.getNotificationBannerContent=function(){var e=this.getTotalUnreadThreadChats(),t=this.bubbleUI.render().$el,a=$WC.template.replace(this.templates.content,{unread_count:e}),r=$(a);return r.siblings(this.DC.bubbles_container).html(t),r},ThreadNotificationUI.prototype.getContainer=function(){return $WC.template.replace(this.templates.container,{parentchid:this.parentChatId})},ThreadNotificationUI.prototype.show=function(){return this.$el.removeClass("dN"),this},ThreadNotificationUI.prototype.hide=function(){this.$el.addClass("dN")},ThreadNotificationUI.prototype.$=function(e){return this.$el.find(e)},ThreadNotificationUI.prototype.DC={bubbles_container:"#bubbles-container",thread_unread_msg:"#thread-unread-msg"},ThreadNotificationUI.prototype.templates=ThreadChatTemplates.notificationBanner,ThreadUnsubs=function(){var e={},t=function(e){this.criteria=e};t.prototype={init:function(){this.isUnsubsAvailableInCache()?this.handleSuccessAndEmptyCallBack():a(this.criteria.threadchid,this.criteria.parentchid).then(this.handleSuccessAndEmptyCallBack.bind(this))},handleSuccessAndEmptyCallBack:function(){var e=this.criteria,t=ThreadUnsubsStorage.getZuidsByChid(e.threadchid),a=Participants.searchInParticipants(t,e);e.successcallback(e.val,a)},isUnsubsAvailableInCache:function(){return ThreadUnsubsStorage.isUnsubsAvailable(this.criteria.threadchid)}};var a=function(e,t){var a={threadChatId:e,parentChatId:t};return ThreadApis.fetchUnsubscribers(a).then(r.bind(null,e,t))},r=function(t,a,r){var o=r.data;o.forEach(Users.updateUsersFromParticipantsResponseObj.bind(this));var s=o.map((function(e){return e.zuid||e.botId}));ThreadUnsubsStorage.addAll(t,s),e.hasOwnProperty(a)||(e[a]=new Set),e[a].add(t)};return{getSearchResults:function(e){return new t(e).init(),{content:"",searchedlist:[],furtherreq:!0}},removeAllUnsubsCacheByParentChid:function(t){e.hasOwnProperty(t)&&(e[t].forEach((function(e){ThreadUnsubsStorage.remove(e)})),delete e[t])}}}(),ThreadUnsubsStorage=function(){var e={},t=function(t,a){r(t)&&(Array.isArray(a)?a.forEach((function(a){e[t].add(a)})):e[t].add(unsubZuid))},a=function(t,a){r(t)&&(void 0!==a?e[t].delete(a):delete e[t])},r=function(t){return e.hasOwnProperty(t)};return{add:t,addAll:function(t,a){e[t]=new Set(a)},update:function(e,a){r(e)&&Array.isArray(a)&&a.forEach(t.bind(null,e))},remove:a,isUserExist:function(t,a){if(r(t))return e[t].has(a)},removeMany:function(e,t){r(e)&&Array.isArray(t)&&t.forEach(a.bind(null,e))},getZuidsByChid:function(t){if(r(t))return Array.from(e[t])},isUnsubsAvailable:r}}();var ThreadCardDomCache=function(e){this.$threadCardElement=e,this.initDomSelectors()};ThreadCardDomCache.prototype={initDomSelectors:function(){this.DOM_SELECTORS={reply:"#thread-reply-win",followers_count:"#followers-count",followers_count_container:"#followers-container",post_checkbox:"#post-checkbox",reply_area:"#thread-reply-win #msgarea",composer_and_post_cb:"#composer-cb-cotainer",view_option:"#view-option",msg_preview_container:"#msgoptionspreview",msg_preview:"#msgoptionspreview #preview",total_msg_count:"#total-msgs",total_msg_container:"#total-msgs-cont",more_reply_cont:"#more-replies-container",pop_out_icon:"#popouticon",new_msg_loader:"#thread-msg-loader",non_msg_container:"#non-msg-container",reply_mode_content:"#reply-mode-content",prompt_banner:"#thread_promptbanner",newmsg_badge:"#newmsg-badge",auto_complete:"#compautocompletethread",retry_fetch:"#retryfetch",replies_button:"#replies-button",dot_loader:"#dotloader",thread_action_button:"#thread-action-btn",sender:"[purpose=sender]:first",urlpreview:"#urlpreview",closed_label:"#closed-label",thread_view_btn:"#thread-view-btn"}},getDom:function(e){return this.getThreadCard().find(e)},getThreadCard:function(){return this.$threadCardElement},getReply:function(){return this.getDom(this.DOM_SELECTORS.reply)},getFollowersCountContainer:function(){return this.getDom(this.DOM_SELECTORS.followers_count_container)},getFollowersCount:function(){return this.getDom(this.DOM_SELECTORS.followers_count)},getPostCheckBox:function(){return this.getDom(this.DOM_SELECTORS.post_checkbox)},getComposerAndPostCB:function(){return this.getDom(this.DOM_SELECTORS.composer_and_post_cb)},getViewOptions:function(){return this.getDom(this.DOM_SELECTORS.view_option)},getRepliesLink:function(){return this.getDom(this.DOM_SELECTORS.replies_button)},getThreeDotLoader:function(){return this.getDom(this.DOM_SELECTORS.dot_loader)},getFollowUnfollowBtn:function(){return this.getDom(this.DOM_SELECTORS.thread_action_button)},getReplyArea:function(){return this.getDom(this.DOM_SELECTORS.reply_area)},getMsgPreviewContainer:function(){return this.getDom(this.DOM_SELECTORS.msg_preview_container)},getMsgPreview:function(){return this.getDom(this.DOM_SELECTORS.msg_preview)},getTotalMsgContainer:function(){return this.getDom(this.DOM_SELECTORS.total_msg_container)},getLoadMoreCont:function(){return this.getDom(this.DOM_SELECTORS.more_reply_cont)},getPopOutIcon:function(){return this.getDom(this.DOM_SELECTORS.pop_out_icon)},getNewMsgLoader:function(){return this.getDom(this.DOM_SELECTORS.new_msg_loader)},getNonMsgContainer:function(){return this.getDom(this.DOM_SELECTORS.non_msg_container)},getReplyModeContainer:function(){return this.getDom(this.DOM_SELECTORS.reply_mode_content)},getParentMsgSender:function(){return this.getDom(this.DOM_SELECTORS.sender)},getUnreadBadge:function(){return this.getDom(this.DOM_SELECTORS.newmsg_badge)},getRetryFetch:function(){return this.getDom(this.DOM_SELECTORS.retry_fetch)},getAutoComplete:function(){return this.getDom(this.DOM_SELECTORS.auto_complete)},getClosedLabel:function(){return this.getDom(this.DOM_SELECTORS.closed_label)},getThreadViewBtn:function(){return this.getDom(this.DOM_SELECTORS.thread_view_btn)},getPromptBanner:function(){return this.getDom(this.DOM_SELECTORS.prompt_banner)},getComposerAutoComplete:function(e){return this.$autoComplete||(this.$autoComplete=this.getDom(this.DOM_SELECTORS.auto_complete+e))},getUrlPreview:function(){return this.$urlPreview||(this.$urlPreview=this.getDom(this.DOM_SELECTORS.urlpreview))},getComposer:function(){return this.$composer||(this.$composer=this.getDom(this.DOM_SELECTORS.composer))}};var ThreadSearchModel=function(e){this.threadParentChatId=e,this.threadsList=new ThreadList};ThreadSearchModel.prototype.getThreadParentChid=function(){return this.threadParentChatId},ThreadSearchModel.prototype.reset=function(){this.threadsList.reset()},ThreadSearchModel.prototype.getThreadsList=function(){return this.threadsList},ThreadSearchModel.prototype.getPageNo=function(){return this.getThreadsList().getPageNo()},ThreadSearchModel.prototype.isFirstPage=function(){return 0==this.getPageNo()},ThreadSearchModel.prototype.isPreviousPageNoOne=function(){return this.getPageNo()-1==0},ThreadSearchModel.prototype.isClosedThreadsEnabled=function(){return Settings.canIncludeCloseThreads()},ThreadSearchModel.prototype.hasNextThreads=function(){return this.getThreadsList().hasNext()},ThreadSearchModel.prototype.setSearchValue=function(e){this.searchValue=e},ThreadSearchModel.prototype.getSearchValue=function(){return this.searchValue||""},ThreadSearchModel.prototype.hasSearchValue=function(){return this.getThreadsList().hasSearchValue()},ThreadSearchModel.prototype.isAlreadyFetching=function(){return this.getThreadsList().isInProgress()},ThreadSearchModel.prototype.fetchNextFollowedThreads=function(){this.handleBeforeFetching();var e=this.getThreadsList().getFetchId();return ThreadApis.fetchFollowedThreads(this.getApiParams()).then(function(t){return this.onThreadFetchSuccess(t),{serverResponse:t,beforeFetchId:e,afterFetchId:this.getThreadsList().getFetchId()}}.bind(this),this.onThreadFetchFailure.bind(this))},ThreadSearchModel.prototype.getSearchLimit=function(){return $(document).height()<=852?2:3},ThreadSearchModel.prototype.fetchNextUnfollowedThreads=function(){this.handleBeforeFetching();var e=this.getThreadsList().getFetchId();return ThreadApis.fetchUnfollowedThreads(this.getApiParams()).then(function(t){return this.onThreadFetchSuccess(t),{serverResponse:t,beforeFetchId:e,afterFetchId:this.getThreadsList().getFetchId()}}.bind(this),this.onThreadFetchFailure.bind(this))},ThreadSearchModel.prototype.getApiParamsForTitleSearch=function(e){e=e||{};var t=this.getThreadsList();return{parentChatId:this.getThreadParentChid(),limit:e.limit||this.getSearchLimit(),searchValue:t.getSearchValue(),threadType:this.isClosedThreadsEnabled()?"":"open",nextToken:0==t.getTitleSearchPageNo()?Date.now():t.getNextTitleSearchToken()}},ThreadSearchModel.prototype.getApiParamsForMessageSearch=function(e){e=e||{};var t=this.getThreadsList();return{parentChatId:this.getThreadParentChid(),limit:e.limit||this.getSearchLimit()-1,searchValue:t.getSearchValue(),nextToken:t.getMessageSearchPageNo()}},ThreadSearchModel.prototype.fetchNextTitleSearch=function(){var e=this.getThreadsList();if(!e.hasNextTitleSearch())return Promise.resolve();this.handleBeforeFetching();var t=e.getFetchId(),a=this;return ThreadApis.fetchTitleSearch(this.getApiParamsForTitleSearch({limit:10})).then((function(e){return a.onTitleFetchSuccess(e),{data:e.data.chats||[],matchedSearchValue:e.data.matched_search_value,beforeFetchId:t,afterFetchId:a.getThreadsList().getFetchId()}}))},ThreadSearchModel.prototype.fetchNextMessageSearch=function(){var e=this.getThreadsList();if(!e.hasNextMessageSearch())return Promise.resolve();this.handleBeforeFetching();var t=e.getFetchId(),a=this;return ThreadApis.fetchMessageSearch(this.getApiParamsForMessageSearch({limit:10})).then((function(e){var r=a.getThreadsList().getMessageSearchPageNo();return a.onMessageFetchSuccess(e),{data:e.data.messages||[],pageNo:r,matchedSearchValue:e.data.matched_search_value,beforeFetchId:t,afterFetchId:a.getThreadsList().getFetchId()}}))},ThreadSearchModel.prototype.fetchThreadsAndMessagesFromServer=function(){var e=this;this.handleBeforeFetching();var t=this.getThreadsList().getFetchId(),a=[ThreadApis.fetchTitleSearch(this.getApiParamsForTitleSearch()),ThreadApis.fetchMessageSearch(this.getApiParamsForMessageSearch())];return Promise.all(a).then((function(a){var r=a[0],o=a[1];e.onTitleFetchSuccess(r),e.onMessageFetchSuccess(o);var s=e.getThreadsList();return{titleMatchResponse:r.data.chats||[],messageMatchResponse:o.data.messages||[],matchedSearchValue:r.data.matched_search_value||o.data.matched_search_value,hasMoreTitleMatches:s.hasNextTitleSearch(),hasMoreMessageMatches:s.hasNextMessageSearch(),beforeFetchId:t,afterFetchId:e.getThreadsList().getFetchId()}}),(function(){return e.onThreadFetchFailure()}))},ThreadSearchModel.prototype.onTitleFetchSuccess=function(e){var t=this.getThreadsList(),a=e.data.chats;if(t.increaseTitleSearchPageNo(),!a||!a.length||a.length<=e.limit)t.setNextTitleSearchToken("");else{a.splice(-1);var r=a[a.length-1].lmtime;t.setNextTitleSearchToken(r-1)}t.setIsInProgress(!1)},ThreadSearchModel.prototype.onMessageFetchSuccess=function(e){var t=this.getThreadsList(),a=e.data.messages;t.increareMessageSearchPageNo(),!a||!a.length||a.length<=e.limit?t.setNextMessageSearchToken(""):t.setNextMessageSearchToken(t.getMessageSearchPageNo()),t.setIsInProgress(!1)},ThreadSearchModel.prototype.getApiParams=function(){var e=this.getThreadsList(),t={parentChatId:this.getThreadParentChid()};return this.isClosedThreadsEnabled()||(t.type="open"),e.hasSearchValue()?(t.searchValue=e.getSearchValue(),t.nextSearchToken=e.getNextToken()):t.nextToken=e.getNextToken(),t},ThreadSearchModel.prototype.makeServerCallToEnableAutoFollowThreads=function(){return ThreadApis.enableAutoFollowThreads(Channels.getChannelId(this.getThreadParentChid()))},ThreadSearchModel.prototype.makeServerCallToDisableAutoFollowThreads=function(){return ThreadApis.disableAutoFollowThreads(Channels.getChannelId(this.getThreadParentChid()))},ThreadSearchModel.prototype.handleBeforeFetching=function(){var e=this.getThreadsList();e.setIsInProgress(!0),e.setFetchId(window.getEventId()),e.setSearchValue(this.getSearchValue())},ThreadSearchModel.prototype.onThreadFetchSuccess=function(e){var t=this.getThreadsList();e.data.length&&t.increasePageNo(),t.updateNextToken(e.next_search_token||e.next_token),t.setIsInProgress(!1)},ThreadSearchModel.prototype.onThreadFetchFailure=function(){return this.getThreadsList().setIsInProgress(!1),Promise.reject()};var ThreadList=function(){this.init()};ThreadList.prototype.init=function(){this.pageNo=0,this.nextToken="",this.inProgress=!1,this.searchValue="",this.fetchId=null,this.nextTitleSearchToken="",this.nextMessageSearchToken="",this.titleSearchPageNo=0,this.messageSearchPageNo=0},ThreadList.prototype.reset=function(){this.init()},ThreadList.prototype.getNextTitleSearchToken=function(){return this.nextTitleSearchToken},ThreadList.prototype.setNextTitleSearchToken=function(e){this.nextTitleSearchToken=e},ThreadList.prototype.getNextMessageSearchToken=function(){return this.nextMessageSearchToken},ThreadList.prototype.setNextMessageSearchToken=function(e){this.nextMessageSearchToken=e},ThreadList.prototype.getTitleSearchPageNo=function(){return this.titleSearchPageNo},ThreadList.prototype.getMessageSearchPageNo=function(){return this.messageSearchPageNo},ThreadList.prototype.increareMessageSearchPageNo=function(){++this.messageSearchPageNo},ThreadList.prototype.increaseTitleSearchPageNo=function(){++this.titleSearchPageNo},ThreadList.prototype.hasNextTitleSearch=function(){return 0==this.titleSearchPageNo||Boolean(this.nextTitleSearchToken)},ThreadList.prototype.hasNextMessageSearch=function(){return 0==this.messageSearchPageNo||Boolean(this.nextMessageSearchToken)},ThreadList.prototype.hasNext=function(){return 0==this.pageNo||Boolean(this.nextToken)},ThreadList.prototype.getNextToken=function(){return this.nextToken},ThreadList.prototype.updateNextToken=function(e){this.nextToken=e},ThreadList.prototype.getPageNo=function(){return this.pageNo},ThreadList.prototype.getSearchValue=function(){return this.searchValue},ThreadList.prototype.hasSearchValue=function(){return Boolean(this.searchValue)},ThreadList.prototype.setSearchValue=function(e){this.searchValue=e},ThreadList.prototype.increasePageNo=function(){this.pageNo++},ThreadList.prototype.isInProgress=function(){return this.inProgress},ThreadList.prototype.setIsInProgress=function(e){this.inProgress=e},ThreadList.prototype.setFetchId=function(e){this.fetchId=e},ThreadList.prototype.getFetchId=function(e){return this.fetchId};var ThreadSearchView=function(e){this.threadParentChatId=e,this.id=window.getEventId()+"thread-search-view",this.$el=$(this.getContainer())};ThreadSearchView.prototype.getId=function(){return this.id},ThreadSearchView.prototype.destroy=function(){this.$el.remove()},ThreadSearchView.prototype.getDOMStrings=function(){return this.DC},ThreadSearchView.prototype.showLoader=function(){this.$el.html(this.templates.main_loader)},ThreadSearchView.prototype.removeLoader=function(){this.$(this.DC.main_loader).remove()},ThreadSearchView.prototype.showFailureState=function(){this.$el.html($Util.emptyStateHtml(this.errorStates.common))},ThreadSearchView.prototype.appendHead=function(){var e=$WC.template.replace,t=Channels.isAutoFollowThreadsEnabled(Channels.getChannelId(this.threadParentChatId)),a=Config.isAutoFollowThreadEnabled()?e(this.templates.autoFollowThreads,{chatId:this.threadParentChatId,checked:t?"checked":"",title:ConversationsList.getTitle(this.threadParentChatId)+" - "+I18N("threads.title")}):"",r=e(this.templates.closedThreadCheckBox,{chatId:this.threadParentChatId,checked:Settings.canIncludeCloseThreads()?"checked":""}),o=e(this.templates.searchBar,{}),s=e(this.templates.followed_tab,{}),n=e(this.templates.unfollowed_tab,{}),i=e(this.templates.tabs,{followed_tab:s,unfollowed_tab:n},"InSecureHTML"),d=e(this.templates.head,{auto_follow_threads:a,search_bar:o,close_threads_cb:r,tabs:i},"InSecureHTML");this.$el.append(d)},ThreadSearchView.prototype.appendBody=function(){this.$el.append(this.templates.body)},ThreadSearchView.prototype.getLastMsg=function(e){var t=e.chat_id,a=ConversationsList.getLastMsgInChat(t)||e.last_message_information;return a=ConversationsList.parseLastMsgInfo(t,a),ConversationsList.getLastMsgHTML(t,a,e.title,{})},ThreadSearchView.prototype.getLastMsgTime=function(e){var t=e.last_message_information;return"string"!=typeof t||0==t.length?"":$Date.daytime(MsgUtil.getTimefromMsgObj(JSON.parse(t)))},ThreadSearchView.prototype.getSearchedMessageData=function(e){var t=e.message?$WC.$CUtil.processXSS(e.message,!0):"",a="";return"3"===e.messagetype&&(t=e.fname?$WC.$CUtil.processXSS(e.fname):"",a=$WC.$CUtil.processXSS(e.fcomment)||""),t=$WC.Util.isEmpty(a)?t:t+", "+a},ThreadSearchView.prototype.getSearchedMsg=function(e){var t=this.getSearchedMessageData(e);t=_highlightNonConsecutiveSearchText($WC.Util.decodeHTMLEntities(t),e.matched_search_value,"zcclr")||t,t=Markdown.apply(t),t=Smiley.replace(t),t=MsgUtil.getDisplayableSilentUserMentionMsg(t);var a=$WC.template.replace,r=e.sendername&&e.sender?Users.getName(e.sender,e.sendername):"",o=r?a(this.templates.matchedMsgSender,{senderName:r,bold_class:Config.isAccordionEnabledInThreadSearch()?"":"bold"}):"";return $WC.template.replace(this.templates.matchedMsg,{msg:t,senderName:o},"InSecureHTML")},ThreadSearchView.prototype.getListItem=function(e){var t=$WC.template.replace,a=ConversationsList.getUnreadCount(e.chat_id),r=e.is_follower,o="title"==e.search_type,s="message"==e.search_type,n=!(o||s)&&a>0&&r,i="closed"==e.thread_state?"closedthreadlist":"",d=o?_highlightSearchText(e.title,e.matched_search_value):s&&Config.isAccordionEnabledInThreadSearch()?'<span class="zcf-startthread font12 mT3 mR4 fontB"></span><span class="ellips">'+$WC.$CUtil.processXSS(e.title)+"</span>":$WC.$CUtil.processXSS(e.title),h={img_url:Users.getImgUrlById(e.parent_message_sender),thread_chat_id:e.chat_id,unread_cls:n?"unread":"",msgtime:e.time||"",msgsender:e.sender||"",parentmsguid:e.thread_message_id||"",closedthreadclass:i,title_class:s&&Config.isAccordionEnabledInThreadSearch()?"fontB clr-lp1 flexC":"",hide_class:s&&Config.isAccordionEnabledInThreadSearch()?"dN":""},l={thread_chat_title:d,last_message:s?this.getSearchedMsg(e):this.getLastMsg(e),unread_count_html:n?t(this.templates.unread_count,{count:a}):"",msg_time_html:s?$Date.daytime(e.time):this.getLastMsgTime(e)},c=t(this.templates.list_item,h);return t(c,l,"InSecureHTML")},ThreadSearchView.prototype.updateSearchObj=function(e){e.chat_id=e.chat_id||e.chid||e.chatid,e.last_message_information=e.last_message_information||e.lastmsginfo,e.follower_count=e.follower_count||e.pcount,e.title=e.title||e.ctitle},ThreadSearchView.prototype.getListItems=function(e){if(!e||!Array.isArray(e))return"";var t=this,a="";return e.forEach((function(r){e.isTitleMatch&&(r.search_type="title"),e.isMessageMatch&&(r.search_type="message"),e.matchedSearchValue&&(r.matched_search_value=e.matchedSearchValue),t.updateSearchObj(r),a+=t.getListItem(r)})),a},ThreadSearchView.prototype.renderAccordionWithResults=function(e){var t=e.threadTitleMatches,a=e.threadMessageMatches,r=$WC.template.replace;t.isTitleMatch=!0,a.isMessageMatch=!0,t.matchedSearchValue=e.matchedSearchValue,a.matchedSearchValue=e.matchedSearchValue;var o=this.isFollowedTabSelected(),s=o?this.templates.followed_title_search_body:this.templates.unfollowed_title_search_body,n=o?this.templates.followed_message_search_body:this.templates.unfollowed_message_search_body,i=(0==t.length?"":r(s,{list:this.getListItems(t),showMore:e.hasMoreTitleMatches?this.getShowMoreForAccordion(!0):""},"InSecureHTML"))+(0==a.length?"":r(n,{list:this.getListItems(a),showMore:e.hasMoreMessageMatches?this.getShowMoreForAccordion():""},"InSecureHTML"));this.$(o?this.DC.followed_search_container:this.DC.unfollowed_search_container).html(i).removeClass("dN")},ThreadSearchView.prototype.isTitleSearchExpanded=function(){var e=this.isFollowedTabSelected()?this.DC.followed_title_search_container:this.DC.unfollowed_title_search_container;return!this.$(e).hasClass("dN")},ThreadSearchView.prototype.isMessageSearchExpanded=function(){var e=this.isFollowedTabSelected()?this.DC.followed_message_search_container:this.DC.unfollowed_message_search_container;return!this.$(e).hasClass("dN")},ThreadSearchView.prototype.appendTitleSearch=function(e,t){var a=e.data;a.isTitleMatch=!0,a.matchedSearchValue=e.matchedSearchValue;var r=t?this.DC.followed_title_search_container:this.DC.unfollowed_title_search_container;this.$(r).append(this.getListItems(a))},ThreadSearchView.prototype.appendMessageSearch=function(e,t){var a=e.data;a.isMessageMatch=!0,a.matchedSearchValue=e.matchedSearchValue;var r=t?this.DC.followed_message_search_container:this.DC.unfollowed_message_search_container;1==e.pageNo?this.$(r).html(this.getListItems(a)):this.$(r).append(this.getListItems(a))},ThreadSearchView.prototype.getShowMoreForAccordion=function(e){return $WC.template.replace(this.templates.show_more,{action:e?"onShowMoreTitleSearchClick":"onShowMoreMessageSearchClick",id:e?"show-more-title-search":"show-more-message-search"})},ThreadSearchView.prototype.clearAccordion=function(){this.$(this.DC.followed_search_container).html("").addClass("dN"),this.$(this.DC.unfollowed_search_container).html("").addClass("dN")},ThreadSearchView.prototype.toggleLoaderForTitleSearch=function(e){var t=this.isFollowedTabSelected()?this.DC.followed_title_search_container:this.DC.unfollowed_title_search_container,a=this.$(this.DC.title_search_loader);if(e)a.remove();else{if(a.length)return;var r=this.templates.bottom_loader.replace("{{id}}","bottom-loader-title");this.$(t).append(r)}},ThreadSearchView.prototype.toggleLoaderForMessageSearch=function(e){var t=this.isFollowedTabSelected()?this.DC.followed_message_search_container:this.DC.unfollowed_message_search_container,a=this.$(this.DC.message_search_loader);if(e)a.remove();else{if(a.length)return;var r=this.templates.bottom_loader.replace("{{id}}","bottom-loader-search");this.$(t).append(r)}},ThreadSearchView.prototype.removeLoaderForShowMoreTitleSearch=function(){this.$(this.DC.three_dot_loader).remove()},ThreadSearchView.prototype.removeShowMoreTitle=function(){this.$(this.DC.show_more_title_search).remove()},ThreadSearchView.prototype.toggleShowMoreTitleButton=function(e){this.$(this.DC.show_more_title_search).toggleClass("dN",!!e)},ThreadSearchView.prototype.toggleShowMoreMessageButton=function(e){this.$(this.DC.show_more_message_search).toggleClass("dN",!!e)},ThreadSearchView.prototype.toggleTitleHeaderArrow=function(e){var t=this.isFollowedTabSelected()?this.DC.followed_title_arrow:this.DC.unfollowed_title_arrow;this.$(t).toggleClass("zcl-flip",e)},ThreadSearchView.prototype.toggleMessageHeaderArrow=function(e){var t=this.isFollowedTabSelected()?this.DC.followed_message_arrow:this.DC.unfollowed_message_arrow;this.$(t).toggleClass("zcl-flip",e)},ThreadSearchView.prototype.toggleTitleSearchBody=function(e,t){var a=this.isFollowedTabSelected(),r=this.$(a?this.DC.followed_title_search_container:this.DC.unfollowed_title_search_container);(e||t)&&this.toggleShowMoreTitleButton(e),r.toggleClass("thread-title-expand-full",!e),r.toggleClass("dN",!!e)},ThreadSearchView.prototype.toggleMessageSearchBody=function(e){var t=this.isFollowedTabSelected();this.$(t?this.DC.followed_message_search_container:this.DC.unfollowed_message_search_container).toggleClass("dN",!!e)},ThreadSearchView.prototype.showLoaderInTitleSearch=function(){var e=this.isFollowedTabSelected()?this.DC.followed_title_search_container:this.DC.unfollowed_title_search_container;this.$(e).append(this.templates.bottom_loader)},ThreadSearchView.prototype.appendFollowedList=function(e){this.$(this.DC.followed_list).append(e)},ThreadSearchView.prototype.appendUnfollowedList=function(e){this.$(this.DC.unfollowed_list).append(e)},ThreadSearchView.prototype.$getFollowedListContainer=function(){return this.$(this.DC.followed_list)},ThreadSearchView.prototype.$getUnfollowedListContainer=function(){return this.$(this.DC.unfollowed_list)},ThreadSearchView.prototype.selectFirstFollowedThread=function(){this.$getFollowedListContainer().children("[list-item]").first().addClass("sel")},ThreadSearchView.prototype.selectFirstAccordionItem=function(){var e=this.isFollowedTabSelected()?this.DC.followed_search_container:this.DC.unfollowed_search_container;this.$(e).find("[list-item]").first().addClass("sel")},ThreadSearchView.prototype.selectFirstUnfollowedThread=function(){this.$getUnfollowedListContainer().children("[list-item]").first().addClass("sel")},ThreadSearchView.prototype.getSelectedFollowedThread=function(){return this.$getFollowedListContainer().children("[list-item].sel")[0]||this.$(this.DC.followed_search_container).find("[list-item].sel")[0]},ThreadSearchView.prototype.getSelectedUnfollowedThread=function(){return this.$getUnfollowedListContainer().children("[list-item].sel")[0]||this.$(this.DC.unfollowed_search_container).find("[list-item].sel")[0]},ThreadSearchView.prototype.clearFollowedList=function(){this.$getFollowedListContainer().empty()},ThreadSearchView.prototype.clearUnfollowedList=function(){this.$getUnfollowedListContainer().empty()},ThreadSearchView.prototype.selectUnfollowedTab=function(){this.$(this.DC.unfollowed_tab).addClass("sel")},ThreadSearchView.prototype.selectFollowedTab=function(){this.$(this.DC.followed_tab).addClass("sel")},ThreadSearchView.prototype.unSelectUnfollowedTab=function(){this.$(this.DC.unfollowed_tab).removeClass("sel")},ThreadSearchView.prototype.unSelectFollowedTab=function(){this.$(this.DC.followed_tab).removeClass("sel")},ThreadSearchView.prototype.isUnfollowedTabSelected=function(){return this.$(this.DC.unfollowed_tab).hasClass("sel")},ThreadSearchView.prototype.isFollowedTabSelected=function(){return this.$(this.DC.followed_tab).hasClass("sel")},ThreadSearchView.prototype.isUnfollowedTabSelected=function(){return this.$(this.DC.unfollowed_tab).hasClass("sel")},ThreadSearchView.prototype.isClosedThreadsEnabled=function(){return this.$(this.DC.closed_threads_checkbox).is(":checked")},ThreadSearchView.prototype.disableClosedThreadsContainer=function(){return this.$(this.DC.closed_threads_container).addClass("curN")},ThreadSearchView.prototype.enableClosedThreadsContainer=function(){return this.$(this.DC.closed_threads_container).removeClass("curN")},ThreadSearchView.prototype.hasFollowedList=function(){return this.$(this.DC.followed_list).children("[list-item]").length>0||this.$(this.DC.followed_search_container).find("[list-item]").length>0},ThreadSearchView.prototype.hasUnfollowedList=function(){return this.$(this.DC.unfollowed_list).children("[list-item]").length>0||this.$(this.DC.unfollowed_search_container).find("[list-item]").length>0},ThreadSearchView.prototype.$getFollowedContainerForNavigation=function(){return this.$(this.DC.followed_list).children("[list-item]").length?this.$getFollowedListContainer():this.$(this.DC.followed_search_container)},ThreadSearchView.prototype.$getUnfollowedContainerForNavigation=function(){return this.$(this.DC.unfollowed_list).children("[list-item]").length?this.$getUnfollowedListContainer():this.$(this.DC.unfollowed_search_container)},ThreadSearchView.prototype.clickNextTab=function(){this.isFollowedTabSelected()?this.$(this.DC.unfollowed_tab).click():this.$(this.DC.followed_tab).click()},ThreadSearchView.prototype.showBottomLoader=function(){this.$(this.DC.bottom_loader).removeClass("dN")},ThreadSearchView.prototype.removeBottomLoader=function(){this.$(this.DC.bottom_loader).addClass("dN")},ThreadSearchView.prototype.showFollowedListLoader=function(){this.$(this.DC.followed_list).removeClass("dN").html(this.templates.main_loader)},ThreadSearchView.prototype.removeFollowedListLoader=function(){this.$(this.DC.followed_list_loader).remove()},ThreadSearchView.prototype.showUnfollowedListLoader=function(){this.$(this.DC.unfollowed_list).removeClass("dN").html(this.templates.main_loader)},ThreadSearchView.prototype.removeUnfollowedListLoader=function(){this.$(this.DC.unfollowed_list_loader).remove()},ThreadSearchView.prototype.showFollowedEmpty=function(){this.$(this.DC.followed_list).html($Util.emptyStateHtml(this.emptyStates.followed))},ThreadSearchView.prototype.showUnfollowedEmpty=function(){this.$(this.DC.unfollowed_list).html($Util.emptyStateHtml(this.emptyStates.unfollowed))},ThreadSearchView.prototype.showFollowedSearchEmpty=function(){this.$(this.DC.followed_list).html($Util.emptyStateHtml(this.emptyStates.search))},ThreadSearchView.prototype.showUnfollowedSearchEmpty=function(){this.$(this.DC.unfollowed_list).html($Util.emptyStateHtml(this.emptyStates.search))},ThreadSearchView.prototype.showFollowedFailure=function(){this.$(this.DC.followed_list).html($Util.emptyStateHtml(this.errorStates.common))},ThreadSearchView.prototype.showUnfollowedFailure=function(){this.$(this.DC.unfollowed_list).html($Util.emptyStateHtml(this.errorStates.common))},ThreadSearchView.prototype.getSearchValue=function(){return this.$(this.DC.search_input_box).val().trim()},ThreadSearchView.prototype.clearSearchInput=function(){this.$(this.DC.search_input_box).val("")},ThreadSearchView.prototype.focusSearchInput=function(){this.$(this.DC.search_input_box).focus()},ThreadSearchView.prototype.getThreadChatData=function(e){return e.closest("[list-item]").dataset},ThreadSearchView.prototype.getContainer=function(){return $WC.template.replace(this.templates.container,{id:this.getId(),chatId:this.threadParentChatId})},ThreadSearchView.prototype.showFollowedTabUnreadCount=function(e){this.$(this.DC.followed_tab_unread).text(e).removeClass("dN")},ThreadSearchView.prototype.hideFollowedTabUnreadCount=function(){this.$(this.DC.followed_tab_unread).addClass("dN")},ThreadSearchView.prototype.toggleLoaderInAutoFollowSwitch=function(e){this.$(this.DC.auto_follow_container).toggleClass("loading_progress",e)},ThreadSearchView.prototype.setAutoFollowSwitch=function(e){this.$(this.DC.auto_follow_checkbox).prop("checked",e)},ThreadSearchView.prototype.$=function(e){return this.$el.find(e)},ThreadSearchView.prototype.emptyStates={followed:{imageclass:"zcempty-img followed_empty",title:I18N("thread.empty.followed"),subtitle:"",fontSize:"18"},unfollowed:{imageclass:"zcempty-img unfollowed_empty",title:I18N("thread.empty.unfollowed"),subtitle:"",fontSize:"18"},search:{imageclass:"zcempty-img search_empty",title:I18N("common.search.result.none"),subtitle:"",fontSize:"18"}},ThreadSearchView.prototype.errorStates={common:{imageclass:"zcempty-img error_img",title:I18N("thread.fail"),subtitle:"",fontSize:"18"}},ThreadSearchView.prototype.DC={main_loader:"#mainLoader",followed_tab:"#followed-tab",unfollowed_tab:"#unfollowed-tab",followed_list:"#followed-list",unfollowed_list:"#unfollowed-list",followed_list_loader:"#followed-list #mainLoader",followed_title_search_container:"#followed-title-search-body",followed_message_search_container:"#followed-message-search-body",unfollowed_title_search_container:"#unfollowed-title-search-body",unfollowed_message_search_container:"#unfollowed-message-search-body",unfollowed_list_loader:"#unfollowed-list #mainLoader",unfollowed_search_container:"#unfollowed-list-search-container",followed_search_container:"#followed-list-search-container",search_input_box:"#search-thread-messages",bottom_loader:"#bottomloader",title_search_loader:"#bottom-loader-title",message_search_loader:"#bottom-loader-search",followed_title_arrow:"#followed-title-search-head #thread-title-accordion-arrow",followed_message_arrow:"#followed-message-search-head #thread-message-accordion-arrow",unfollowed_title_arrow:"#unfollowed-title-search-head #thread-title-accordion-arrow",unfollowed_message_arrow:"#unfollowed-message-search-head #thread-message-accordion-arrow",thread_list_item:"[list-item]",followed_tab_unread:"#followed-tab-unread",auto_follow_container:"#auto-follow-container",auto_follow_checkbox:"#auto-follow-threads",closed_threads_checkbox:"#closed-threads-cb",closed_threads_container:"#close-thread-cb-container",show_more_title_search:"#show-more-title-search",show_more_message_search:"#show-more-message-search",three_dot_loader:"#small-dot-loader"},ThreadSearchView.prototype.templates=ThreadChatTemplates.search;var ThreadSearchController=function(e,t){this.threadParentChatId=e,this.params=t||{},this.threadSearchModel=new ThreadSearchModel(this.threadParentChatId),this.threadSearchView=new ThreadSearchView(this.threadParentChatId)};ThreadSearchController.prototype.bindEvents=function(){var e=this.getView(),t=e.getDOMStrings(),a=this;e.$el.on("click","[data-action]",(function(e){var t=$(this).attr("data-action");t in a&&a[t](e)})),this.bindFollowedListScroll(),this.bindUnfollowedListScroll(),e.$(t.search_input_box).on("keydown",this.onSearchKeyDown.bind(this)),e.$(t.search_input_box).on("keyup",$Util.debounce(this.onSearchKeyUp,this,300)),e.$el.on("click",t.thread_list_item,(function(e){a.onListItemClick(e)}))},ThreadSearchController.prototype.bindFollowedListScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.followed_list).on("scroll",$Util.debounce(this.onFollowedListScroll,this,200))},ThreadSearchController.prototype.bindFollowedTitleSearchScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.followed_title_search_container).on("scroll",$Util.debounce(this.onTitleSearchScroll,this,200))},ThreadSearchController.prototype.bindUnfollowedTitleSearchScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.unfollowed_title_search_container).on("scroll",$Util.debounce(this.onTitleSearchScroll,this,200))},ThreadSearchController.prototype.bindFollowedMessageSearchScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.followed_message_search_container).on("scroll",$Util.debounce(this.onMessageSearchScroll,this,200))},ThreadSearchController.prototype.bindUnfollowedMessageSearchScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.unfollowed_message_search_container).on("scroll",$Util.debounce(this.onMessageSearchScroll,this,200))},ThreadSearchController.prototype.unbindFollowedListScroll=function(){var e=this.getView();e.$(e.getDOMStrings().followed_list).off("scroll")},ThreadSearchController.prototype.bindUnfollowedListScroll=function(){var e=this.getView(),t=e.getDOMStrings();e.$(t.unfollowed_list).on("scroll",$Util.debounce(this.onUnfollowedListScroll,this,200))},ThreadSearchController.prototype.unbindUnfollowedListScroll=function(){var e=this.getView();e.$(e.getDOMStrings().unfollowed_list).off("scroll")},ThreadSearchController.prototype.onFetchListFailure=function(){var e=this.getView();e.removeBottomLoader(),e.removeListLoader()},ThreadSearchController.prototype.renderView=function(){var e=this.getView();return e.appendHead(),e.appendBody(),e.showFollowedListLoader(),this.fetchFollowedThreadsAndUpdateUI(),this.bindEvents(),this},ThreadSearchController.prototype.onUnfollowedTabClick=function(){var e=this.getView();e.isUnfollowedTabSelected()||(this.getModel().reset(),e.selectUnfollowedTab(),e.unSelectFollowedTab(),e.clearFollowedList(),e.clearAccordion(),e.showUnfollowedListLoader(),this.fetchUnfollowedThreadsAndUpdateUI())},ThreadSearchController.prototype.onFollowedTabClick=function(){var e=this.getView();e.isFollowedTabSelected()||(this.getModel().reset(),e.unSelectUnfollowedTab(),e.selectFollowedTab(),e.clearUnfollowedList(),e.clearAccordion(),e.showFollowedListLoader(),this.fetchFollowedThreadsAndUpdateUI())},ThreadSearchController.prototype.clearAccordionView=function(){Config.isAccordionEnabledInThreadSearch()&&this.getView().clearAccordion()},ThreadSearchController.prototype.fetchThreadsAndMessagesAndRenderAsAccordion=function(){var e=this.getModel(),t=this.getView(),a=t.isFollowedTabSelected();if(a?this.hasNoFollowedThreads:this.hasNoUnfollowedThreads)return a?t.showFollowedEmpty():t.showUnfollowedEmpty(),Promise.resolve();a?t.showFollowedListLoader():t.showUnfollowedListLoader();return e.fetchThreadsAndMessagesFromServer().then(this.handleThreadsTitleAndMessageSearchSuccess.bind(this),(function(){a?t.showFollowedFailure():t.showUnfollowedFailure()}))},ThreadSearchController.prototype.handleThreadsTitleAndMessageSearchSuccess=function(e){if(e.beforeFetchId==e.afterFetchId){var t=this.getView(),a=t.isFollowedTabSelected();a?t.removeFollowedListLoader():t.removeUnfollowedListLoader();var r=e.titleMatchResponse,o=e.messageMatchResponse;if(0==r.length&&0==o.length)a?t.showFollowedSearchEmpty():t.showUnfollowedSearchEmpty();else{var s={threadTitleMatches:r,threadMessageMatches:o,hasMoreTitleMatches:e.hasMoreTitleMatches,hasMoreMessageMatches:e.hasMoreMessageMatches,matchedSearchValue:e.matchedSearchValue};t.renderAccordionWithResults(s),t.selectFirstAccordionItem()}}},ThreadSearchController.prototype.onShowMoreTitleSearchClick=function(e){e&&e.stopPropagation();var t=this.getView();t.toggleShowMoreTitleButton(!0);var a=t.isFollowedTabSelected();t.toggleTitleSearchBody(),t.toggleLoaderForTitleSearch(),a?this.bindFollowedTitleSearchScroll():this.bindUnfollowedTitleSearchScroll();this.loadNextTitleSearch().then((function(){t.toggleMessageSearchBody(!0),t.removeShowMoreTitle(),t.toggleTitleHeaderArrow(!1),t.toggleMessageHeaderArrow(!0)}),(function(){t.toggleShowMoreTitleButton(),t.toggleLoaderForTitleSearch(!0)}))},ThreadSearchController.prototype.loadNextTitleSearch=function(){var e=this.getModel(),t=this.getView();return e.fetchNextTitleSearch().then((function(e){if(e.beforeFetchId==e.afterFetchId){t.toggleLoaderForTitleSearch(!0);var a={data:e.data,matchedSearchValue:e.matchedSearchValue};t.appendTitleSearch(a,t.isFollowedTabSelected())}}))},ThreadSearchController.prototype.loadNextMessageSearch=function(){var e=this.getModel(),t=this.getView();return e.fetchNextMessageSearch().then((function(e){if(e.beforeFetchId==e.afterFetchId){t.toggleLoaderForMessageSearch(!0);var a={data:e.data,matchedSearchValue:e.matchedSearchValue,pageNo:e.pageNo};t.appendMessageSearch(a,t.isFollowedTabSelected())}}))},ThreadSearchController.prototype.onShowMoreMessageSearchClick=function(e){e&&e.stopPropagation();var t=this.getView();t.toggleShowMoreMessageButton(!0);var a=t.isFollowedTabSelected();t.toggleLoaderForMessageSearch(),a?this.bindFollowedMessageSearchScroll():this.bindUnfollowedMessageSearchScroll();this.loadNextMessageSearch().then((function(){t.toggleTitleHeaderArrow(!0),t.toggleMessageHeaderArrow(!1),t.toggleTitleSearchBody(!0)}),(function(){t.toggleShowMoreMessageButton(),t.toggleLoaderForMessageSearch(!0)}))},ThreadSearchController.prototype.onTitleHeaderClick=function(e){e.stopPropagation();var t=this.getView(),a=t.isTitleSearchExpanded();t.toggleTitleSearchBody(a,!0),t.toggleTitleHeaderArrow(!!a)},ThreadSearchController.prototype.onMessageHeaderClick=function(e){e.stopPropagation();var t=this.getView(),a=t.isMessageSearchExpanded();t.toggleMessageSearchBody(a),t.toggleMessageHeaderArrow(!!a)},ThreadSearchController.prototype.fetchFollowedThreadsAndUpdateUI=function(){var e=this.getModel(),t=this.getView();return this.hasNoFollowedThreads?(t.showFollowedEmpty(),Promise.resolve()):""!=e.getSearchValue()&&Config.isAccordionEnabledInThreadSearch()?this.fetchThreadsAndMessagesAndRenderAsAccordion():e.fetchNextFollowedThreads().then(this.onFetchFollowedThreadsSuccess.bind(this),this.onFetchFollowedThreadsFailure.bind(this))},ThreadSearchController.prototype.onFetchFollowedThreadsSuccess=function(e){if(e.beforeFetchId==e.afterFetchId){var t=e.serverResponse,a=this.getModel(),r=this.getView();r.removeFollowedListLoader(),r.removeBottomLoader(),r.focusSearchInput(),this.handleUnreadCount(),t.data.length?(r.appendFollowedList(r.getListItems(t.data)),a.isPreviousPageNoOne()&&r.selectFirstFollowedThread()):a.isFirstPage()&&(a.hasSearchValue()?r.showFollowedSearchEmpty():(r.isClosedThreadsEnabled()&&(this.hasNoFollowedThreads=!0),r.showFollowedEmpty()))}},ThreadSearchController.prototype.onFetchFollowedThreadsFailure=function(){var e=this.getModel(),t=this.getView();this.unbindFollowedListScroll(),t.removeFollowedListLoader(),t.removeBottomLoader(),setTimeout(this.bindFollowedListScroll.bind(this),500),e.isFirstPage()&&t.showFollowedFailure()},ThreadSearchController.prototype.onFetchUnfollowedThreadsSuccess=function(e){if(e.beforeFetchId==e.afterFetchId){var t=e.serverResponse,a=this.getModel(),r=this.getView();r.removeUnfollowedListLoader(),r.removeBottomLoader(),r.focusSearchInput(),this.handleUnreadCount(),t.data.length?(r.appendUnfollowedList(r.getListItems(t.data)),a.isPreviousPageNoOne()&&r.selectFirstUnfollowedThread()):a.isFirstPage()&&(a.hasSearchValue()?r.showUnfollowedSearchEmpty():(r.isClosedThreadsEnabled()&&(this.hasNoUnfollowedThreads=!0),r.showUnfollowedEmpty()))}},ThreadSearchController.prototype.onFetchUnfollowedThreadsFailure=function(){var e=this.getModel(),t=this.getView();this.unbindUnfollowedListScroll(),t.removeUnfollowedListLoader(),t.removeBottomLoader(),setTimeout(this.bindUnfollowedListScroll.bind(this),500),e.isFirstPage()&&t.showUnfollowedFailure()},ThreadSearchController.prototype.fetchUnfollowedThreadsAndUpdateUI=function(){var e=this.getModel(),t=this.getView();return this.hasNoUnfollowedThreads?(t.showUnfollowedEmpty(),Promise.resolve()):""!=e.getSearchValue()&&Config.isAccordionEnabledInThreadSearch()?this.fetchThreadsAndMessagesAndRenderAsAccordion():e.fetchNextUnfollowedThreads().then(this.onFetchUnfollowedThreadsSuccess.bind(this),this.onFetchUnfollowedThreadsFailure.bind(this))},ThreadSearchController.prototype.onAutoFollowCheckBoxToggle=function(e){var t=this.getView(),a=this.getModel();t.toggleLoaderInAutoFollowSwitch(!0);var r=Channels.getChannelId(this.getThreadParentChatId());Channels.isAutoFollowThreadsEnabled(r)?a.makeServerCallToDisableAutoFollowThreads().then(this.onAutoFollowSuccess.bind(this),this.onAutoFollowFailure.bind(this)):a.makeServerCallToEnableAutoFollowThreads().then(this.onAutoFollowSuccess.bind(this),this.onAutoFollowFailure.bind(this))},ThreadSearchController.prototype.onIncludeClosedThreadsCheckBoxToggle=function(){var e=this.getView();e.disableClosedThreadsContainer(),Settings.updateIncludeClosedThreads(e.isClosedThreadsEnabled());var t=function(){e.enableClosedThreadsContainer()};this.search().then(t,t)},ThreadSearchController.prototype.onAutoFollowSuccess=function(e){this.getView().toggleLoaderInAutoFollowSwitch(!1);var t=Channels.getChannelId(this.getThreadParentChatId());Channels.updateAutoFollowThreadsInChannelObj(t,"enabled"==e.data.status),this.updateAutoFollowSwitch(),this.showAutoFollowSuccessBanner(e.data.status)},ThreadSearchController.prototype.onAutoFollowFailure=function(){this.getView().toggleLoaderInAutoFollowSwitch(!1),this.updateAutoFollowSwitch()},ThreadSearchController.prototype.showAutoFollowSuccessBanner=function(e){var t=ConversationsList.getTitle(this.getThreadParentChatId());"enabled"==e?UI.updateBanner(I18N("threadchat.autofollow.enable",[t]),3e3):UI.updateBanner(I18N("threadchat.autofollow.disable",[t]),3e3)},ThreadSearchController.prototype.updateAutoFollowSwitch=function(){var e=this.getView(),t=Channels.getChannelId(this.getThreadParentChatId());e.setAutoFollowSwitch(Channels.isAutoFollowThreadsEnabled(t))},ThreadSearchController.prototype.handleUnreadCount=function(){var e=this.getModel(),t=ThreadChatUtils.getTotalUnreadThreadChatIdByParentChid(this.getThreadParentChatId(),!0);0!=t&&(e.hasSearchValue()?this.getView().hideFollowedTabUnreadCount():e.isPreviousPageNoOne()&&this.getView().showFollowedTabUnreadCount(t))},ThreadSearchController.prototype.scrollToMsg=function(e){Chat.jumpToConversation(this.getThreadParentChatId(),!1,e)},ThreadSearchController.prototype.onListItemClick=function(e){var t=e.currentTarget;this.openThreadChat(null,t)},ThreadSearchController.prototype.openThreadChat=function(e,t){e&&e.stopPropagation();var a=null==e,r=this.getView().getThreadChatData(t||e.target),o=r.threadchid,s=r.msgtime,n=r.msgsender,i=r.parentmsguid,d=s&&n;this.params.beforeOpeningThreadChatFromList&&this.params.beforeOpeningThreadChatFromList(i),d?Chat.jumpToConversation(o,!0,void 0,s,n,void 0,{parentChatId:this.getThreadParentChatId(),parentMsgUid:i,canOpenInsideParentChat:a}):a?ThreadChatUtils.openThreadChatInsideParentChatWindow(this.getThreadParentChatId(),i,o):Chat.attachSession(o),this.params.onOpeningThreadChatFromList&&this.params.onOpeningThreadChatFromList()},ThreadSearchController.prototype.clearSearch=function(){var e=this.getView();e.clearSearchInput(),e.focusSearchInput(),this.onSearchKeyUp()},ThreadSearchController.prototype.onSearchKeyUp=function(){var e=this.getView(),t=this.getModel();e.getSearchValue()!=t.getSearchValue()&&this.search()},ThreadSearchController.prototype.search=function(){var e=this.getView(),t=this.getModel();return t.reset(),t.setSearchValue(e.getSearchValue()),this.clearAccordionView(),e.isFollowedTabSelected()?(e.showFollowedListLoader(),this.fetchFollowedThreadsAndUpdateUI()):(e.showUnfollowedListLoader(),this.fetchUnfollowedThreadsAndUpdateUI())},ThreadSearchController.prototype.onSearchKeyDown=function(e){var t=e.which;t===$zcg.TAB_KEYCODE&&(this.getView().clickNextTab(),e.preventDefault()),t!=$zcg.UP_KEYCODE&&t!=$zcg.DOWN_KEYCODE||this.handleListNavigation(e),t==$zcg.ENTER_KEYCODE&&this.handleEnterKeyOnSearchInput()},ThreadSearchController.prototype.isValidScroll=function(e,t){t=t||{};var a,r=this.getModel();return a=t.isTitleSearchScroll?r.getThreadsList().hasNextTitleSearch():t.isMessageSearchScroll?r.getThreadsList().hasNextMessageSearch():r.hasNextThreads(),ZCScroll.isScrollNearBottom(e)&&a&&!r.isAlreadyFetching()},ThreadSearchController.prototype.onFollowedListScroll=function(e){this.isValidScroll(e.target)&&(this.getView().showBottomLoader(),this.fetchFollowedThreadsAndUpdateUI())},ThreadSearchController.prototype.onUnfollowedListScroll=function(e){this.isValidScroll(e.target)&&(this.getView().toggleLoaderForTitleSearch(),this.fetchUnfollowedThreadsAndUpdateUI())},ThreadSearchController.prototype.onTitleSearchScroll=function(e){this.isValidScroll(e.target,{isTitleSearchScroll:!0})&&(this.getView().toggleLoaderForTitleSearch(),this.loadNextTitleSearch())},ThreadSearchController.prototype.onMessageSearchScroll=function(e){this.isValidScroll(e.target,{isMessageSearchScroll:!0})&&(this.getView().toggleLoaderForMessageSearch(),this.loadNextMessageSearch())},ThreadSearchController.prototype.handleListNavigation=function(e){var t=this.getView(),a=t.getDOMStrings().thread_list_item;t.isFollowedTabSelected()&&t.hasFollowedList()?DropdownUtil.handleListNavigation(e,t.$getFollowedContainerForNavigation(),a):t.isUnfollowedTabSelected()&&t.hasUnfollowedList()&&DropdownUtil.handleListNavigation(e,t.$getUnfollowedContainerForNavigation(),a)},ThreadSearchController.prototype.handleEnterKeyOnSearchInput=function(){var e,t=this.getView();t.isFollowedTabSelected()?(e=t.getSelectedFollowedThread())&&this.openThreadChat(null,e):t.isUnfollowedTabSelected()&&(e=t.getSelectedUnfollowedThread())&&this.openThreadChat(null,e)},ThreadSearchController.prototype.getContainer=function(){return this.getView().$el},ThreadSearchController.prototype.destroyView=function(){var e=this.getView();e.$el.off(),e.destroy()},ThreadSearchController.prototype.getThreadParentChatId=function(){return this.threadParentChatId},ThreadSearchController.prototype.getView=function(){return this.threadSearchView},ThreadSearchController.prototype.getModel=function(){return this.threadSearchModel};var CwinThreadController=function(e){this.cwin=e,this.threadNotifyBanner=null,this.threadSearchPopUpController=null};CwinThreadController.prototype.getCwin=function(){return this.cwin},CwinThreadController.prototype.getChid=function(){return this.getCwin().getChid()},CwinThreadController.prototype.getStorage=function(){return this.getCwin().getStorage()},CwinThreadController.prototype.createThreadCardUI=function(e){ThreadCard.createInCwin(this.getCwin(),e)},CwinThreadController.prototype.removeThreadCardUI=function(e){ThreadCard.removeFromCwin(this.getCwin(),e)},CwinThreadController.prototype.goToNextUnreadThread=function(){null!=this.threadNotifyBanner&&this.threadNotifyBanner.goToNextUnreadThread()},CwinThreadController.prototype.addChidInThreadNotification=function(e){null==this.threadNotifyBanner&&this.initAndShowThreadNotificationBanner(),this.threadNotifyBanner.addUnreadChatAndUpdateUI(e)},CwinThreadController.prototype.removeChidFromThreadNotification=function(e){null!=this.threadNotifyBanner&&this.threadNotifyBanner.removeUnreadChatAndUpdateUI(e)},CwinThreadController.prototype.onNotificationBannerUpdate=function(e){null!=this.threadNotifyBanner&&e.id==this.threadNotifyBanner.getId()&&(0==e.unreadThreadChatCount?this.threadNotifyBanner.hide():this.threadNotifyBanner.show().enableBanner())},CwinThreadController.prototype.handleReconnection=function(){this.reRenderUnreadThreadBanner()},CwinThreadController.prototype.clearNotificationBanner=function(){null!=this.threadNotifyBanner&&(this.threadNotifyBanner.$el.remove(),this.threadNotifyBanner=null)},CwinThreadController.prototype.reRenderUnreadThreadBanner=function(){this.clearNotificationBanner(),this.initAndShowThreadNotificationBanner()},CwinThreadController.prototype.scrollToLastUnreadThreadIfParentChatHasNoUnread=function(){var e=this.getChid(),t=ConversationsList.getUnreadThreadmsgsCount(e);0!=t&&(ConversationsList.getUnreadCount(e)==t&&setTimeout(()=>this.goToNextUnreadThread(),500))},CwinThreadController.prototype.handleVisibleThreadCards=function(e){var t=ThreadCard.getVisibleDomHandlersArray(e);this.executeAfterNMilliSecondsRecursive(t,300,0)},CwinThreadController.prototype.handleBeforeRemovingUnreadChats=function(){var e=this.getCwin().getStorage().getThreadCards().getAllThreadCardsUIInstances();Object.keys(e).forEach((function(t){e[t].handleBeforeRemovingUnreadCountOnReconnection()})),this.clearNotificationBanner()},CwinThreadController.prototype.isMsgExistsInParentChatButNotAsThreadCard=function(e){return e&&!e.isThreadParentMessage()},CwinThreadController.prototype.handleReconnectionOnThreadCard=function(e){var t=this.getStorage(),a=t.getList().getMessage(e);if(this.isMsgExistsInParentChatButNotAsThreadCard(a))return a.isTempThread&&this.removeThreadCardUI(e),void setTimeout((function(){t.fetchExactMessage(!1,e,void 0,1)}),300);var r=t.getThreadCards().getInstanceByMsgUid(e);r&&(r.getUnreadMsgCountBeforeReconnection()!=r.getUnreadMsgCount()?r.convertToNonReplyMode(!0).fetchUnreadMessages(!0):r.updateUnreadAfter().resetUnreadMsgCountBeforeReconnection())},CwinThreadController.prototype.executeAfterNMilliSecondsRecursive=function(e,t,a){a!=e.length&&(e[a](),this.visibleThreadCardTimerId=setTimeout(this.executeAfterNMilliSecondsRecursive.bind(this,e,t,a+1),t||300))},CwinThreadController.prototype.popOutNestedCwinIfExists=function(e){var t=void 0!==e?e:NestedChatUI.getChidByParentChid(this.getChid());if(t){var a=ChatUI.getWin(t);a&&a.popOut()}},CwinThreadController.prototype.closeNestedCwinIfExists=function(e){var t=void 0!==e?e:NestedChatUI.isExist("",!0)?NestedChatUI.getChidByParentChid(this.getChid()):"";if(t){var a=ChatUI.getWin(t);a&&a.closeWindow()}},CwinThreadController.prototype.handleCwinClose=function(){clearTimeout(this.visibleThreadCardTimerId),this.closeNestedCwinIfExists(),this.handleThreadSearchPopUpClose(),Config.isClientMemoryOptimizationEnabled()&&PubSub.unSubscribe(ThreadChatUtils.constants.BANNER_UPDATE,this.subscribeId)},CwinThreadController.prototype.handleCwinClosed=function(){var e=NestedChatUI.isExist()?NestedChatUI.getChidByParentChid(this.getChid()):null;e&&!ChatUI.getWin(e)&&NestedChatUI.destroySkeletonLoading(e),this.closeNestedCwinIfExists(e||"")},CwinThreadController.prototype.handleScrollBottom=function(){null!=this.threadNotifyBanner&&ConversationsList.hasUnReadThreadChats(this.getChid())&&(this.threadNotifyBanner.$el.is(":visible")||this.reRenderUnreadThreadBanner())},CwinThreadController.prototype.openThreadSearchPopUp=function(e){if(!this.handleIfAlreadyThreadSearchPopUpOpened(e)){var t={onOpeningThreadChatFromList:this.handleThreadSearchPopUpClose.bind(this),beforeOpeningThreadChatFromList:this.beforeOpeningThreadChatFromList.bind(this)};this.getCwin().win().find("#thread-search-icon"+this.getChid()).addClass("selected"),this.threadSearchPopUpController=new ThreadSearchController(this.getChid(),t);var a=ThreadChatUtils.$getAllThreadsPopUpContainer(),r=this.threadSearchPopUpController.renderView().getContainer();this.positionAllThreadPopUp(a),a.html(r),this.bindThreadSearchPopupClickOutside()}},CwinThreadController.prototype.onAutoFollowCheckBoxToggle=function(e){this.threadSearchPopUpController&&this.threadSearchPopUpController.onAutoFollowCheckBoxToggle(e)},CwinThreadController.prototype.onIncludeClosedThreadsCheckBoxToggle=function(e){this.threadSearchPopUpController&&this.threadSearchPopUpController.onIncludeClosedThreadsCheckBoxToggle(e)},CwinThreadController.prototype.handleIfAlreadyThreadSearchPopUpOpened=function(e){var t=ThreadChatUtils.$getAllThreadsPopUpContainer().children().first();if(!(t.length>0))return!1;var a=t.attr("chatId");if(a==this.getChid())return Clickoutside.handleClickOnChild(e),!0;var r=ChatUI.getWin(a);return r&&r.getCwinThreadController().handleThreadSearchPopUpClose(),!1},CwinThreadController.prototype.beforeOpeningThreadChatFromList=function(e){var t=this.getStorage().getThreadCards().getInstanceByMsgUid(e);t&&t.handleBeforeOpeningThreadChatAsSeparateChat()},CwinThreadController.prototype.positionAllThreadPopUp=function(e){var t=this.getCwin().win().find("#thread-search-icon"+this.getChid());t.parent().is(":visible")||(t=this.getCwin().win().find("#chatHeaderDropdown"));var a=t.offset(),r=t[0].offsetParent.offsetWidth-t[0].offsetLeft-15;a.top+=t.height()+7,a.left=a.left-e.width()+r,e.css(a)},CwinThreadController.prototype.bindThreadSearchPopupClickOutside=function(){var e={srcid:"thread-search-icon"+this.getChid(),destid:"thread-search-popup-container",doNotClose:function(e,t,a){return a&&null!=a.target.closest("#"+this.destid)},customHide:this.handleThreadSearchPopUpClose.bind(this)};Clickoutside.bind(e)},CwinThreadController.prototype.hideThreadSearchPopUpContainer=function(){ThreadChatUtils.$getAllThreadsPopUpContainer().hide()},CwinThreadController.prototype.handleThreadSearchPopUpClose=function(){null!=this.threadSearchPopUpController&&(Clickoutside.clear("thread-search-popup-container"),this.hideThreadSearchPopUpContainer(),this.getCwin().win().find("#thread-search-icon"+this.getChid()).removeClass("selected"),this.threadSearchPopUpController.destroyView(),this.threadSearchPopUpController=null)},CwinThreadController.prototype.initAndShowThreadNotificationBanner=function(){if(Config.isThreadFeatureEnabled()&&null==this.threadNotifyBanner){this.threadNotifyBanner=new ThreadNotificationUI(this.getChid());var e=window.getEventId();Config.isClientMemoryOptimizationEnabled()&&(this.subscribeId=e),PubSub.subscribe(ThreadChatUtils.constants.BANNER_UPDATE,e,this.onNotificationBannerUpdate.bind(this)),this.getCwin().win().find("#notify-banner-container").html(this.threadNotifyBanner.render().$el),this.threadNotifyBanner.updateUnreadChatInUI()}};var $DummyThreadCwin=function(e,t,a,r,o){this.parentChatId=t,this.parentMsgUid=a,this.parentMsgSenderId=r,$DummyCwin.call(this,e,o)};$DummyThreadCwin.prototype=Object.create($DummyCwin.prototype),$DummyThreadCwin.prototype.constructor=$DummyThreadCwin,$DummyThreadCwin.prototype.super=$DummyCwin.prototype,$DummyThreadCwin.prototype.initInstanceProps=function(){this.super.initInstanceProps.apply(this,arguments),this.atMentionChatId=this.getParentChatId()},$DummyThreadCwin.prototype.setDetachedChat=function(){this.additionalInfo.isDetachedCwin&&(this.isDetachedCwin=!0)},$DummyThreadCwin.prototype.initDomCache=function(){this.super.initDomCache.call(this);var e={chatImage:"#userimage",closeButton:"#cclose",openAsNewChat:"#opennew",parentTitle:"#parent-title"+this.chid,parentTitleContainer:"#parent-title-container",postInParent:"#post-in-parent"};$.extend(this.DOM_CACHE,e)},$DummyThreadCwin.prototype.getParentChatId=function(){return this.parentChatId},$DummyThreadCwin.prototype.getParentMsgUid=function(){return this.parentMsgUid},$DummyThreadCwin.prototype.updateChatImage=function(){var e=$WC.template.replace(ThreadChatTemplates.chat_img_html,{uid:this.parentMsgSenderId,src:Users.getImgUrlById(this.parentMsgSenderId)});this.$(this.DOM_CACHE.chatImage).html(e)},$DummyThreadCwin.prototype.updateChatTitle=function(){this.super.updateChatTitle.call(this),this.updateParentTitle()},$DummyThreadCwin.prototype.updateParentTitle=function(){var e=ConversationsList.getTitle(this.parentChatId)||this.additionalInfo&&this.additionalInfo.title;this.$(this.DOM_CACHE.parentTitle).text(e).attr("title",e),this.$(this.DOM_CACHE.parentTitleContainer).removeClass("curP")},$DummyThreadCwin.prototype.updateChatParticipants=function(e){this.$(this.DOM_CACHE.participant).html(e||ThreadChatUtils.getTotalFollowersText(0))},$DummyThreadCwin.prototype.canPostInParent=function(){return this.$(this.DOM_CACHE.postInParent).is(":checked")},$DummyThreadCwin.prototype.getAdditionalData=function(){var e={post_in_parent:this.canPostInParent()};return this.getServerChatId()||(e.thread_message_id=this.parentMsgUid),e},$DummyThreadCwin.prototype.getSendMessageChatId=function(){return this.getServerChatId()||this.getParentChatId()},$DummyThreadCwin.prototype.onSendMessageSuccess=function(e){if(e&&!this.getServerChatId()){e=Array.isArray(e)?e[0].objString:e;this.handleAfterGettingChidFromServer(e.threadchatid)}},$DummyThreadCwin.prototype.getOptionsForAttachments=function(){return{fileShareFromThreadCard:!0,isDummyThreadChat:!0,permission:ChatUI.getPermissions(""+$zcg.CT_NFY_ZOHOGROUP),parentChatId:this.getParentChatId(),parentMsgUid:this.getParentMsgUid(),replyToMsgUid:"",dummyChatId:this.getDummyChatId(),isFirstThreadMsg:null==this.getServerChatId(),threadChatId:this.getServerChatId(),postInParent:this.canPostInParent(),chatTitle:this.getTitle(),additionalSearchCriteria:{}}},$DummyThreadCwin.prototype.initialFetch=function(){this.isInitialFetchDone||(this.addHeadMessageInStorage(),this.isInitialFetchDone=!0)},$DummyThreadCwin.prototype.addHeadMessageInStorage=function(){var e=this;this.getHeadMessageFromClientOrServer().then((function(t){e.getStorage().addNewMessage(t)}))},$DummyThreadCwin.prototype.toggleChatAdditionalOptionsFromHeader=function(e){this.$(this.DOM_CACHE.chatAddOptions).children().not(this.DOM_CACHE.closeButton+","+this.DOM_CACHE.openAsNewChat).toggleClass("dN",e)},$DummyThreadCwin.prototype.getHeadMessageFromClientOrServer=function(){var e=this.getHeadMessageFromClient();return e?Promise.resolve(e):this.getHeadMessageFromServer().then(e=>e)},$DummyThreadCwin.prototype.getHeadMessageFromServer=function(){var e=new MessageStorage(this.getParentChatId()),t=this;return e.getExactMessageByMsguid(this.getParentMsgUid(),1).then((function(a){var r=a.message.getObject();return t.addAdditionalPropsForHeadMessage(r),e.destroy(),MessageFactory(r,t.getParentChatId(),void 0,!0)}))},$DummyThreadCwin.prototype.addAdditionalPropsForHeadMessage=function(e){e.head_message=!0,e.isDummyHeadMessage=!0,e.thread_information={chat_id:this.getDummyChatId()}},$DummyThreadCwin.prototype.getHeadMessageFromClient=function(){var e=StorageManager.getMsgObjFromAnyStorageByChatIdAndMsguid(this.getParentChatId(),this.getParentMsgUid());if(e)return e=e.getObject(),this.addAdditionalPropsForHeadMessage(e),MessageFactory(e,this.getParentChatId(),void 0,!0)},$DummyThreadCwin.prototype.threadChatWindowActions={closeThreadChatWindow:function(){this.closeWindow($zcg._MOUSECLICKEVENT)},goToHeadMessage:function(){Chat.jumpToConversation(this.getParentChatId(),!1,this.getParentMsgUid())}};